<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ğŸ“ŠCrowdLog Analytics</title>
    <style>
      /* ========================================
           CSS Variables & Reset
        ======================================== */
      :root {
        --bg-primary: #f7f9f8;
        --bg-secondary: #ffffff;
        --bg-tertiary: #eef2f0;
        --text-primary: #2f3e35;
        --text-secondary: #5c6b62;
        --accent-blue: #5c9476;
        --accent-orange: #d97706;
        --accent-green: #5c9476;
        --accent-purple: #4a7a62;
        --border-color: #d1dbd6;
        --shadow: 0 4px 20px rgba(92, 148, 118, 0.1);
        --gradient-blue: linear-gradient(135deg, #5c9476 0%, #4a7a62 100%);
        --gradient-orange: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+JP:wght@400;500;700&display=swap");

      body {
        font-family: "Inter", "Noto Sans JP", sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        min-height: 100vh;
        line-height: 1.4;
        font-size: 14px;
      }

      /* Header Customization */
      .app-logo {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .app-icon {
        width: 40px;
        height: 40px;
        background: var(--gradient-blue);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        box-shadow: 0 4px 10px rgba(92, 148, 118, 0.3);
      }

      .app-title-group {
        display: flex;
        flex-direction: column;
        line-height: 1.2;
      }

      .app-title-main {
        font-family: "Inter", sans-serif;
        font-size: 1.6rem;
        font-weight: 800;
        color: var(--text-primary);
        letter-spacing: -0.02em;
      }

      .app-title-sub {
        font-size: 0.8rem;
        color: var(--text-secondary);
        font-weight: 500;
      }

      /* ========================================
           Layout
        ======================================== */
      /* ========================================
           Layout & Header
        ======================================== */
      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 10px 15px;
      }

      .header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        gap: 20px;
        background: var(--bg-secondary);
        padding: 10px 20px;
        border-radius: 10px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
      }

      .header-content h1 {
        font-size: 1.4rem;
        background: var(--gradient-blue);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 2px;
      }

      .header-content p {
        color: var(--text-secondary);
        font-size: 0.8rem;
        margin: 0;
      }

      /* ========================================
           Drop Zone
        ======================================== */
      .drop-zone {
        border: 2px dashed var(--border-color);
        border-radius: 8px;
        padding: 8px 20px;
        text-align: center;
        background: var(--bg-primary);
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 0;
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 300px;
        justify-content: center;
      }

      .drop-zone:hover,
      .drop-zone.dragover {
        border-color: var(--accent-blue);
        background: var(--bg-tertiary);
        transform: translateY(-1px);
        box-shadow: var(--shadow);
      }

      .drop-zone-icon {
        font-size: 1.2rem;
        margin-bottom: 0;
      }

      .drop-zone-text {
        font-size: 0.9rem;
        color: var(--text-secondary);
      }

      .drop-zone-text strong {
        color: var(--accent-blue);
      }

      .drop-zone input[type="file"] {
        display: none;
      }

      .file-info {
        margin-top: 8px;
        padding: 5px 12px;
        background: var(--bg-tertiary);
        border-radius: 6px;
        display: inline-block;
        color: var(--accent-green);
        font-size: 0.85rem;
      }

      /* ========================================
           Control Panel
        ======================================== */
      .control-panel {
        background: var(--bg-secondary);
        border-radius: 10px;
        padding: 12px 15px;
        margin-bottom: 10px;
        box-shadow: var(--shadow);
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
      }

      .control-section {
        margin-bottom: 0;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .control-section:last-child {
        margin-bottom: 0;
      }

      .control-label {
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        white-space: nowrap;
      }

      .radio-group,
      .checkbox-group {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
      }

      .radio-item,
      .checkbox-item {
        display: flex;
        align-items: center;
        padding: 5px 10px;
        background: var(--bg-tertiary);
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid transparent;
        font-size: 0.8rem;
      }

      .radio-item:hover,
      .checkbox-item:hover {
        border-color: var(--accent-blue);
      }

      .radio-item input,
      .checkbox-item input {
        margin-right: 5px;
        accent-color: var(--accent-blue);
        width: 14px;
        height: 14px;
      }

      .radio-item.active {
        background: var(--accent-blue);
        color: white;
      }

      /* ========================================
           Filter Section
        ======================================== */
      /* Icon Buttons */
      .btn-icon-tiny {
        background: transparent;
        border: none;
        cursor: pointer;
        font-size: 1.1rem;
        padding: 0 4px;
        color: var(--text-secondary);
        transition: color 0.2s, transform 0.2s;
        line-height: 1;
      }

      .btn-icon-tiny:hover {
        color: var(--accent-blue);
        transform: scale(1.1);
      }

      .btn-icon {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 5px;
        font-size: 1.2rem;
        cursor: pointer;
        transition: all 0.2s;
        color: var(--text-primary);
      }

      .btn-icon:hover:not(:disabled) {
        background: var(--bg-tertiary);
        border-color: var(--accent-blue);
        transform: translateY(-1px);
      }

      .btn-icon:disabled {
        opacity: 0.4;
        cursor: not-allowed;
        background: var(--bg-secondary);
      }

      .btn-icon.danger:hover:not(:disabled) {
        background: #fff0f0;
        border-color: #ffcccc;
        color: #d32f2f;
      }

      /* ç¸¦ä¸¦ã³ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ */
      .vertical-radio-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .vertical-radio-group .radio-item {
        justify-content: flex-start;
        padding: 8px 12px;
        width: 100%;
        box-sizing: border-box;
      }

      /* ãŠæ°—ã«å…¥ã‚Šã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
      .favorites-section {
        background: var(--bg-tertiary);
        border-radius: 10px;
        padding: 10px 15px;
        margin-bottom: 15px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
      }

      .filter-section {
        background: var(--bg-secondary);
        border-radius: 10px;
        padding: 10px 12px;
        margin-bottom: 10px;
        box-shadow: var(--shadow);
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
      }

      .filter-group {
        margin-bottom: 0;
      }

      .filter-group:last-child {
        margin-bottom: 0;
      }

      @media (max-width: 900px) {
        .filter-section {
          grid-template-columns: 1fr;
        }
      }

      .filter-title {
        font-weight: 600;
        margin-bottom: 5px;
        color: var(--accent-purple);
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.8rem;
      }

      .filter-items {
        display: flex;
        flex-direction: column;
        gap: 3px;
        max-height: 240px;
        overflow-y: auto;
      }

      .filter-chip {
        padding: 3px 8px;
        background: var(--bg-tertiary);
        border-radius: 12px;
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid transparent;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .filter-chip:hover {
        border-color: var(--accent-purple);
      }

      .filter-chip.active {
        background: var(--accent-purple);
        color: white;
      }

      .filter-chip input {
        display: none;
      }

      .filter-search {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background: var(--bg-primary);
        color: var(--text-primary);
        font-size: 0.85rem;
        margin-bottom: 5px;
        box-sizing: border-box;
      }

      .filter-search:focus {
        outline: none;
        border-color: var(--accent-blue);
      }

      .filter-actions {
        display: flex;
        gap: 5px;
        margin-bottom: 8px;
        align-items: center;
      }

      .filter-sort-select {
        padding: 2px 5px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 0.75rem;
        background: var(--bg-primary);
        color: var(--text-secondary);
        cursor: pointer;
        flex-grow: 1;
        height: 24px;
      }

      .filter-search::placeholder {
        color: var(--text-secondary);
      }

      .filter-actions {
        display: flex;
        gap: 8px;
        margin-bottom: 10px;
      }

      .btn-small {
        padding: 4px 12px;
        font-size: 0.75rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        background: var(--accent-purple);
        color: white;
        transition: all 0.2s ease;
      }

      .btn-small:hover {
        opacity: 0.85;
        transform: translateY(-1px);
      }

      .btn-small.btn-outline {
        background: transparent;
        border: 1px solid var(--accent-purple);
        color: var(--accent-purple);
      }

      .btn-small.btn-outline:hover {
        background: var(--accent-purple);
        color: white;
      }

      .period-selector {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
      }

      .period-selector select {
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background: var(--bg-tertiary);
        color: var(--text-primary);
        font-size: 0.9rem;
        cursor: pointer;
        min-width: 120px;
      }

      .period-selector select:focus {
        outline: none;
        border-color: var(--accent-blue);
      }

      .period-separator {
        color: var(--text-secondary);
        font-weight: 500;
      }

      /* ========================================
           Chart Section
        ======================================== */
      .chart-section {
        background: var(--bg-secondary);
        border-radius: 10px;
        padding: 10px 15px;
        margin-bottom: 10px;
        box-shadow: var(--shadow);
      }

      .chart-container {
        position: relative;
        width: 100%;
        min-height: 280px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      #chart {
        max-width: 100%;
        border-radius: 6px;
      }

      .chart-placeholder {
        text-align: center;
        color: var(--text-secondary);
      }

      .chart-placeholder-icon {
        font-size: 2.5rem;
        margin-bottom: 10px;
        opacity: 0.5;
      }

      /* ========================================
           Legend
        ======================================== */
      /* ========================================
           Chart Footer (Legend & Controls)
        ======================================== */
      .chart-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid var(--border-color);
      }

      .legend {
        display: flex;
        gap: 20px;
      }

      .chart-controls {
        display: flex;
        gap: 20px;
        align-items: center;
      }

      .chart-control-group {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .chart-control-label {
        font-size: 0.8rem;
        color: var(--text-secondary);
        font-weight: 600;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.8rem;
      }

      .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 4px;
      }

      .legend-color.planned {
        background: var(--gradient-orange);
      }

      .legend-color.actual {
        background: var(--gradient-blue);
      }

      /* ========================================
           Data Table
        ======================================== */
      .table-container {
        margin-top: 20px;
        overflow-x: auto;
        border: 1px solid var(--border-color);
        border-radius: 8px;
      }

      .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
      }

      .data-table th,
      .data-table td {
        padding: 10px 15px;
        text-align: right;
        border-bottom: 1px solid var(--border-color);
      }

      .data-table th {
        background: var(--bg-tertiary);
        color: var(--text-primary);
        font-weight: 600;
        text-align: right;
        /* centerã‹ã‚‰å¤‰æ›´ */
        white-space: nowrap;
        cursor: pointer;
        /* ã“ã“ã§æŒ‡å®š */
      }

      .data-table th.align-left,
      .data-table td.align-left {
        text-align: left;
      }

      .sort-icon {
        display: inline-block;
        margin-left: 5px;
        width: 1.5em;
        text-align: center;
        opacity: 0.3;
      }

      .sort-icon.active {
        opacity: 1;
        color: var(--primary-color);
      }

      .data-table tr:last-child td {
        border-bottom: none;
      }

      .data-table tr:hover {
        background: var(--bg-primary);
      }

      /* ========================================
           Data Management
        ======================================== */
      .data-management {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .btn-primary {
        background: var(--gradient-blue);
        color: white;
      }

      .btn-danger {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
      }

      .btn-secondary {
        background: var(--bg-tertiary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
      }

      .btn:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow);
      }

      /* ========================================
           Summary Cards
        ======================================== */
      .summary-cards {
        display: flex;
        gap: 15px;
        margin-bottom: 10px;
        align-items: stretch;
      }

      .summary-card {
        background: var(--bg-secondary);
        border-radius: 8px;
        padding: 8px 15px;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: var(--shadow);
      }

      .summary-card-value {
        font-size: 1.2rem;
        font-weight: 700;
        margin-bottom: 0;
      }

      .summary-card-value.planned {
        color: var(--accent-blue);
      }

      .summary-card-value.actual {
        color: var(--accent-orange);
      }

      .summary-card-value.diff-positive {
        color: var(--accent-green);
      }

      .summary-card-value.diff-negative {
        color: #ef4444;
      }

      .summary-card-label {
        color: var(--text-secondary);
        font-size: 0.7rem;
        white-space: nowrap;
      }

      /* ========================================
           Responsive
        ======================================== */
      @media (max-width: 768px) {
        .container {
          padding: 15px;
        }

        header h1 {
          font-size: 1.5rem;
        }

        .drop-zone {
          padding: 30px 20px;
        }

        .control-panel,
        .filter-section,
        .chart-section {
          padding: 20px;
        }

        .radio-group,
        .checkbox-group {
          flex-direction: column;
        }

        .chart-container {
          min-height: 300px;
        }

        .summary-cards {
          grid-template-columns: 1fr 1fr;
        }

        .legend {
          flex-direction: column;
          align-items: center;
          gap: 10px;
        }
      }

      /* ========================================
           Animations
        ======================================== */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .fade-in {
        animation: fadeIn 0.3s ease forwards;
      }

      /* ========================================
           Toast Notification
        ======================================== */
      .toast {
        position: fixed;
        bottom: 30px;
        right: 30px;
        padding: 15px 25px;
        background: var(--accent-green);
        color: white;
        border-radius: 8px;
        box-shadow: var(--shadow);
        transform: translateY(100px);
        opacity: 0;
        transition: all 0.3s ease;
        z-index: 1000;
      }

      .toast.show {
        transform: translateY(0);
        opacity: 1;
      }

      .toast.error {
        background: #ef4444;
      }

      /* ========================================
           Hidden
        ======================================== */
      .hidden {
        display: none !important;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <!-- Header & Drop Zone -->
      <div class="header-row">
        <div class="header-content">
          <div class="app-logo">
            <div class="app-icon">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <line x1="18" y1="20" x2="18" y2="10"></line>
                <line x1="12" y1="20" x2="12" y2="4"></line>
                <line x1="6" y1="20" x2="6" y2="14"></line>
              </svg>
            </div>
            <div class="app-title-group">
              <div class="app-title-main">CrowdLog Analytics</div>
              <div class="app-title-sub">æ¥­å‹™æ™‚é–“äºˆå®Ÿåˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</div>
            </div>
          </div>
        </div>

        <div style="display: flex; gap: 15px; align-items: stretch">
          <div
            class="drop-zone"
            id="dropZone"
            role="button"
            tabindex="0"
            aria-label="CSVã‚’ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—ã€ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠ"
          >
            <div class="drop-zone-icon">ğŸ“</div>
            <div class="drop-zone-text">CSVã‚’ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—</div>
            <input type="file" id="fileInput" accept=".csv" />
            <div class="file-info hidden" id="fileInfo"></div>
          </div>
          <div
            style="
              display: flex;
              flex-direction: column;
              gap: 5px;
              justify-content: center;
            "
          >
            <button
              class="btn btn-secondary btn-small"
              id="btnReload"
              onclick="location.reload()"
              style="white-space: nowrap"
            >
              ğŸ”„ å†èª­è¾¼
            </button>
            <button
              class="btn btn-danger btn-small hidden"
              id="btnClear"
              onclick="clearData()"
              style="white-space: nowrap"
            >
              ğŸ—‘ï¸ ã‚¯ãƒªã‚¢
            </button>
          </div>
        </div>
      </div>

      <!-- Control Panel REMOVED -->

      <!-- Filter Section -->
      <div class="filter-section hidden" id="filterSection">
        <div class="filter-group" id="mainControls">
          <!-- Period Selector -->
          <div
            style="
              margin-bottom: 24px;
              border-bottom: 1px solid var(--border);
              padding-bottom: 16px;
            "
          >
            <div class="filter-title">ğŸ“… é›†è¨ˆæœŸé–“</div>
            <div
              class="period-selector"
              style="
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 0.85rem;
              "
            >
              <select
                id="periodStart"
                onchange="updatePeriodFilter()"
                class="filter-search"
                style="
                  margin-bottom: 0;
                  padding: 4px 8px;
                  width: 100px;
                  font-size: 0.85rem;
                "
              >
                <option value="">é–‹å§‹æœˆ</option>
              </select>
              <span style="color: var(--text-sub)">ã€œ</span>
              <select
                id="periodEnd"
                onchange="updatePeriodFilter()"
                class="filter-search"
                style="
                  margin-bottom: 0;
                  padding: 4px 8px;
                  width: 100px;
                  font-size: 0.85rem;
                "
              >
                <option value="">çµ‚äº†æœˆ</option>
              </select>
              <button
                class="btn-small btn-outline"
                onclick="resetPeriod()"
                style="padding: 4px 8px"
                title="å…¨æœŸé–“ã«ãƒªã‚»ãƒƒãƒˆ"
              >
                â†º
              </button>
            </div>
          </div>

          <div class="filter-title">ğŸ“ˆ åˆ†æã‚¿ã‚¤ãƒ—</div>
          <div
            class="radio-group vertical-radio-group"
            id="analysisType"
            role="radiogroup"
          >
            <label class="radio-item active">
              <input type="radio" name="analysisType" value="overall" checked />
              å…¨ä½“
            </label>
            <label class="radio-item">
              <input type="radio" name="analysisType" value="project" />
              ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆ¥
            </label>
            <label class="radio-item">
              <input type="radio" name="analysisType" value="department" />
              éƒ¨ç½²åˆ¥
            </label>
            <label class="radio-item">
              <input type="radio" name="analysisType" value="employee" />
              å¾“æ¥­å“¡åˆ¥
            </label>
            <label class="radio-item">
              <input type="radio" name="analysisType" value="monthly" />
              æœˆåˆ¥æ¨ç§»
            </label>
          </div>
        </div>

        <div class="filter-group" id="projectFilters">
          <div class="filter-title">ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</div>
          <input
            type="text"
            class="filter-search"
            id="projectSearch"
            placeholder="ğŸ” æ¤œç´¢..."
          />
          <div class="filter-actions">
            <button class="btn-small" onclick="selectAll('projects')">
              å…¨é¸æŠ
            </button>
            <button
              class="btn-small btn-outline"
              onclick="deselectAll('projects')"
            >
              å…¨è§£é™¤
            </button>
            <select
              class="filter-sort-select"
              onchange="updateFilterSort('projects', this.value)"
            >
              <option value="name_asc">æ˜‡é †</option>
              <option value="name_desc">é™é †</option>
              <option value="selected">é¸æŠé †</option>
            </select>
          </div>
          <div class="filter-items" id="projectFilterItems"></div>
        </div>
        <div class="filter-group" id="departmentFilters">
          <div class="filter-title">ğŸ¢ éƒ¨ç½²</div>
          <input
            type="text"
            class="filter-search"
            id="departmentSearch"
            placeholder="ğŸ” æ¤œç´¢..."
          />
          <div class="filter-actions">
            <button class="btn-small" onclick="selectAll('departments')">
              å…¨é¸æŠ
            </button>
            <button
              class="btn-small btn-outline"
              onclick="deselectAll('departments')"
            >
              å…¨è§£é™¤
            </button>
            <select
              class="filter-sort-select"
              onchange="updateFilterSort('departments', this.value)"
            >
              <option value="name_asc">æ˜‡é †</option>
              <option value="name_desc">é™é †</option>
              <option value="selected">é¸æŠé †</option>
            </select>
          </div>
          <div class="filter-items" id="departmentFilterItems"></div>
        </div>
        <div class="filter-group" id="employeeFilters">
          <div class="filter-title">ğŸ‘¤ å¾“æ¥­å“¡</div>
          <input
            type="text"
            class="filter-search"
            id="employeeSearch"
            placeholder="ğŸ” æ¤œç´¢..."
          />
          <div class="filter-actions">
            <button class="btn-small" onclick="selectAll('employees')">
              å…¨é¸æŠ
            </button>
            <button
              class="btn-small btn-outline"
              onclick="deselectAll('employees')"
            >
              å…¨è§£é™¤
            </button>
            <select
              class="filter-sort-select"
              onchange="updateFilterSort('employees', this.value)"
            >
              <option value="name_asc">æ˜‡é †</option>
              <option value="name_desc">é™é †</option>
              <option value="selected">é¸æŠé †</option>
            </select>
          </div>
          <div class="filter-items" id="employeeFilterItems"></div>
        </div>
      </div>

      <!-- Favorites Section -->
      <div class="favorites-section hidden" id="favoritesSection">
        <div
          style="
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: space-between;
          "
        >
          <div style="display: flex; align-items: center; gap: 10px">
            <div style="font-weight: 600; color: var(--accent-purple)">
              â˜… ãŠæ°—ã«å…¥ã‚Š
            </div>
          </div>

          <div style="display: flex; align-items: center; gap: 10px; flex: 1">
            <select
              id="savedFiltersSelect"
              class="filter-search"
              style="margin-bottom: 0; width: auto; flex: 1"
              onchange="applySavedFilter(this.value)"
            >
              <option value="">(æ¡ä»¶ã‚’é¸æŠ)</option>
            </select>
            <button
              class="btn-icon-tiny"
              id="btnSaveFilter"
              onclick="saveCurrentFilter()"
              title="ç¾åœ¨ã®æ¡ä»¶ã‚’æ–°è¦ä¿å­˜"
              style="font-size: 1.5rem"
            >
              â•
            </button>
          </div>

          <div style="display: flex; gap: 8px">
            <button
              class="btn-icon"
              id="btnOverwriteFilter"
              onclick="overwriteCurrentFilter()"
              title="ä¸Šæ›¸ãä¿å­˜"
              disabled
            >
              ğŸ’¾
            </button>
            <button
              class="btn-icon"
              id="btnCopyFilter"
              onclick="copyCurrentFilter()"
              title="è¤‡è£½ã—ã¦ä¿å­˜"
              disabled
            >
              ğŸ“‘
            </button>
            <button
              class="btn-icon"
              id="btnRenameFilter"
              onclick="renameCurrentFilter()"
              title="åå‰ã‚’å¤‰æ›´"
              disabled
            >
              âœï¸
            </button>
            <button
              class="btn-icon danger"
              id="btnDeleteFilter"
              onclick="deleteCurrentFilter()"
              title="å‰Šé™¤"
              disabled
            >
              ğŸ—‘ï¸
            </button>
          </div>
        </div>
      </div>

      <!-- Summary Cards -->
      <div class="summary-cards hidden" id="summaryCards">
        <div class="summary-card">
          <div class="summary-card-value planned" id="totalPlanned">0</div>
          <div class="summary-card-label">äºˆå®šæ™‚é–“ï¼ˆåˆè¨ˆï¼‰</div>
        </div>
        <div class="summary-card">
          <div class="summary-card-value actual" id="totalActual">0</div>
          <div class="summary-card-label">å®Ÿç¸¾æ™‚é–“ï¼ˆåˆè¨ˆï¼‰</div>
        </div>
        <div class="summary-card">
          <div class="summary-card-value" id="totalDiff">0</div>
          <div class="summary-card-label">å·®ç•°ï¼ˆå®Ÿç¸¾ - äºˆå®šï¼‰</div>
        </div>
        <div class="summary-card">
          <div class="summary-card-value" id="totalRate">0%</div>
          <div class="summary-card-label">åˆ°é”ç‡</div>
        </div>
      </div>

      <!-- Chart Section -->
      <div class="chart-section hidden" id="chartSection">
        <div class="chart-container">
          <canvas id="chart" width="1100" height="350"></canvas>
        </div>
        <div class="chart-footer">
          <div class="legend">
            <div class="legend-item">
              <div class="legend-color planned"></div>
              <span>äºˆå®šæ™‚é–“</span>
            </div>
            <div class="legend-item">
              <div class="legend-color actual"></div>
              <span>å®Ÿç¸¾æ™‚é–“</span>
            </div>
          </div>

          <div class="chart-controls">
            <div class="chart-control-group">
              <span class="chart-control-label">ã‚°ãƒ©ãƒ•:</span>
              <div class="radio-group" id="chartType" role="radiogroup">
                <label class="radio-item active">
                  <input type="radio" name="chartType" value="bar" checked />
                  æ£’
                </label>
                <label class="radio-item">
                  <input type="radio" name="chartType" value="line" />
                  ç·š
                </label>
              </div>
            </div>
            <div class="chart-control-group">
              <span class="chart-control-label">å˜ä½:</span>
              <div class="radio-group" id="unitType" role="radiogroup">
                <label class="radio-item">
                  <input type="radio" name="unitType" value="hours" />
                  æ™‚é–“(h)
                </label>
                <label class="radio-item active">
                  <input type="radio" name="unitType" value="days" checked />
                  äººæ—¥
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Data Table -->
        <div class="table-container" id="dataTableContainer">
          <table class="data-table" id="dataTable">
            <thead>
              <tr>
                <th class="align-left" data-key="label">é …ç›®</th>
                <th data-key="planned">äºˆå®š</th>
                <th data-key="actual">å®Ÿç¸¾</th>
                <th data-key="diff">å·®ç•°</th>
                <th data-key="rate">é”æˆç‡</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast" aria-live="polite" role="status"></div>

    <script>
      (function () {
        // ========================================
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        // ========================================
        let appData = {
          records: [],
          months: [],
          departments: [],
          projects: [],
          employees: [],
          savedFilters: [],
        };

        let filters = {
          projects: [],
          departments: [],
          employees: [],
          periodStart: "",
          periodEnd: "",
        };

        let isManHour = true; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆäººæ—¥

        let filterSorts = {
          projects: "name_asc",
          departments: "name_asc",
          employees: "name_asc",
        };

        function updateFilterSort(type, value) {
          filterSorts[type] = value;
          updateFiltersUI();
        }

        function getSortedItems(type) {
          let items = [...appData[type]]; // ã‚½ãƒ¼ã‚¹é…åˆ—ã‚’ã‚³ãƒ”ãƒ¼
          const sortType = filterSorts[type];

          if (sortType === "selected") {
            items.sort((a, b) => {
              const aSelected = filters[type].includes(a);
              const bSelected = filters[type].includes(b);
              if (aSelected && !bSelected) return -1;
              if (!aSelected && bSelected) return 1;
              return a.localeCompare(b, "ja");
            });
          } else if (sortType === "name_desc") {
            items.sort((a, b) => b.localeCompare(a, "ja"));
          } else {
            items.sort((a, b) => a.localeCompare(b, "ja"));
          }
          return items;
        }

        const STORAGE_KEY = "crowdlog_data";

        // ========================================
        // åˆæœŸåŒ–
        // ========================================
        document.addEventListener("DOMContentLoaded", () => {
          initDropZone();
          initControlListeners();
          loadFromStorage();
        });

        // ========================================
        // ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³
        // ========================================
        function initDropZone() {
          const dropZone = document.getElementById("dropZone");
          const fileInput = document.getElementById("fileInput");

          // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œã¨ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å¯¾å¿œ
          if (!dropZone.hasAttribute("tabindex"))
            dropZone.setAttribute("tabindex", "0");
          if (!dropZone.hasAttribute("role"))
            dropZone.setAttribute("role", "button");

          dropZone.addEventListener("click", () => fileInput.click());
          dropZone.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              fileInput.click();
            }
          });

          dropZone.addEventListener("dragover", (e) => {
            e.preventDefault();
            dropZone.classList.add("dragover");
          });

          dropZone.addEventListener("dragleave", () => {
            dropZone.classList.remove("dragover");
          });

          dropZone.addEventListener("drop", (e) => {
            e.preventDefault();
            dropZone.classList.remove("dragover");
            const file = e.dataTransfer.files[0];
            if (file) processFile(file);
          });

          fileInput.addEventListener("change", (e) => {
            const file = e.target.files[0];
            if (file) processFile(file);
          });
        }

        function initControlListeners() {}

        // ========================================
        // ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
        // ========================================
        function processFile(file) {
          if (!file.name.endsWith(".csv")) {
            showToast("CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„", true);
            return;
          }

          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const text = e.target.result;
              parseCSV(text);
              saveToStorage();
              showUI();
              updateChart();
              showToast("ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ âœ“");

              // ãƒ•ã‚¡ã‚¤ãƒ«åè¡¨ç¤º
              const fileInfo = document.getElementById("fileInfo");
              fileInfo.textContent = `ğŸ“„ ${file.name}`;
              fileInfo.classList.remove("hidden");
            } catch (error) {
              console.error(error);
              showToast("ãƒ•ã‚¡ã‚¤ãƒ«ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message, true);
            }
          };
          reader.readAsText(file, "UTF-8");
        }

        // ========================================
        // CSVãƒ‘ãƒ¼ã‚¹
        // ========================================
        // CSVãƒ‘ãƒ¼ã‚¹ï¼ˆå¼•ç”¨ç¬¦å†…ã®ã‚«ãƒ³ãƒãƒ»æ”¹è¡Œã€äºŒé‡å¼•ç”¨ç¬¦ "" ã‚’è€ƒæ…®ã—ãŸå …ç‰¢ç‰ˆï¼‰
        function parseCSV(text) {
          const rows = parseCSVRows(text).filter((r) =>
            r.some((c) => c.trim() !== "")
          );
          if (rows.length < 2) {
            throw new Error("ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™");
          }

          const headers = rows[0].map((h) => (h || "").trim());
          console.log("Headers:", headers);

          // åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ç‰¹å®šï¼ˆè¤‡æ•°ã®å€™è£œåã«å¯¾å¿œï¼‰
          const colIndex = {
            employee: findColumnIndex(headers, [
              "ç¤¾å“¡å",
              "æ‹…å½“è€…å",
              "å¾“æ¥­å“¡å",
              "ãƒ¡ãƒ³ãƒãƒ¼å",
            ]),
            project: findColumnIndex(headers, [
              "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå",
              "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ",
              "PJå",
            ]),
            department: findColumnIndex(headers, [
              "éƒ¨ç½²å",
              "ãƒ¡ãƒ³ãƒãƒ¼éƒ¨ç½²",
              "éƒ¨ç½²",
              "æ‰€å±",
            ]),
            type: findColumnIndex(headers, [
              "ãƒ¡ãƒ³ãƒãƒ¼ç¨®é¡",
              "äºˆå®Ÿãƒ•ãƒ©ã‚°",
              "äºˆå®Ÿ",
              "ç¨®é¡",
              "åŒºåˆ†",
            ]),
            unit: findColumnIndex(headers, ["å·¥æ•°å˜ä½", "å˜ä½", "unit"]),
            total: findColumnIndex(headers, ["åˆè¨ˆ", "è¨ˆ", "Total"]),
          };

          console.log("Column indices:", colIndex);

          // æœˆåˆ—ã‚’ç‰¹å®šï¼ˆæ—¥ä»˜å½¢å¼ã®ãƒ˜ãƒƒãƒ€ãƒ¼ï¼‰
          const monthColumns = [];
          headers.forEach((header, index) => {
            // YYYY/M/D ã¾ãŸã¯ YYYY/MM/DD å½¢å¼
            if (/^\d{4}\/\d{1,2}\/\d{1,2}$/.test(header.trim())) {
              monthColumns.push({ index, header: header.trim() });
            }
          });

          console.log("Month columns:", monthColumns);

          // æœˆæ¬¡åˆ—ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€åˆè¨ˆåˆ—ã‚’ä»£æ›¿ã¨ã—ã¦ä½¿ã†ï¼ˆå­˜åœ¨ã™ã‚Œã°ï¼‰
          if (monthColumns.length === 0) {
            if (colIndex.total >= 0) {
              monthColumns.push({
                index: colIndex.total,
                header: headers[colIndex.total].trim(),
              });
            } else {
              throw new Error(
                "æœˆæ¬¡ãƒ‡ãƒ¼ã‚¿åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆæ—¥ä»˜å½¢å¼: YYYY/M/Dï¼‰ã€‚åˆè¨ˆåˆ—ã‚‚è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚"
              );
            }
          }

          // æœˆãƒªã‚¹ãƒˆä½œæˆï¼ˆé‡è¤‡é™¤å»ã€YYYY/MMå½¢å¼ã«å¤‰æ›ï¼‰
          const monthSet = new Set();
          monthColumns.forEach((col) => {
            const parts = col.header.split("/");
            const monthKey = `${parts[0]}/${parts[1].padStart(2, "0")}`;
            monthSet.add(monthKey);
          });
          appData.months = Array.from(monthSet).sort();

          // ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‘ãƒ¼ã‚¹
          appData.records = [];
          const departmentSet = new Set();
          const projectSet = new Set();
          const employeeSet = new Set();
          for (let i = 1; i < rows.length; i++) {
            const values = rows[i];
            if (!values || values.length < 1) continue;

            // å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å–å¾—ï¼ˆ-1ã®å ´åˆã¯ç©ºæ–‡å­—ï¼‰
            let employee =
              colIndex.employee >= 0
                ? (values[colIndex.employee] || "").trim()
                : "";
            let project =
              colIndex.project >= 0
                ? (values[colIndex.project] || "").trim()
                : "";
            let department =
              colIndex.department >= 0
                ? (values[colIndex.department] || "").trim()
                : "";
            let type =
              colIndex.type >= 0 ? (values[colIndex.type] || "").trim() : "";

            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‹ã‚‰ã‚³ãƒ¼ãƒ‰éƒ¨åˆ†ã‚’é™¤å»
            // ä¾‹: "103005-9 åŒå¹´äº‹æ¥­" â†’ "åŒå¹´äº‹æ¥­"ã€"P001 é¡§å®¢ç®¡ç†" â†’ "é¡§å®¢ç®¡ç†"
            project = removeCodePrefix(project);

            // éƒ¨ç½²åã‹ã‚‰ã‚³ãƒ¼ãƒ‰éƒ¨åˆ†ã‚’é™¤å»
            // ä¾‹: "100001 ãƒ†ã‚¹ãƒˆéƒ¨" â†’ "ãƒ†ã‚¹ãƒˆéƒ¨"
            department = removeCodePrefix(department);

            // äºˆå®Ÿã‚¿ã‚¤ãƒ—ã‚’æ­£è¦åŒ–ï¼ˆäºˆç®—â†’äºˆã€å®Ÿç¸¾â†’å®Ÿï¼‰
            let normalizedType = "";
            if (
              type.includes("äºˆç®—") ||
              type === "äºˆ" ||
              type.includes("è¨ˆç”»") ||
              type.includes("Plan")
            ) {
              normalizedType = "äºˆ";
            } else if (
              type.includes("å®Ÿç¸¾") ||
              type === "å®Ÿ" ||
              type.includes("Actual")
            ) {
              normalizedType = "å®Ÿ";
            }

            // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ï¼ˆå¾“æ¥­å“¡ã¨äºˆå®Ÿã‚¿ã‚¤ãƒ—ã¯å¿…é ˆï¼‰
            if (!employee || !normalizedType) {
              console.log(
                `Skipping row ${i}: employee="${employee}", type="${type}"`
              );
              continue;
            }

            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨éƒ¨ç½²ãŒç©ºã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
            if (!project) project = "(æœªè¨­å®š)";
            if (!department) department = "(æœªè¨­å®š)";

            departmentSet.add(department);
            projectSet.add(project);
            employeeSet.add(employee);

            // æœˆæ¬¡ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
            const monthlyData = {};
            // è¡Œã”ã¨ã®å˜ä½åˆ¤å®š
            // - CSVå†…ã®å˜ä½ãŒã€Œäººæ—¥ã€ã®å ´åˆã¯æ™‚é–“ã«æ›ç®—ï¼ˆ* HOURS_PER_DAYï¼‰ã—ã¦å†…éƒ¨ã¯æ™‚é–“ã§ä¿æŒ
            // - CSVå†…ã®å˜ä½ãŒã€Œäººæ™‚ã€ã€Œæ™‚é–“ã€ã€Œhã€ç­‰ã®å ´åˆã¯ãã®ã¾ã¾æ™‚é–“ã¨ã—ã¦æ‰±ã†
            let multiplier = 1;
            if (colIndex.unit >= 0) {
              const unitVal = (values[colIndex.unit] || "").trim();
              if (/(äººæ—¥|æ—¥|\bdays?\b|\bd\b)/i.test(unitVal)) {
                multiplier = HOURS_PER_DAY;
              } else if (/(äººæ™‚|æ™‚é–“|h|hours?|hr\b)/i.test(unitVal)) {
                multiplier = 1;
              } else {
                // ä¸æ˜ãªå˜ä½ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æ™‚é–“æ‰±ã„ï¼ˆå®‰å…¨å´ï¼‰
                multiplier = 1;
              }
            }

            monthColumns.forEach((col) => {
              // ãƒ˜ãƒƒãƒ€ãƒ¼ãŒæ—¥ä»˜å½¢å¼ãªã‚‰ YYYY/MM ã«æ•´å½¢ã™ã‚‹ã€‚åˆè¨ˆåˆ—ç­‰ã¯ãã®ã¾ã¾ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä½¿ã†ã€‚
              const parts = col.header.split("/");
              const monthKey =
                parts.length >= 2
                  ? `${parts[0]}/${parts[1].padStart(2, "0")}`
                  : col.header.trim();
              const raw = parseFloat(values[col.index]);
              const value = (isNaN(raw) ? 0 : raw) * multiplier;
              if (!monthlyData[monthKey]) {
                monthlyData[monthKey] = 0;
              }
              monthlyData[monthKey] += value;
            });

            appData.records.push({
              department,
              project,
              employee,
              type: normalizedType,
              monthlyData,
            });
          }

          appData.departments = Array.from(departmentSet).sort();
          appData.projects = Array.from(projectSet).sort();
          appData.employees = Array.from(employeeSet).sort();

          console.log("Parsed records:", appData.records.length);
          console.log("Departments:", appData.departments);
          console.log("Projects:", appData.projects);
          console.log("Employees:", appData.employees);

          // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼åˆæœŸåŒ–ï¼ˆå…¨ã¦è§£é™¤ï¼‰
          filters.projects = [];
          filters.departments = [];
          filters.employees = [];

          if (appData.records.length === 0) {
            throw new Error(
              "æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚åˆ—åã‚’ç¢ºèªã—ã¦ãã ã•ã„: ç¤¾å“¡å/æ‹…å½“è€…åã€ãƒ¡ãƒ³ãƒãƒ¼ç¨®é¡/äºˆå®Ÿãƒ•ãƒ©ã‚°ï¼ˆäºˆç®—/å®Ÿç¸¾ or äºˆ/å®Ÿï¼‰"
            );
          }
        }

        // CSVã®å…¨ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰è¡Œå˜ä½ã®é…åˆ—ï¼ˆé…åˆ—ã®é…åˆ—ï¼‰ã‚’è¿”ã™
        function parseCSVRows(text) {
          const rows = [];
          let cur = [];
          let field = "";
          let inQuotes = false;

          for (let i = 0; i < text.length; i++) {
            const char = text[i];
            const next = text[i + 1];

            if (char === '"') {
              if (inQuotes && next === '"') {
                // ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚ŒãŸãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆ
                field += '"';
                i++; // 1æ–‡å­—é€²ã‚ã‚‹
              } else {
                inQuotes = !inQuotes;
              }
            } else if (char === "," && !inQuotes) {
              cur.push(field);
              field = "";
            } else if ((char === "\n" || char === "\r") && !inQuotes) {
              // æ”¹è¡Œå‡¦ç†ï¼ˆCRLFå¯¾å¿œï¼‰
              if (char === "\r" && next === "\n") {
                // consume CRLF as single newline
                // advance i to skip \n in next loop
                // but outer loop will increment i, so increment once here
                i++;
              }
              cur.push(field);
              rows.push(cur);
              cur = [];
              field = "";
            } else {
              field += char;
            }
          }

          // æ®‹ã‚Šã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰/è¡Œã‚’ç¢ºå®š
          if (inQuotes) {
            // çµ‚ç«¯ã§å¼•ç”¨ç¬¦ãŒé–‰ã˜ã‚‰ã‚Œã¦ã„ãªã„å ´åˆã¯è¨±å®¹ã—ã¦å‡¦ç†ã‚’ç¶šã‘ã‚‹
            inQuotes = false;
          }
          if (field !== "" || cur.length > 0) {
            cur.push(field);
            rows.push(cur);
          }
          return rows;
        }

        // ã‚³ãƒ¼ãƒ‰ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’é™¤å»ã™ã‚‹é–¢æ•°
        // ä¾‹: "103005-9 åŒå¹´äº‹æ¥­" â†’ "åŒå¹´äº‹æ¥­"
        // ä¾‹: "100001 ãƒ†ã‚¹ãƒˆéƒ¨" â†’ "ãƒ†ã‚¹ãƒˆéƒ¨"
        // ä¾‹: "P001 é¡§å®¢ç®¡ç†" â†’ "é¡§å®¢ç®¡ç†"
        function removeCodePrefix(text) {
          if (!text) return text;

          // ãƒ‘ã‚¿ãƒ¼ãƒ³: ã€Œæ•°å­—ã‚„ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã€ãƒã‚¤ãƒ•ãƒ³ã§æ§‹æˆã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ‰ + ã‚¹ãƒšãƒ¼ã‚¹ + æ—¥æœ¬èªåã€
          // ä¾‹: "103005-9 åŒå¹´äº‹æ¥­", "100001 ãƒ†ã‚¹ãƒˆéƒ¨", "P001 ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå"
          const match = text.match(/^[A-Za-z0-9\-_]+\s+(.+)$/);
          if (match) {
            return match[1].trim();
          }
          return text;
        }

        function findColumnIndex(
          headers,
          possibleNames,
          excludePatterns = ["ã‚³ãƒ¼ãƒ‰", "code", "Code", "ID"]
        ) {
          // ã¾ãšã€é™¤å¤–ãƒ‘ã‚¿ãƒ¼ãƒ³ã«è©²å½“ã—ãªã„åˆ—ã§æ¤œç´¢
          for (let i = 0; i < headers.length; i++) {
            const header = headers[i].trim();
            // é™¤å¤–ãƒ‘ã‚¿ãƒ¼ãƒ³ã«è©²å½“ã™ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
            if (excludePatterns.some((pattern) => header.includes(pattern))) {
              continue;
            }
            if (possibleNames.some((name) => header.includes(name))) {
              return i;
            }
          }

          // è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯é™¤å¤–ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç„¡è¦–ã—ã¦å†æ¤œç´¢
          for (let i = 0; i < headers.length; i++) {
            const header = headers[i].trim();
            if (possibleNames.some((name) => header.includes(name))) {
              return i;
            }
          }
          return -1;
        }

        // ========================================
        // ========================================
        // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿
        // ========================================

        // ========================================
        // UIè¡¨ç¤º
        // ========================================
        function showUI() {
          document.getElementById("summaryCards").classList.remove("hidden");
          document.getElementById("filterSection").classList.remove("hidden");
          document
            .getElementById("favoritesSection")
            .classList.remove("hidden");
          document.getElementById("chartSection").classList.remove("hidden");
          document.getElementById("btnClear").classList.remove("hidden");

          loadSavedFilters();
          updateFiltersUI();
          updatePeriodSelector();
          updateSummary();
        }

        function updatePeriodFilter() {
          filters.periodStart = document.getElementById("periodStart").value;
          filters.periodEnd = document.getElementById("periodEnd").value;
          updateChart();
          updateSummary();
        }

        function resetPeriod() {
          filters.periodStart = "";
          filters.periodEnd = "";
          document.getElementById("periodStart").value = "";
          document.getElementById("periodEnd").value = "";
          updateChart();
          updateSummary();
        }

        function updateFiltersUI() {
          // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆå®‰å…¨ã«DOMã§æ§‹ç¯‰ï¼‰
          const projectItems = document.getElementById("projectFilterItems");
          projectItems.innerHTML = "";
          getSortedItems("projects").forEach((p) => {
            const label = document.createElement("label");
            label.className =
              "filter-chip" + (filters.projects.includes(p) ? " active" : "");
            label.setAttribute("data-value", p);

            const input = document.createElement("input");
            input.type = "checkbox";
            input.value = p;
            if (filters.projects.includes(p)) input.checked = true;
            input.addEventListener("change", () => toggleFilter("projects", p));

            label.appendChild(input);
            label.appendChild(document.createTextNode(p));
            projectItems.appendChild(label);
          });

          // éƒ¨ç½²ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆå®‰å…¨ã«DOMã§æ§‹ç¯‰ï¼‰
          const departmentItems = document.getElementById(
            "departmentFilterItems"
          );
          departmentItems.innerHTML = "";
          getSortedItems("departments").forEach((d) => {
            const label = document.createElement("label");
            label.className =
              "filter-chip" +
              (filters.departments.includes(d) ? " active" : "");
            label.setAttribute("data-value", d);

            const input = document.createElement("input");
            input.type = "checkbox";
            input.value = d;
            if (filters.departments.includes(d)) input.checked = true;
            input.addEventListener("change", () =>
              toggleFilter("departments", d)
            );

            label.appendChild(input);
            label.appendChild(document.createTextNode(d));
            departmentItems.appendChild(label);
          });

          // å¾“æ¥­å“¡ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆå®‰å…¨ã«DOMã§æ§‹ç¯‰ï¼‰
          const employeeItems = document.getElementById("employeeFilterItems");
          employeeItems.innerHTML = "";
          getSortedItems("employees").forEach((e) => {
            const label = document.createElement("label");
            label.className =
              "filter-chip" + (filters.employees.includes(e) ? " active" : "");
            label.setAttribute("data-value", e);

            const input = document.createElement("input");
            input.type = "checkbox";
            input.value = e;
            if (filters.employees.includes(e)) input.checked = true;
            input.addEventListener("change", () =>
              toggleFilter("employees", e)
            );

            label.appendChild(input);
            label.appendChild(document.createTextNode(e));
            employeeItems.appendChild(label);
          });

          // æ¤œç´¢çŠ¶æ…‹ã‚’å¾©å…ƒ
          const projectSearch = document.getElementById("projectSearch").value;
          if (projectSearch) filterItems("projects", projectSearch);

          const departmentSearch =
            document.getElementById("departmentSearch").value;
          if (departmentSearch) filterItems("departments", departmentSearch);

          const employeeSearch =
            document.getElementById("employeeSearch").value;
          if (employeeSearch) filterItems("employees", employeeSearch);
        }

        function filterItems(type, searchText) {
          const containerId =
            type === "projects"
              ? "projectFilterItems"
              : type === "departments"
              ? "departmentFilterItems"
              : "employeeFilterItems";
          const container = document.getElementById(containerId);
          const chips = container.querySelectorAll(".filter-chip");
          const lowerSearch = searchText.toLowerCase();

          chips.forEach((chip) => {
            const value = chip.getAttribute("data-value").toLowerCase();
            if (value.includes(lowerSearch)) {
              chip.style.display = "flex";
            } else {
              chip.style.display = "none";
            }
          });
        }

        function escapeHtml(text) {
          return text.replace(/'/g, "\\'").replace(/"/g, '\\"');
        }

        function toggleFilter(type, value) {
          const index = filters[type].indexOf(value);
          if (index > -1) {
            filters[type].splice(index, 1);
          } else {
            filters[type].push(value);

            // éƒ¨ç½²é¸æŠæ™‚ã«ã€ãã®éƒ¨ç½²ã®å¾“æ¥­å“¡ã‚’è‡ªå‹•é¸æŠ
            if (type === "departments") {
              const departmentEmployees = appData.records
                .filter((r) => r.department === value)
                .map((r) => r.employee);
              const uniqueEmployees = [...new Set(departmentEmployees)];

              uniqueEmployees.forEach((emp) => {
                if (!filters.employees.includes(emp)) {
                  filters.employees.push(emp);
                }
              });
            }
          }
          updateFiltersUI();
          updateChart();
          updateSummary();
        }

        function selectAll(type) {
          filters[type] = [...appData[type]];
          updateFiltersUI();
          updateChart();
          updateSummary();
        }

        function deselectAll(type) {
          filters[type] = [];
          updateFiltersUI();
          updateChart();
          updateSummary();
        }

        // ========================================
        // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒªã‚¹ãƒŠãƒ¼
        // ========================================
        function initControlListeners() {
          // åˆ†æã‚¿ã‚¤ãƒ—
          document
            .querySelectorAll('input[name="analysisType"]')
            .forEach((radio) => {
              radio.addEventListener("change", () => {
                updateRadioStyles("analysisType");
                updateChart();
              });
            });

          // ã‚°ãƒ©ãƒ•ç¨®é¡
          document
            .querySelectorAll('input[name="chartType"]')
            .forEach((radio) => {
              radio.addEventListener("change", () => {
                updateRadioStyles("chartType");
                updateChart();
              });
            });

          // å˜ä½ã‚¿ã‚¤ãƒ—
          document
            .querySelectorAll('input[name="unitType"]')
            .forEach((radio) => {
              radio.addEventListener("change", () => {
                updateRadioStyles("unitType");
                updateChart();
                updateSummary();
              });
            });

          // æ¤œç´¢å…¥åŠ›ã®ãƒ‡ãƒã‚¦ãƒ³ã‚¹å‡¦ç†ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šï¼‰
          const debounce = (fn, wait) => {
            let t;
            return function (...args) {
              clearTimeout(t);
              t = setTimeout(() => fn.apply(this, args), wait);
            };
          };

          const projectSearch = document.getElementById("projectSearch");
          if (projectSearch)
            projectSearch.addEventListener(
              "input",
              debounce((e) => filterItems("projects", e.target.value), 250)
            );

          const departmentSearch = document.getElementById("departmentSearch");
          if (departmentSearch)
            departmentSearch.addEventListener(
              "input",
              debounce((e) => filterItems("departments", e.target.value), 250)
            );

          const employeeSearch = document.getElementById("employeeSearch");
          if (employeeSearch)
            employeeSearch.addEventListener(
              "input",
              debounce((e) => filterItems("employees", e.target.value), 250)
            );
        }

        function updateRadioStyles(groupId) {
          const container = document.getElementById(groupId);
          container.querySelectorAll(".radio-item").forEach((item) => {
            const input = item.querySelector("input");
            item.classList.toggle("active", input.checked);
          });
        }

        // ========================================
        // ã‚µãƒãƒªãƒ¼æ›´æ–°
        // ========================================
        function updateSummary() {
          const filteredRecords = getFilteredRecords();

          let totalPlanned = 0;
          let totalActual = 0;

          filteredRecords.forEach((record) => {
            const total = sumMonthlyData(record.monthlyData);
            if (record.type === "äºˆ") {
              totalPlanned += total;
            } else if (record.type === "å®Ÿ") {
              totalActual += total;
            }
          });

          const diff = totalActual - totalPlanned;
          const rate =
            totalPlanned > 0 ? (totalActual / totalPlanned) * 100 : 0;

          const unit = getUnitLabel();
          const displayPlanned = convertToDisplayUnit(totalPlanned);
          const displayActual = convertToDisplayUnit(totalActual);
          const displayDiff = convertToDisplayUnit(diff);

          document.getElementById("totalPlanned").textContent =
            displayPlanned.toFixed(1) + unit;
          document.getElementById("totalActual").textContent =
            displayActual.toFixed(1) + unit;

          const diffEl = document.getElementById("totalDiff");
          diffEl.textContent =
            (displayDiff >= 0 ? "+" : "") + displayDiff.toFixed(1) + unit;
          diffEl.className =
            "summary-card-value " +
            (diff >= 0 ? "diff-positive" : "diff-negative");

          const rateEl = document.getElementById("totalRate");
          rateEl.textContent = rate.toFixed(1) + "%";
          rateEl.className =
            "summary-card-value " +
            (rate >= 100 ? "diff-positive" : "diff-negative");
        }

        // ========================================
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¸ˆã¿ãƒ¬ã‚³ãƒ¼ãƒ‰å–å¾—
        // ========================================
        function getFilteredRecords() {
          // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠãŒç©ºã®å ´åˆã¯å…¨é¸æŠæ‰±ã„ï¼ˆå…¨ä»¶è¡¨ç¤ºï¼‰
          const projectSelected =
            filters.projects && filters.projects.length > 0;

          return appData.records.filter((record) => {
            const passProject =
              !projectSelected || filters.projects.includes(record.project);

            const deptSelected = filters.departments.length > 0;
            const empSelected = filters.employees.length > 0;

            // æŒ¯ã‚‹èˆã„:
            // - ã©ã¡ã‚‰ã‚‚æœªé¸æŠ => ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ï¼ˆtrueï¼‰
            // - ç‰‡æ–¹ã ã‘é¸æŠ => ãã®é¸æŠã§ãƒ•ã‚£ãƒ«ã‚¿
            // - ä¸¡æ–¹é¸æŠ => å¾“æ¥­å“¡é¸æŠã§çµã‚Šè¾¼ã‚€ï¼ˆéƒ¨ç½²ã¨å¾“æ¥­å“¡ã®ANDï¼‰
            let passDeptEmp = true;
            if (deptSelected && empSelected) {
              passDeptEmp =
                filters.departments.includes(record.department) &&
                filters.employees.includes(record.employee);
            } else if (deptSelected) {
              passDeptEmp = filters.departments.includes(record.department);
            } else if (empSelected) {
              passDeptEmp = filters.employees.includes(record.employee);
            }

            return passProject && passDeptEmp;
          });
        }

        // ========================================
        // æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼åˆ¶å¾¡
        // ========================================
        function updatePeriodSelector() {
          const startSelect = document.getElementById("periodStart");
          const endSelect = document.getElementById("periodEnd");

          if (!startSelect || !endSelect) return;

          // é¸æŠè‚¢ã®ã‚¯ãƒªã‚¢ï¼ˆä¿æŒã—ã¦ã„ã‚‹å€¤ãŒã‚ã‚Œã°è¦šãˆã¦ãŠãï¼‰
          const currentStart = filters.periodStart;
          const currentEnd = filters.periodEnd;

          startSelect.innerHTML = '<option value="">é–‹å§‹æœˆ</option>';
          endSelect.innerHTML = '<option value="">çµ‚äº†æœˆ</option>';

          const months = appData.months;

          months.forEach((month) => {
            const opt1 = document.createElement("option");
            opt1.value = month;
            opt1.textContent = month;
            startSelect.appendChild(opt1);

            const opt2 = document.createElement("option");
            opt2.value = month;
            opt2.textContent = month;
            endSelect.appendChild(opt2);
          });

          // æœªè¨­å®šã®å ´åˆã¯è‡ªå‹•è¨­å®šï¼ˆå…¨æœŸé–“ï¼‰
          if (!filters.periodStart && months.length > 0) {
            filters.periodStart = months[0];
          }
          if (!filters.periodEnd && months.length > 0) {
            filters.periodEnd = months[months.length - 1];
          }

          // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«åæ˜ 
          startSelect.value = filters.periodStart;
          endSelect.value = filters.periodEnd;
        }

        function updatePeriodFilter() {
          const startSelect = document.getElementById("periodStart");
          const endSelect = document.getElementById("periodEnd");

          filters.periodStart = startSelect.value;
          filters.periodEnd = endSelect.value;

          // æœŸé–“å¤‰æ›´æ™‚
          updateChart();
          updateSummary();
        }

        function resetPeriod() {
          const months = appData.months;
          if (months.length > 0) {
            filters.periodStart = months[0];
            filters.periodEnd = months[months.length - 1];
            updatePeriodSelector(); // UIã«åæ˜ 
            updateChart();
            updateSummary();
          }
        }

        // æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨ã—ãŸæœˆãƒªã‚¹ãƒˆã‚’å–å¾—
        function getFilteredMonths() {
          let months = [...appData.months];

          if (filters.periodStart) {
            months = months.filter((m) => m >= filters.periodStart);
          }
          if (filters.periodEnd) {
            months = months.filter((m) => m <= filters.periodEnd);
          }

          return months;
        }

        // ========================================
        // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½
        // ========================================
        let currentChartData = [];
        let tableSort = { key: null, order: "asc" };

        function sortTable(key) {
          if (tableSort.key === key) {
            if (tableSort.order === "asc") {
              tableSort.order = "desc";
            } else if (tableSort.order === "desc") {
              tableSort.key = null; // ã‚½ãƒ¼ãƒˆè§£é™¤
              tableSort.order = "asc";
            }
          } else {
            tableSort.key = key;
            tableSort.order = "asc";
          }

          // ãƒ‡ãƒ¼ã‚¿ã®ã‚½ãƒ¼ãƒˆ
          sortChartData(currentChartData);

          // ã‚°ãƒ©ãƒ•å†æç”»
          const chartType = document.querySelector(
            'input[name="chartType"]:checked'
          ).value;
          if (chartType === "bar") {
            drawBarChart(currentChartData);
          } else {
            drawLineChart(currentChartData);
          }

          // ãƒ†ãƒ¼ãƒ–ãƒ«å†æç”»
          drawTable(currentChartData);
        }

        // ========================================
        // å˜ä½å¤‰æ›ç”¨å®šæ•°ã¨é–¢æ•°
        // ========================================
        const HOURS_PER_DAY = 7.5;

        function getUnitType() {
          const radio = document.querySelector(
            'input[name="unitType"]:checked'
          );
          return radio ? radio.value : "hours";
        }

        function convertToDisplayUnit(hours) {
          if (getUnitType() === "days") {
            return hours / HOURS_PER_DAY;
          }
          return hours;
        }

        function getUnitLabel() {
          return getUnitType() === "days" ? "äººæ—¥" : "h";
        }

        // ã‚­ãƒªã®è‰¯ã„ç›®ç››ã‚Šé–“éš”ã‚’è¨ˆç®—
        function calculateNiceStep(max, targetTicks = 5) {
          if (max <= 0) return 10;

          // å¤§ã¾ã‹ãªã‚¹ãƒ†ãƒƒãƒ—å¹…
          const roughStep = max / targetTicks;

          // æ¡æ•°ã‚’æ±‚ã‚ã‚‹ (ä¾‹: 85 -> 10, 120 -> 100)
          const power = Math.floor(Math.log10(roughStep));
          const magnitude = Math.pow(10, power);

          // æ­£è¦åŒ–ã•ã‚ŒãŸã‚¹ãƒ†ãƒƒãƒ— (ä¾‹: 8.5, 1.2)
          const normalizedStep = roughStep / magnitude;

          let niceStep;
          if (normalizedStep <= 1) {
            niceStep = 1;
          } else if (normalizedStep <= 2) {
            niceStep = 2;
          } else if (normalizedStep <= 5) {
            niceStep = 5;
          } else {
            niceStep = 10;
          }

          return niceStep * magnitude;
        }

        // æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨ã—ã¦æœˆæ¬¡ãƒ‡ãƒ¼ã‚¿ã‚’åˆè¨ˆ
        function sumMonthlyData(monthlyData) {
          const filteredMonths = getFilteredMonths();
          let total = 0;

          filteredMonths.forEach((month) => {
            if (monthlyData[month]) {
              total += monthlyData[month];
            }
          });

          return total;
        }

        // ========================================
        // ã‚°ãƒ©ãƒ•æç”»
        // ========================================
        function updateChart() {
          const analysisType = document.querySelector(
            'input[name="analysisType"]:checked'
          ).value;
          const chartType = document.querySelector(
            'input[name="chartType"]:checked'
          ).value;
          const filteredRecords = getFilteredRecords();

          let chartData;
          switch (analysisType) {
            case "overall":
              chartData = aggregateOverall(filteredRecords);
              break;
            case "project":
              chartData = aggregateByKey(filteredRecords, "project");
              break;
            case "department":
              chartData = aggregateByKey(filteredRecords, "department");
              break;
            case "employee":
              chartData = aggregateByKey(filteredRecords, "employee");
              break;
            case "monthly":
              chartData = aggregateByMonth(filteredRecords);
              break;
          }

          // ã‚½ãƒ¼ãƒˆ
          sortChartData(chartData);

          if (chartType === "bar") {
            drawBarChart(chartData);
          } else {
            drawLineChart(chartData);
          }

          // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
          drawTable(chartData);
        }

        function aggregateOverall(records) {
          let planned = 0;
          let actual = 0;

          records.forEach((record) => {
            const total = sumMonthlyData(record.monthlyData);
            if (record.type === "äºˆ") {
              planned += total;
            } else if (record.type === "å®Ÿ") {
              actual += total;
            }
          });

          return [
            {
              label: "å…¨ä½“",
              planned,
              actual,
            },
          ];
        }

        function aggregateByKey(records, key) {
          const grouped = {};
          const empDepts = {};

          records.forEach((record) => {
            const groupKey = record[key];

            if (key === "employee" && record.department) {
              empDepts[groupKey] = record.department;
            }

            if (!grouped[groupKey]) {
              grouped[groupKey] = { planned: 0, actual: 0 };
            }
            const total = sumMonthlyData(record.monthlyData);
            if (record.type === "äºˆ") {
              grouped[groupKey].planned += total;
            } else if (record.type === "å®Ÿ") {
              grouped[groupKey].actual += total;
            }
          });

          return Object.entries(grouped).map(([label, data]) => {
            const item = {
              label,
              planned: data.planned,
              actual: data.actual,
            };
            if (key === "employee") {
              item.department = empDepts[label] || "-";
            }
            return item;
          });
        }

        function aggregateByMonth(records) {
          const filteredMonths = getFilteredMonths();
          const grouped = {};

          filteredMonths.forEach((month) => {
            grouped[month] = { planned: 0, actual: 0 };
          });

          records.forEach((record) => {
            Object.entries(record.monthlyData).forEach(([month, value]) => {
              if (grouped[month]) {
                if (record.type === "äºˆ") {
                  grouped[month].planned += value;
                } else if (record.type === "å®Ÿ") {
                  grouped[month].actual += value;
                }
              }
            });
          });

          return Object.entries(grouped).map(([label, data]) => ({
            label,
            planned: data.planned,
            actual: data.actual,
          }));
        }

        // ========================================
        // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ãƒˆå‡¦ç†ï¼ˆã‚°ãƒ©ãƒ•ãƒ»ãƒ†ãƒ¼ãƒ–ãƒ«å…±é€šï¼‰
        // ========================================
        function sortChartData(data) {
          if (!tableSort.key || !data) return;

          data.sort((a, b) => {
            let valA, valB;
            if (tableSort.key === "label") {
              valA = a.label;
              valB = b.label;
              return tableSort.order === "asc"
                ? valA.localeCompare(valB, "ja")
                : valB.localeCompare(valA, "ja");
            } else if (tableSort.key === "department") {
              valA = a.department || "";
              valB = b.department || "";
              return tableSort.order === "asc"
                ? valA.localeCompare(valB, "ja")
                : valB.localeCompare(valA, "ja");
            } else {
              const getVal = (item, k) => {
                if (k === "planned") return item.planned;
                if (k === "actual") return item.actual;
                if (k === "diff") return item.actual - item.planned;
                if (k === "rate")
                  return item.planned > 0
                    ? (item.actual / item.planned) * 100
                    : 0;
                return 0;
              };
              valA = getVal(a, tableSort.key);
              valB = getVal(b, tableSort.key);
              return tableSort.order === "asc" ? valA - valB : valB - valA;
            }
          });
        }

        // ========================================
        // ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
        // ========================================
        function drawTable(data) {
          // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°æ›´æ–°
          if (data) currentChartData = data;
          const targetData = currentChartData;
          const tbody = document.querySelector("#dataTable tbody");
          const container = document.getElementById("dataTableContainer");

          if (!targetData || targetData.length === 0) {
            container.style.display = "none";
            return;
          }
          container.style.display = "block";

          const unit = getUnitLabel();

          // åˆ†æã‚¿ã‚¤ãƒ—å–å¾—
          const currentAnalysisType = document.querySelector(
            'input[name="analysisType"]:checked'
          ).value;
          const showDept = currentAnalysisType === "employee";

          let labelText = "é …ç›®";
          if (currentAnalysisType === "project") labelText = "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå";
          else if (currentAnalysisType === "department") labelText = "éƒ¨ç½²å";
          else if (currentAnalysisType === "employee") labelText = "æ°å";
          else if (currentAnalysisType === "monthly") labelText = "å¹´æœˆ";

          // ãƒ‡ãƒ¼ã‚¿å¤‰æ›ã¨ã‚½ãƒ¼ãƒˆç”¨ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£è¿½åŠ 
          let processedData = targetData.map((item) => {
            const planned = convertToDisplayUnit(item.planned);
            const actual = convertToDisplayUnit(item.actual);
            const diff = actual - planned;
            const rate = planned > 0 ? (actual / planned) * 100 : 0;
            return {
              ...item,
              displayPlanned: planned,
              displayActual: actual,
              diff,
              rate,
            };
          });

          // ãƒ˜ãƒƒãƒ€ãƒ¼å‹•çš„æ›´æ–°
          const thead = document.querySelector("#dataTable thead");
          let headerHTML = `<tr><th class="align-left" data-key="label">${labelText}</th>`;
          if (showDept) {
            headerHTML +=
              '<th class="align-left" data-key="department">éƒ¨ç½²</th>';
          }
          headerHTML +=
            '<th data-key="planned">äºˆå®š</th><th data-key="actual">å®Ÿç¸¾</th><th data-key="diff">å·®ç•°</th><th data-key="rate">åˆ°é”ç‡</th></tr>';
          thead.innerHTML = headerHTML;

          // ãƒ˜ãƒƒãƒ€ãƒ¼æ›´æ–°
          updateTableHeader();

          let totalPlanned = 0;
          let totalActual = 0;

          const rows = processedData
            .map((item) => {
              totalPlanned += item.displayPlanned;
              totalActual += item.displayActual;

              const deptCell = showDept
                ? `<td class="align-left">${item.department || "-"}</td>`
                : "";

              return `
                    <tr>
                        <td class="align-left">${item.label}</td>
                        ${deptCell}
                        <td>${item.displayPlanned.toFixed(1)}${unit}</td>
                        <td>${item.displayActual.toFixed(1)}${unit}</td>
                        <td style="color: ${
                          item.diff > 0
                            ? "#ea580c"
                            : item.diff < 0
                            ? "#16a34a"
                            : "inherit"
                        }">
                            ${item.diff > 0 ? "+" : ""}${item.diff.toFixed(
                1
              )}${unit}
                        </td>
                        <td>${item.rate.toFixed(1)}%</td>
                    </tr>
                `;
            })
            .join("");

          // åˆè¨ˆè¡Œ
          const totalDiff = totalActual - totalPlanned;
          const totalRate =
            totalPlanned > 0 ? (totalActual / totalPlanned) * 100 : 0;

          const totalRow = `
                <tr style="font-weight: bold; background-color: var(--bg-tertiary);">
                    <td class="align-left" colspan="${
                      showDept ? 2 : 1
                    }">åˆè¨ˆ</td>
                    <td>${totalPlanned.toFixed(1)}${unit}</td>
                    <td>${totalActual.toFixed(1)}${unit}</td>
                    <td style="color: ${
                      totalDiff > 0
                        ? "#ea580c"
                        : totalDiff < 0
                        ? "#16a34a"
                        : "inherit"
                    }">
                        ${totalDiff > 0 ? "+" : ""}${totalDiff.toFixed(
            1
          )}${unit}
                    </td>
                    <td>${totalRate.toFixed(1)}%</td>
                </tr>
            `;

          tbody.innerHTML = rows + totalRow;
        }

        function updateTableHeader() {
          const currentAnalysisType = document.querySelector(
            'input[name="analysisType"]:checked'
          ).value;
          let labelText = "é …ç›®";
          if (currentAnalysisType === "project") labelText = "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå";
          else if (currentAnalysisType === "department") labelText = "éƒ¨ç½²å";
          else if (currentAnalysisType === "employee") labelText = "æ°å";
          else if (currentAnalysisType === "monthly") labelText = "å¹´æœˆ";

          const headers = document.querySelectorAll("#dataTable th");
          headers.forEach((th) => {
            const key = th.getAttribute("data-key");
            if (!key) return;

            th.onclick = () => sortTable(key);

            const textBase =
              key === "label"
                ? labelText
                : key === "department"
                ? "éƒ¨ç½²"
                : key === "planned"
                ? "äºˆå®š"
                : key === "actual"
                ? "å®Ÿç¸¾"
                : key === "diff"
                ? "å·®ç•°"
                : "åˆ°é”ç‡";

            let iconChar = "â–²";
            let iconClass = "sort-icon";

            if (tableSort.key === key) {
              iconChar = tableSort.order === "asc" ? "â–²" : "â–¼";
              iconClass += " active";
              th.style.backgroundColor = "#eef2f0";
            } else {
              th.style.backgroundColor = "";
            }

            th.innerHTML = `${textBase}<span class="${iconClass}">${iconChar}</span>`;
          });
        }

        // ========================================
        // æ£’ã‚°ãƒ©ãƒ•æç”»
        // ========================================
        function drawBarChart(data) {
          const canvas = document.getElementById("chart");

          // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºèª¿æ•´ï¼ˆé«˜DPIå¯¾å¿œï¼‰
          const containerWidth = canvas.parentElement.offsetWidth - 50;
          const cssWidth = Math.max(containerWidth, 600);
          const cssHeight = 350;
          const ratio = window.devicePixelRatio || 1;
          canvas.width = Math.round(cssWidth * ratio);
          canvas.height = Math.round(cssHeight * ratio);
          canvas.style.width = cssWidth + "px";
          canvas.style.height = cssHeight + "px";
          const ctx = canvas.getContext("2d");
          ctx.setTransform(ratio, 0, 0, ratio, 0, 0);

          const width = cssWidth;
          const height = cssHeight;
          const padding = { top: 40, right: 40, bottom: 80, left: 80 };
          const chartWidth = width - padding.left - padding.right;
          const chartHeight = height - padding.top - padding.bottom;

          // ã‚¯ãƒªã‚¢
          ctx.clearRect(0, 0, width, height);

          if (data.length === 0) {
            ctx.fillStyle = "#a0a0b0";
            ctx.font = "16px sans-serif";
            ctx.textAlign = "center";
            ctx.fillText("è¡¨ç¤ºã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“", width / 2, height / 2);
            return;
          }

          // å˜ä½å¤‰æ›ã‚’é©ç”¨ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
          const displayData = data.map((d) => ({
            label: d.label,
            planned: convertToDisplayUnit(d.planned),
            actual: convertToDisplayUnit(d.actual),
          }));

          // å˜ä½å–å¾—
          const unit = getUnitLabel();

          // ãƒ‡ãƒ¼ã‚¿ä¸Šã®æœ€å¤§å€¤
          const dataMax =
            Math.max(...displayData.flatMap((d) => [d.planned, d.actual])) || 0;

          // ã‚­ãƒªã®è‰¯ã„ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¨ˆç®—
          const step = calculateNiceStep(dataMax, 5);

          // ã‚¹ãƒ†ãƒƒãƒ—ã®å€æ•°ã«åˆ‡ã‚Šä¸Šã’ï¼ˆæœ€å¤§å€¤ï¼‰
          const maxValue = Math.ceil(dataMax / step) * step || step;

          // ã‚°ãƒªãƒƒãƒ‰ç·š
          ctx.strokeStyle = "#d1d5db";
          ctx.lineWidth = 1;

          const gridLines = Math.round(maxValue / step);

          for (let i = 0; i <= gridLines; i++) {
            const value = step * i;
            const ratio = value / maxValue;
            const y = padding.top + chartHeight - chartHeight * ratio;

            ctx.beginPath();
            ctx.moveTo(padding.left, y);
            ctx.lineTo(width - padding.right, y);
            ctx.stroke();

            // Yè»¸ãƒ©ãƒ™ãƒ«
            ctx.fillStyle = "#5a5a7a";
            ctx.font = "11px sans-serif";
            ctx.textAlign = "right";
            // æ•´æ•°ãªã‚‰å°‘æ•°ç‚¹ãªã—ã€å°‘æ•°ãªã‚‰1æ¡
            const labelValue = Number.isInteger(step)
              ? value.toString()
              : value.toFixed(1);
            ctx.fillText(labelValue + unit, padding.left - 10, y + 4);
          }

          // æ£’ã‚°ãƒ©ãƒ•æç”»
          const groupWidth = chartWidth / displayData.length;
          const barWidth = Math.min(groupWidth * 0.35, 60);
          const gap = barWidth * 0.2;

          // ãƒ©ãƒ™ãƒ«ã®å›è»¢åˆ¤å®š
          ctx.font = "11px sans-serif";
          const maxLabelWidth = groupWidth - 10;
          const rotateLabels = displayData.some(
            (d) => ctx.measureText(d.label).width > maxLabelWidth
          );

          displayData.forEach((item, index) => {
            const x = padding.left + groupWidth * index + groupWidth / 2;

            // äºˆå®šï¼ˆä»Šå›ã¯ã‚ªãƒ¬ãƒ³ã‚¸ï¼‰
            const plannedHeight = (item.planned / maxValue) * chartHeight;
            const plannedGradient = ctx.createLinearGradient(
              0,
              padding.top + chartHeight - plannedHeight,
              0,
              padding.top + chartHeight
            );
            plannedGradient.addColorStop(0, "#f59e0b");
            plannedGradient.addColorStop(1, "#d97706");
            ctx.fillStyle = plannedGradient;
            ctx.fillRect(
              x - barWidth - gap / 2,
              padding.top + chartHeight - plannedHeight,
              barWidth,
              plannedHeight
            );

            // å®Ÿç¸¾ï¼ˆä»Šå›ã¯ç·‘ï¼‰
            const actualHeight = (item.actual / maxValue) * chartHeight;
            const actualGradient = ctx.createLinearGradient(
              0,
              padding.top + chartHeight - actualHeight,
              0,
              padding.top + chartHeight
            );
            actualGradient.addColorStop(0, "#5c9476");
            actualGradient.addColorStop(1, "#4a7a62");
            ctx.fillStyle = actualGradient;
            ctx.fillRect(
              x + gap / 2,
              padding.top + chartHeight - actualHeight,
              barWidth,
              actualHeight
            );

            // å€¤ãƒ©ãƒ™ãƒ«
            ctx.fillStyle = "#2f3e35";
            ctx.font = "10px sans-serif";
            ctx.textAlign = "center";
            if (item.planned > 0) {
              ctx.fillText(
                item.planned.toFixed(1),
                x - barWidth / 2 - gap / 2,
                padding.top + chartHeight - plannedHeight - 5
              );
            }
            if (item.actual > 0) {
              ctx.fillText(
                item.actual.toFixed(1),
                x + barWidth / 2 + gap / 2,
                padding.top + chartHeight - actualHeight - 5
              );
            }

            // Xè»¸ãƒ©ãƒ™ãƒ«
            ctx.fillStyle = "#5a5a7a";
            ctx.font = "11px sans-serif";

            const label = item.label;

            if (rotateLabels) {
              ctx.save();
              ctx.textAlign = "right";
              ctx.translate(x, padding.top + chartHeight + 10);
              ctx.rotate(-Math.PI / 6);
              ctx.fillText(
                label.substring(0, 15) + (label.length > 15 ? "..." : ""),
                0,
                0
              );
              ctx.restore();
            } else {
              ctx.textAlign = "center";
              ctx.fillText(label, x, padding.top + chartHeight + 20);
            }
          });
        }

        // ========================================
        // æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•æç”»
        // ========================================
        function drawLineChart(data) {
          const canvas = document.getElementById("chart");
          // é«˜DPIå¯¾å¿œã§ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’è¨­å®š
          const containerWidth = canvas.parentElement.offsetWidth - 50;
          const cssWidth = Math.max(containerWidth, 600);
          const cssHeight = 350;
          const ratio = window.devicePixelRatio || 1;
          canvas.width = Math.round(cssWidth * ratio);
          canvas.height = Math.round(cssHeight * ratio);
          canvas.style.width = cssWidth + "px";
          canvas.style.height = cssHeight + "px";
          const ctx = canvas.getContext("2d");
          ctx.setTransform(ratio, 0, 0, ratio, 0, 0);

          const width = cssWidth;
          const height = cssHeight;
          const padding = { top: 40, right: 40, bottom: 80, left: 80 };
          const chartWidth = width - padding.left - padding.right;
          const chartHeight = height - padding.top - padding.bottom;

          ctx.clearRect(0, 0, width, height);

          if (data.length === 0) {
            ctx.fillStyle = "#5a5a7a";
            ctx.font = "16px sans-serif";
            ctx.textAlign = "center";
            ctx.fillText("è¡¨ç¤ºã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“", width / 2, height / 2);
            return;
          }

          // å˜ä½å¤‰æ›ã‚’é©ç”¨ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
          const displayData = data.map((d) => ({
            label: d.label,
            planned: convertToDisplayUnit(d.planned),
            actual: convertToDisplayUnit(d.actual),
          }));

          // å˜ä½å–å¾—
          const unit = getUnitLabel();

          // ãƒ‡ãƒ¼ã‚¿ä¸Šã®æœ€å¤§å€¤
          const dataMax =
            Math.max(...displayData.flatMap((d) => [d.planned, d.actual])) || 0;

          // ã‚­ãƒªã®è‰¯ã„ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¨ˆç®—
          const step = calculateNiceStep(dataMax, 5);

          // ã‚¹ãƒ†ãƒƒãƒ—ã®å€æ•°ã«åˆ‡ã‚Šä¸Šã’ï¼ˆæœ€å¤§å€¤ï¼‰
          const maxValue = Math.ceil(dataMax / step) * step || step;

          // ã‚°ãƒªãƒƒãƒ‰ç·š
          ctx.strokeStyle = "#d1d5db";
          ctx.lineWidth = 1;

          const gridLines = Math.round(maxValue / step);

          for (let i = 0; i <= gridLines; i++) {
            const value = step * i;
            const ratio = value / maxValue;
            const y = padding.top + chartHeight - chartHeight * ratio;

            ctx.beginPath();
            ctx.moveTo(padding.left, y);
            ctx.lineTo(width - padding.right, y);
            ctx.stroke();

            ctx.fillStyle = "#5a5a7a";
            ctx.font = "11px sans-serif";
            ctx.textAlign = "right";
            const labelValue = Number.isInteger(step)
              ? value.toString()
              : value.toFixed(1);
            ctx.fillText(labelValue + unit, padding.left - 10, y + 4);
          }

          const stepX = chartWidth / (displayData.length - 1 || 1);

          // ãƒ©ãƒ™ãƒ«ã®å›è»¢åˆ¤å®š
          ctx.font = "11px sans-serif";
          const maxLabelWidth = Math.max(stepX - 10, 30);
          const rotateLabels = displayData.some(
            (d) => ctx.measureText(d.label).width > maxLabelWidth
          );

          // äºˆå®šç·šï¼ˆä»Šå›ã¯ã‚ªãƒ¬ãƒ³ã‚¸ï¼‰
          ctx.beginPath();
          ctx.strokeStyle = "#d97706";
          ctx.lineWidth = 3;
          displayData.forEach((item, index) => {
            const x = padding.left + stepX * index;
            const y =
              padding.top +
              chartHeight -
              (item.planned / maxValue) * chartHeight;
            if (index === 0) {
              ctx.moveTo(x, y);
            } else {
              ctx.lineTo(x, y);
            }
          });
          ctx.stroke();

          // å®Ÿç¸¾ç·šï¼ˆä»Šå›ã¯ç·‘ï¼‰
          ctx.beginPath();
          ctx.strokeStyle = "#5c9476";
          ctx.lineWidth = 3;
          displayData.forEach((item, index) => {
            const x = padding.left + stepX * index;
            const y =
              padding.top +
              chartHeight -
              (item.actual / maxValue) * chartHeight;
            if (index === 0) {
              ctx.moveTo(x, y);
            } else {
              ctx.lineTo(x, y);
            }
          });
          ctx.stroke();

          // ãƒã‚¤ãƒ³ãƒˆã¨ãƒ©ãƒ™ãƒ«
          displayData.forEach((item, index) => {
            const x = padding.left + stepX * index;

            // äºˆå®šãƒã‚¤ãƒ³ãƒˆï¼ˆã‚ªãƒ¬ãƒ³ã‚¸ï¼‰
            const plannedY =
              padding.top +
              chartHeight -
              (item.planned / maxValue) * chartHeight;
            ctx.beginPath();
            ctx.fillStyle = "#d97706";
            ctx.arc(x, plannedY, 5, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = "#ffffff";
            ctx.beginPath();
            ctx.arc(x, plannedY, 2, 0, Math.PI * 2);
            ctx.fill();

            // å®Ÿç¸¾ãƒã‚¤ãƒ³ãƒˆï¼ˆç·‘ï¼‰
            const actualY =
              padding.top +
              chartHeight -
              (item.actual / maxValue) * chartHeight;
            ctx.beginPath();
            ctx.fillStyle = "#5c9476";
            ctx.arc(x, actualY, 5, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = "#ffffff";
            ctx.beginPath();
            ctx.arc(x, actualY, 2, 0, Math.PI * 2);
            ctx.fill();

            // Xè»¸ãƒ©ãƒ™ãƒ«
            ctx.fillStyle = "#5a5a7a";
            ctx.font = "11px sans-serif";

            const label = item.label;

            if (rotateLabels) {
              ctx.save();
              ctx.textAlign = "right";
              ctx.translate(x, padding.top + chartHeight + 10);
              ctx.rotate(-Math.PI / 6);
              ctx.fillText(
                label.substring(0, 15) + (label.length > 15 ? "..." : ""),
                0,
                0
              );
              ctx.restore();
            } else {
              ctx.textAlign = "center";
              ctx.fillText(label, x, padding.top + chartHeight + 20);
            }
          });
        }

        // ========================================
        // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç®¡ç†
        // ========================================
        function saveToStorage() {
          try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
          } catch (e) {
            console.error("ä¿å­˜ã‚¨ãƒ©ãƒ¼:", e);
          }
        }

        function loadFromStorage() {
          try {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
              appData = JSON.parse(saved);
              filters.projects = [...appData.projects];
              filters.departments = [...appData.departments];
              filters.employees = [...appData.employees];
              showUI();
              updateChart();
              showToast("ä¿å­˜æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ");
            }
          } catch (e) {
            console.error("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", e);
          }
        }

        function clearData() {
          if (confirm("ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ")) {
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
          }
        }

        // ========================================
        // ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥
        // ========================================
        function showToast(message, isError = false) {
          const toast = document.getElementById("toast");
          toast.textContent = message;
          toast.className = "toast" + (isError ? " error" : "");
          toast.classList.add("show");
          setTimeout(() => toast.classList.remove("show"), 3000);
        }

        // ========================================
        // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
        // ========================================
        window.addEventListener("resize", () => {
          if (appData.records.length > 0) {
            updateChart();
          }
        });
        // ========================================
        // ãŠæ°—ã«å…¥ã‚Šæ¡ä»¶
        // ========================================
        appData.savedFilters = [];

        function loadSavedFilters() {
          const saved = localStorage.getItem("crowdlog_saved_filters");
          if (saved) {
            try {
              const parsed = JSON.parse(saved);
              if (Array.isArray(parsed)) {
                appData.savedFilters = parsed;
              } else {
                appData.savedFilters = [];
              }
            } catch (e) {
              console.error("JSON parse error", e);
              appData.savedFilters = [];
            }
          } else {
            appData.savedFilters = [];
          }
          updateSavedFiltersSelect();
        }

        function saveSavedFilters() {
          localStorage.setItem(
            "crowdlog_saved_filters",
            JSON.stringify(appData.savedFilters)
          );
          updateSavedFiltersSelect();
        }

        function updateSavedFiltersSelect() {
          const select = document.getElementById("savedFiltersSelect");
          if (!select) return;
          const currentVal = select.value;
          // å®‰å…¨ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰
          select.innerHTML = "";
          const defaultOpt = document.createElement("option");
          defaultOpt.value = "";
          defaultOpt.textContent = "(é¸æŠã—ã¦ãã ã•ã„)";
          select.appendChild(defaultOpt);
          appData.savedFilters.forEach((f) => {
            const opt = document.createElement("option");
            opt.value = f.id;
            opt.textContent = f.name;
            select.appendChild(opt);
          });

          if (appData.savedFilters.some((f) => f.id === currentVal)) {
            select.value = currentVal;
            enableFilterButtons(true);
          } else {
            select.value = "";
            enableFilterButtons(false);
          }
        }

        function enableFilterButtons(enabled) {
          const ids = [
            "btnOverwriteFilter",
            "btnCopyFilter",
            "btnRenameFilter",
            "btnDeleteFilter",
          ];
          ids.forEach((id) => {
            const el = document.getElementById(id);
            if (el) el.disabled = !enabled;
          });
        }

        function saveCurrentFilter() {
          const name = prompt("ä¿å­˜ã™ã‚‹åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:", "ç¾åœ¨ã®æ¡ä»¶");
          if (!name) return;

          const newFilter = {
            id: Date.now().toString(),
            name: name,
            filters: {
              projects: [...filters.projects],
              departments: [...filters.departments],
              employees: [...filters.employees],
            },
          };
          appData.savedFilters.push(newFilter);
          saveSavedFilters();

          document.getElementById("savedFiltersSelect").value = newFilter.id;
          enableFilterButtons(true);
        }

        function overwriteCurrentFilter() {
          const select = document.getElementById("savedFiltersSelect");
          const id = select.value;
          if (!id || !confirm("ç¾åœ¨é¸æŠä¸­ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®šã‚’ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ"))
            return;

          const index = appData.savedFilters.findIndex((f) => f.id === id);
          if (index > -1) {
            appData.savedFilters[index].filters = {
              projects: [...filters.projects],
              departments: [...filters.departments],
              employees: [...filters.employees],
            };
            saveSavedFilters();
            select.value = id;
            alert("ä¸Šæ›¸ãä¿å­˜ã—ã¾ã—ãŸã€‚");
          }
        }

        function copyCurrentFilter() {
          const select = document.getElementById("savedFiltersSelect");
          const id = select.value;
          if (!id) return;

          const original = appData.savedFilters.find((f) => f.id === id);
          if (!original) return;

          const name = prompt(
            "æ–°ã—ã„åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:",
            original.name + " ã®ã‚³ãƒ”ãƒ¼"
          );
          if (!name) return;

          const newFilter = {
            id: Date.now().toString(),
            name: name,
            filters: JSON.parse(JSON.stringify(original.filters)),
          };
          appData.savedFilters.push(newFilter);
          saveSavedFilters();

          document.getElementById("savedFiltersSelect").value = newFilter.id;
          enableFilterButtons(true);
        }

        function renameCurrentFilter() {
          const select = document.getElementById("savedFiltersSelect");
          const id = select.value;
          if (!id) return;

          const target = appData.savedFilters.find((f) => f.id === id);
          if (!target) return;

          const name = prompt("æ–°ã—ã„åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:", target.name);
          if (!name) return;

          target.name = name;
          saveSavedFilters();
          select.value = id;
        }

        function deleteCurrentFilter() {
          const select = document.getElementById("savedFiltersSelect");
          const id = select.value;
          if (!id || !confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;

          appData.savedFilters = appData.savedFilters.filter(
            (f) => f.id !== id
          );
          saveSavedFilters();
        }

        function applySavedFilter(id) {
          if (!id) {
            enableFilterButtons(false);
            return;
          }
          const target = appData.savedFilters.find((f) => f.id === id);
          if (target) {
            filters.projects = [...target.filters.projects];
            filters.departments = [...target.filters.departments];
            filters.employees = [...target.filters.employees];
            updateFiltersUI();
            updateChart();
            enableFilterButtons(true);
          }
        }
        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ: ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒãƒ³ãƒ‰ãƒ©ã‚„å¤–éƒ¨ã‹ã‚‰å¿…è¦ãªé–¢æ•°ã®ã¿ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
        try {
          window.CrowdLog = {
            processFile,
            clearData,
            resetPeriod,
            selectAll,
            deselectAll,
            updateFilterSort,
            saveCurrentFilter,
            overwriteCurrentFilter,
            copyCurrentFilter,
            renameCurrentFilter,
            deleteCurrentFilter,
            applySavedFilter,
            loadSavedFilters,
            saveSavedFilters,
            saveToStorage,
            loadFromStorage,
            toggleFilter,
          };
          Object.assign(window, window.CrowdLog);
        } catch (e) {
          console.warn("Export failed", e);
        }
      })();
    </script>
  </body>
</html>
