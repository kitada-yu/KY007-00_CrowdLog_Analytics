<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>📊CrowdLog Analytics</title>
    <link rel="stylesheet" href="KY007-03_CrowdLog_Analytics.css" />

  </head>

  <body>
    <div class="container">
      <!-- Header & Drop Zone -->
      <div class="header-row">
        <div class="header-content">
          <div class="app-logo">
            <div class="app-icon">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <line x1="18" y1="20" x2="18" y2="10"></line>
                <line x1="12" y1="20" x2="12" y2="4"></line>
                <line x1="6" y1="20" x2="6" y2="14"></line>
              </svg>
            </div>
            <div class="app-title-group">
              <div class="app-title-main">CrowdLog Analytics</div>
              <div class="app-title-sub">業務時間予実分析ダッシュボード</div>
            </div>
          </div>
        </div>

        <div class="file-timestamp-box">
          <div id="fileTimestamp" class="file-timestamp"></div>
        </div>

        <div style="display: flex; gap: 15px; align-items: stretch">
          <div class="drop-area-vertical">
            <div class="drop-zone" id="dropZone" aria-label="CSVファイルを選択">
              <div style="display:flex;align-items:center;gap:12px;width:100%;">
                <div class="drop-zone-icon" aria-hidden="true">
                  <!-- Excel/CSV風アイコン: 簡易な表と小さな緑のバッジ -->
                  <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <rect x="1" y="3" width="14" height="18" rx="2" fill="#ffffff" stroke="#4CAF50" stroke-width="1.2"></rect>
                    <path d="M3 7h12M3 11h12M3 15h12" stroke="#4CAF50" stroke-width="0.9" stroke-linecap="round"></path>
                    <rect x="16" y="5" width="6" height="6" rx="1" fill="#1E8E3E"></rect>
                    <text x="18.5" y="9.2" font-size="3" fill="#fff" font-family="sans-serif">CSV</text>
                  </svg>
                </div>
                <div style="display:flex;flex-direction:column;gap:4px;flex:1;">
                  <div style="display:flex;align-items:center;gap:8px;">
                    <input type="file" id="fileInput" accept=".csv" aria-label="CSVファイルを選択" />
                    <button type="button" id="btnSelectFile" class="btn-select-file">CSVを読み込む</button>
                  </div>
                  <div class="file-info hidden" id="fileInfo" style="font-size:0.85rem;color:var(--text-secondary);"></div>
                </div>
              </div>
            </div>

            <!-- 文字コード選択は廃止: 常に自動検出を使用 -->
          </div>
          <div id="fileControls"
            style="
              display: flex;
              flex-direction: column;
              gap: 5px;
              justify-content: center;
            "
          >
            <button
              class="btn btn-secondary btn-small"
              id="btnReload"
              onclick="location.reload()"
              style="white-space: nowrap"
            >
              🔄 再読込
            </button>
            <button
              class="btn btn-danger btn-small hidden"
              id="btnClear"
              onclick="clearData()"
              style="white-space: nowrap"
            >
              🗑️ クリア
            </button>
          </div>
        </div>
      </div>

      <!-- Control Panel REMOVED -->

      <!-- Filter Section -->
      <div class="filter-section hidden" id="filterSection">
        <div class="filter-group" id="mainControls">
          <!-- Period Selector -->
          <div
            style="
              margin-bottom: 24px;
              border-bottom: 1px solid var(--border-color);
              padding-bottom: 16px;
            "
          >
            <div class="filter-title">📅 集計期間</div>
            <div
              class="period-selector"
              style="
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 0.85rem;
              "
            >
              <select
                id="periodStart"
                onchange="updatePeriodFilter()"
                class="filter-search"
                style="
                  margin-bottom: 0;
                  padding: 4px 8px;
                  width: 100px;
                  font-size: 0.85rem;
                "
              >
              </select>
              </select>
              <span style="color: var(--text-sub)">〜</span>
              <select
                id="periodEnd"
                onchange="updatePeriodFilter()"
                class="filter-search"
                style="
                  margin-bottom: 0;
                  padding: 4px 8px;
                  width: 100px;
                  font-size: 0.85rem;
                "
              >
              </select>
              </select>
              <button
                class="btn-small btn-outline"
                onclick="resetPeriod()"
                style="padding: 4px 8px"
                title="全期間にリセット"
              >
                ↺
              </button>
            </div>
          </div>

          <div class="filter-title">📈 分析タイプ</div>
          <div
            class="radio-group vertical-radio-group"
            id="analysisType"
            role="radiogroup"
          >
            <label class="radio-item active">
              <input type="radio" name="analysisType" value="overall" checked />
              全体
            </label>
            <label class="radio-item">
              <input type="radio" name="analysisType" value="project" />
              プロジェクト別
            </label>
            <label class="radio-item">
              <input type="radio" name="analysisType" value="department" />
              部署別
            </label>
            <label class="radio-item">
              <input type="radio" name="analysisType" value="employee" />
              従業員別
            </label>
            <label class="radio-item">
              <input type="radio" name="analysisType" value="monthly" />
              月別推移
            </label>
          </div>
        </div>

        <div class="filter-group" id="projectFilters">
          <div class="filter-title">📁 プロジェクト</div>
          <input
            type="text"
            class="filter-search"
            id="projectSearch"
            placeholder="🔍 検索..."
          />
          <div class="filter-actions">
            <button class="btn-small" onclick="selectAll('projects')">
              全選択
            </button>
            <button
              class="btn-small btn-outline"
              onclick="deselectAll('projects')"
            >
              全解除
            </button>
            <select
              class="filter-sort-select"
              onchange="updateFilterSort('projects', this.value)"
            >
              <option value="name_asc">昇順</option>
              <option value="name_desc">降順</option>
              <option value="selected">選択順</option>
            </select>
          </div>
          <div class="filter-items" id="projectFilterItems"></div>
        </div>
        <div class="filter-group" id="departmentFilters">
          <div class="filter-title">🏢 部署</div>
          <input
            type="text"
            class="filter-search"
            id="departmentSearch"
            placeholder="🔍 検索..."
          />
          <div class="filter-actions">
            <button class="btn-small" onclick="selectAll('departments')">
              全選択
            </button>
            <button
              class="btn-small btn-outline"
              onclick="deselectAll('departments')"
            >
              全解除
            </button>
            <select
              class="filter-sort-select"
              onchange="updateFilterSort('departments', this.value)"
            >
              <option value="name_asc">昇順</option>
              <option value="name_desc">降順</option>
              <option value="selected">選択順</option>
            </select>
          </div>
          <div class="filter-items" id="departmentFilterItems"></div>
        </div>
        <div class="filter-group" id="employeeFilters">
          <div class="filter-title">👤 従業員</div>
          <input
            type="text"
            class="filter-search"
            id="employeeSearch"
            placeholder="🔍 検索..."
          />
          <div class="filter-actions">
            <button class="btn-small" onclick="selectAll('employees')">
              全選択
            </button>
            <button
              class="btn-small btn-outline"
              onclick="deselectAll('employees')"
            >
              全解除
            </button>
            <select
              class="filter-sort-select"
              onchange="updateFilterSort('employees', this.value)"
            >
              <option value="name_asc">昇順</option>
              <option value="name_desc">降順</option>
              <option value="selected">選択順</option>
            </select>
          </div>
          <div class="filter-items" id="employeeFilterItems"></div>
        </div>
      </div>

      <!-- Favorites Section -->
      <div class="favorites-section hidden" id="favoritesSection">
        <div
          style="
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: space-between;
          "
        >
          <div style="display: flex; align-items: center; gap: 10px">
            <div style="font-weight: 600; color: var(--accent-purple)">
              ★ お気に入り
            </div>
          </div>

          <div style="display: flex; align-items: center; gap: 10px; flex: 1">
            <select
              id="savedFiltersSelect"
              class="filter-search"
              style="margin-bottom: 0; width: auto; flex: 1"
              onchange="applySavedFilter(this.value)"
            >
              <option value="">(条件を選択)</option>
            </select>
            <button
              class="btn-icon-tiny"
              id="btnSaveFilter"
              onclick="saveCurrentFilter()"
              title="現在の条件を新規保存"
              style="font-size: 1.5rem"
            >
              ➕
            </button>
          </div>

          <div style="display: flex; gap: 8px">
            <button
              class="btn-icon"
              id="btnOverwriteFilter"
              onclick="overwriteCurrentFilter()"
              title="上書き保存"
              disabled
            >
              💾
            </button>
            <button
              class="btn-icon"
              id="btnCopyFilter"
              onclick="copyCurrentFilter()"
              title="複製して保存"
              disabled
            >
              📑
            </button>
            <button
              class="btn-icon"
              id="btnRenameFilter"
              onclick="renameCurrentFilter()"
              title="名前を変更"
              disabled
            >
              ✏️
            </button>
            <button
              class="btn-icon danger"
              id="btnDeleteFilter"
              onclick="deleteCurrentFilter()"
              title="削除"
              disabled
            >
              🗑️
            </button>
          </div>
        </div>
      </div>

      <!-- Summary Cards -->
       <!--
      <div class="summary-cards hidden" id="summaryCards">
        <div class="summary-card">
          <div class="summary-card-value planned" id="totalPlanned">0</div>
          <div class="summary-card-label">予定時間（合計）</div>
        </div>
        <div class="summary-card">
          <div class="summary-card-value actual" id="totalActual">0</div>
          <div class="summary-card-label">実績時間（合計）</div>
        </div>
        <div class="summary-card">
          <div class="summary-card-value" id="totalDiff">0</div>
          <div class="summary-card-label">差異（実績 - 予定）</div>
        </div>
        <div class="summary-card">
          <div class="summary-card-value" id="totalRate">0%</div>
          <div class="summary-card-label">到達率</div>
        </div>
      </div>
    -->

      <!-- Chart Section -->
      <div class="chart-section hidden" id="chartSection">
        <div class="chart-container">
          <canvas id="chart" width="1100" height="350"></canvas>
        </div>
        <div class="chart-footer">
          <div class="legend">
            <div class="legend-item">
              <div class="legend-color planned"></div>
              <span>予定時間</span>
            </div>
            <div class="legend-item">
              <div class="legend-color actual"></div>
              <span>実績時間</span>
            </div>
          </div>

          <div class="chart-controls">
            <div class="chart-control-group">
              <span class="chart-control-label">グラフ:</span>
              <div class="radio-group" id="chartType" role="radiogroup">
                <label class="radio-item active">
                  <input type="radio" name="chartType" value="bar" checked />
                  棒
                </label>
                <label class="radio-item">
                  <input type="radio" name="chartType" value="line" />
                  線
                </label>
              </div>
            </div>
            <div class="chart-control-group">
              <span class="chart-control-label">基準線:</span>
              <input id="yLineValue" type="number" step="0.1" placeholder="値" style="width:80px;padding:4px;border:1px solid var(--border-color);border-radius:4px;" />
              <label style="display:flex;align-items:center;gap:6px;margin-left:6px;">
                <input id="yLineToggle" type="checkbox" style="width:16px;height:16px;" /> 表示
              </label>
            </div>
            <div class="chart-control-group">
              <span class="chart-control-label">単位:</span>
              <div class="radio-group" id="unitType" role="radiogroup">
                <label class="radio-item">
                  <input type="radio" name="unitType" value="hours" />
                  時間(h)
                </label>
                <label class="radio-item active">
                  <input type="radio" name="unitType" value="days" checked />
                  人日
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Data Table -->
        <div class="table-container" id="dataTableContainer">
          <table class="data-table" id="dataTable">
            <thead>
              <tr>
                <th class="align-left" data-key="label">項目</th>
                <th data-key="planned">予定</th>
                <th data-key="actual">実績</th>
                <th data-key="diff">差異</th>
                <th data-key="rate">達成率</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast" aria-live="polite" role="status"></div>

    <script src="KY007-03_CrowdLog_Analytics.js"></script>

  </body>
</html>
