<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üìäCrowdLog Analytics</title>
    <style>
      /* ========================================
           CSS Variables & Reset
        ======================================== */
      :root {
        --bg-primary: #f7f9f8;
        --bg-secondary: #ffffff;
        --bg-tertiary: #eef2f0;
        --text-primary: #2f3e35;
        --text-secondary: #5c6b62;
        --accent-blue: #5c9476;
        --accent-orange: #d97706;
        --accent-green: #5c9476;
        --accent-purple: #4a7a62;
        --border-color: #d1dbd6;
        --shadow: 0 4px 20px rgba(92, 148, 118, 0.1);
        --gradient-blue: linear-gradient(135deg, #5c9476 0%, #4a7a62 100%);
        --gradient-orange: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        --primary-color: var(--accent-blue);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+JP:wght@400;500;700&display=swap");

      body {
        font-family: "Inter", "Noto Sans JP", sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        min-height: 100vh;
        line-height: 1.4;
        font-size: 14px;
      }

      /* Header Customization */
      .app-logo {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .app-icon {
        width: 40px;
        height: 40px;
        background: var(--gradient-blue);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        box-shadow: 0 4px 10px rgba(92, 148, 118, 0.3);
      }

      .app-title-group {
        display: flex;
        flex-direction: column;
        line-height: 1.2;
      }

      .app-title-main {
        font-family: "Inter", sans-serif;
        font-size: 1.6rem;
        font-weight: 800;
        color: var(--text-primary);
        letter-spacing: -0.02em;
      }

      .app-title-sub {
        font-size: 0.8rem;
        color: var(--text-secondary);
        font-weight: 500;
      }

      .file-timestamp-box {
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 12px;
      }

      .file-timestamp {
        font-size: 0.95rem;
        color: white;
        background: var(--gradient-blue);
        padding: 8px 12px;
        border-radius: 10px;
        box-shadow: 0 6px 18px rgba(74, 122, 98, 0.12);
        font-weight: 700;
        letter-spacing: -0.01em;
        white-space: nowrap;
      }

      @media (max-width: 900px) {
        .file-timestamp {
          font-size: 0.85rem;
          padding: 6px 10px;
        }
        .file-timestamp-box {
          margin: 0 6px;
        }
      }

      /* ========================================
           Layout
        ======================================== */
      /* ========================================
           Layout & Header
        ======================================== */
      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 10px 15px;
      }

      .header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        gap: 20px;
        background: var(--bg-secondary);
        padding: 10px 20px;
        border-radius: 10px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
      }

      .header-content h1 {
        font-size: 1.4rem;
        background: var(--gradient-blue);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 2px;
      }

      .header-content p {
        color: var(--text-secondary);
        font-size: 0.8rem;
        margin: 0;
      }

      /* ========================================
           Drop Zone (compact)
        ======================================== */
      .drop-zone {
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 8px 10px;
        text-align: left;
        background: var(--bg-tertiary);
        cursor: default;
        transition: all 0.12s ease;
        margin-bottom: 0;
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 260px;
        max-width: 520px;
        min-height: 48px;
        justify-content: flex-start;
        font-size: 0.96rem;
      }

      .drop-zone:hover,
      .drop-zone.dragover {
        border-color: var(--accent-blue);
        background: var(--bg-tertiary);
        transform: translateY(-1px);
        box-shadow: var(--shadow);
      }

      .drop-zone-icon {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 6px;
      }

      .drop-zone-text {
        font-size: 0.85rem;
        color: var(--text-secondary);
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 160px;
      }

      .drop-zone-text strong {
        color: var(--accent-blue);
      }

      /* „Éç„Ç§„ÉÜ„Ç£„Éñ„ÅÆ file input „ÅÆ„Éï„Ç°„Ç§„É´ÂêçË°®Á§∫„ÅØÈùûË°®Á§∫„Å´„Åó„ÄÅ‰ª£„Çè„Çä„Å´„Ç´„Çπ„Çø„É†„Éú„Çø„É≥„Çí‰Ωø„ÅÜ */
      .drop-zone input[type="file"] {
        display: none;
      }
      .btn-select-file {
        padding: 3px 6px;
        border-radius: 6px;
        border: 1px solid var(--border-color);
        background: white;
        color: var(--text-primary);
        font-size: 0.9rem;
        cursor: pointer;
      }

      .file-info {
        margin-top: 6px;
        padding: 4px 8px;
        background: var(--bg-tertiary);
        border-radius: 6px;
        display: inline-block;
        color: var(--accent-green);
        font-size: 0.78rem;
        max-width: 220px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .encoding-select {
        padding: 2px 6px;
        font-size: 0.78rem;
        border-radius: 6px;
        border: 1px solid var(--border-color);
        background: var(--bg-secondary);
        color: var(--text-primary);
      }

      .drop-area-vertical {
        display: flex;
        flex-direction: column;
        gap: 6px;
        align-items: center;
        justify-content: center;
      }

      .encoding-wrap {
        display: flex;
        gap: 6px;
        align-items: center;
        justify-content: center;
      }

      /* ========================================
           Control Panel
        ======================================== */
      .control-panel {
        background: var(--bg-secondary);
        border-radius: 10px;
        padding: 12px 15px;
        margin-bottom: 10px;
        box-shadow: var(--shadow);
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
      }

      .control-section {
        margin-bottom: 0;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .control-section:last-child {
        margin-bottom: 0;
      }

      .control-label {
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        white-space: nowrap;
      }

      .radio-group,
      .checkbox-group {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
      }

      .radio-item,
      .checkbox-item {
        display: flex;
        align-items: center;
        padding: 5px 10px;
        background: var(--bg-tertiary);
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid transparent;
        font-size: 0.8rem;
      }

      .radio-item:hover,
      .checkbox-item:hover {
        border-color: var(--accent-blue);
      }

      .radio-item input,
      .checkbox-item input {
        margin-right: 5px;
        accent-color: var(--accent-blue);
        width: 14px;
        height: 14px;
      }

      .radio-item.active {
        background: var(--accent-blue);
        color: white;
      }

      /* ========================================
           Filter Section
        ======================================== */
      /* Icon Buttons */
      .btn-icon-tiny {
        background: transparent;
        border: none;
        cursor: pointer;
        font-size: 1.1rem;
        padding: 0 4px;
        color: var(--text-secondary);
        transition: color 0.2s, transform 0.2s;
        line-height: 1;
      }

      .btn-icon-tiny:hover {
        color: var(--accent-blue);
        transform: scale(1.1);
      }

      .btn-icon {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 5px;
        font-size: 1.2rem;
        cursor: pointer;
        transition: all 0.2s;
        color: var(--text-primary);
      }

      .btn-icon:hover:not(:disabled) {
        background: var(--bg-tertiary);
        border-color: var(--accent-blue);
        transform: translateY(-1px);
      }

      .btn-icon:disabled {
        opacity: 0.4;
        cursor: not-allowed;
        background: var(--bg-secondary);
      }

      .btn-icon.danger:hover:not(:disabled) {
        background: #fff0f0;
        border-color: #ffcccc;
        color: #d32f2f;
      }

      /* Á∏¶‰∏¶„Å≥„É©„Ç∏„Ç™„Éú„Çø„É≥ */
      .vertical-radio-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .vertical-radio-group .radio-item {
        justify-content: flex-start;
        padding: 8px 12px;
        width: 100%;
        box-sizing: border-box;
      }

      /* „ÅäÊ∞ó„Å´ÂÖ•„Çä„Çª„ÇØ„Ç∑„Éß„É≥ */
      .favorites-section {
        background: var(--bg-tertiary);
        border-radius: 10px;
        padding: 10px 15px;
        margin-bottom: 15px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
      }

      .filter-section {
        background: var(--bg-secondary);
        border-radius: 10px;
        padding: 10px 12px;
        margin-bottom: 10px;
        box-shadow: var(--shadow);
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
      }

      .filter-group {
        margin-bottom: 0;
      }

      .filter-group:last-child {
        margin-bottom: 0;
      }

      @media (max-width: 900px) {
        .filter-section {
          grid-template-columns: 1fr;
        }
      }

      .filter-title {
        font-weight: 600;
        margin-bottom: 5px;
        color: var(--accent-purple);
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.8rem;
      }

      .filter-items {
        display: flex;
        flex-direction: column;
        gap: 3px;
        max-height: 240px;
        overflow-y: auto;
      }

      .filter-chip {
        padding: 3px 8px;
        background: var(--bg-tertiary);
        border-radius: 12px;
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid transparent;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .filter-chip:hover {
        border-color: var(--accent-purple);
      }

      .filter-chip.active {
        background: var(--accent-purple);
        color: white;
      }

      .filter-chip input {
        display: none;
      }

      .filter-search {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background: var(--bg-primary);
        color: var(--text-primary);
        font-size: 0.85rem;
        margin-bottom: 5px;
        box-sizing: border-box;
      }

      .filter-search:focus {
        outline: none;
        border-color: var(--accent-blue);
      }

      .filter-actions {
        display: flex;
        gap: 5px;
        margin-bottom: 8px;
        align-items: center;
      }

      .filter-sort-select {
        padding: 2px 5px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 0.75rem;
        background: var(--bg-primary);
        color: var(--text-secondary);
        cursor: pointer;
        flex-grow: 1;
        height: 24px;
      }

      .filter-search::placeholder {
        color: var(--text-secondary);
      }

      .filter-actions {
        display: flex;
        gap: 8px;
        margin-bottom: 10px;
      }

      .btn-small {
        padding: 4px 12px;
        font-size: 0.75rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        background: var(--accent-purple);
        color: white;
        transition: all 0.2s ease;
      }

      .btn-small:hover {
        opacity: 0.85;
        transform: translateY(-1px);
      }

      .btn-small.btn-outline {
        background: transparent;
        border: 1px solid var(--accent-purple);
        color: var(--accent-purple);
      }

      .btn-small.btn-outline:hover {
        background: var(--accent-purple);
        color: white;
      }

      .period-selector {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
      }

      .period-selector select {
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background: var(--bg-tertiary);
        color: var(--text-primary);
        font-size: 0.9rem;
        cursor: pointer;
        min-width: 120px;
      }

      .period-selector select:focus {
        outline: none;
        border-color: var(--accent-blue);
      }

      .period-separator {
        color: var(--text-secondary);
        font-weight: 500;
      }

      /* ========================================
           Chart Section
        ======================================== */
      .chart-section {
        background: var(--bg-secondary);
        border-radius: 10px;
        padding: 10px 15px;
        margin-bottom: 10px;
        box-shadow: var(--shadow);
      }

      .chart-container {
        position: relative;
        width: 100%;
        min-height: 280px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      #chart {
        max-width: 100%;
        border-radius: 6px;
      }

      .chart-placeholder {
        text-align: center;
        color: var(--text-secondary);
      }

      .chart-placeholder-icon {
        font-size: 2.5rem;
        margin-bottom: 10px;
        opacity: 0.5;
      }

      /* ========================================
           Legend
        ======================================== */
      /* ========================================
           Chart Footer (Legend & Controls)
        ======================================== */
      .chart-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid var(--border-color);
      }

      .legend {
        display: flex;
        gap: 20px;
      }

      .chart-controls {
        display: flex;
        gap: 20px;
        align-items: center;
      }

      .chart-control-group {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .chart-control-label {
        font-size: 0.8rem;
        color: var(--text-secondary);
        font-weight: 600;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 0.8rem;
      }

      .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 4px;
      }

      .legend-color.planned {
        background: var(--gradient-orange);
      }

      .legend-color.actual {
        background: var(--gradient-blue);
      }

      /* ========================================
           Data Table
        ======================================== */
      .table-container {
        margin-top: 20px;
        overflow-x: auto;
        border: 1px solid var(--border-color);
        border-radius: 8px;
      }

      .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
      }

      .data-table th,
      .data-table td {
        padding: 10px 15px;
        text-align: right;
        border-bottom: 1px solid var(--border-color);
      }

      .data-table th {
        background: var(--bg-tertiary);
        color: var(--text-primary);
        font-weight: 600;
        text-align: right;
        /* center„Åã„ÇâÂ§âÊõ¥ */
        white-space: nowrap;
        cursor: pointer;
        /* „Åì„Åì„ÅßÊåáÂÆö */
      }

      .data-table th.align-left,
      .data-table td.align-left {
        text-align: left;
      }

      .sort-icon {
        display: inline-block;
        margin-left: 5px;
        width: 1.5em;
        text-align: center;
        opacity: 0.3;
      }

      .sort-icon.active {
        opacity: 1;
        color: var(--primary-color);
      }

      .data-table tr:last-child td {
        border-bottom: none;
      }

      .data-table tr:hover {
        background: var(--bg-primary);
      }

      /* ========================================
           Data Management
        ======================================== */
      .data-management {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .btn-primary {
        background: var(--gradient-blue);
        color: white;
      }

      .btn-danger {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
      }

      .btn-secondary {
        background: var(--bg-tertiary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
      }

      .btn:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow);
      }

      /* ========================================
           Summary Cards
        ======================================== */
      .summary-cards {
        display: flex;
        gap: 15px;
        margin-bottom: 10px;
        align-items: stretch;
      }

      .summary-card {
        background: var(--bg-secondary);
        border-radius: 8px;
        padding: 8px 15px;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: var(--shadow);
      }

      .summary-card-value {
        font-size: 1.2rem;
        font-weight: 700;
        margin-bottom: 0;
      }

      .summary-card-value.planned {
        color: var(--accent-blue);
      }

      .summary-card-value.actual {
        color: var(--accent-orange);
      }

      .summary-card-value.diff-positive {
        color: var(--accent-green);
      }

      .summary-card-value.diff-negative {
        color: #ef4444;
      }

      .summary-card-label {
        color: var(--text-secondary);
        font-size: 0.7rem;
        white-space: nowrap;
      }

      /* ========================================
           Responsive
        ======================================== */
      @media (max-width: 768px) {
        .container {
          padding: 15px;
        }

        header h1 {
          font-size: 1.5rem;
        }

        .drop-zone {
          padding: 30px 20px;
        }

        .control-panel,
        .filter-section,
        .chart-section {
          padding: 20px;
        }

        .radio-group,
        .checkbox-group {
          flex-direction: column;
        }

        .chart-container {
          min-height: 300px;
        }

        .summary-cards {
          grid-template-columns: 1fr 1fr;
        }

        .legend {
          flex-direction: column;
          align-items: center;
          gap: 10px;
        }
      }

      /* ========================================
           Animations
        ======================================== */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .fade-in {
        animation: fadeIn 0.3s ease forwards;
      }

      /* ========================================
           Toast Notification
        ======================================== */
      .toast {
        position: fixed;
        top: 30px;
        right: 30px;
        padding: 15px 25px;
        background: var(--accent-green);
        color: white;
        border-radius: 8px;
        box-shadow: var(--shadow);
        transform: translateY(-100px);
        opacity: 0;
        transition: all 0.3s ease;
        z-index: 1000;
      }

      .toast.show {
        transform: translateY(0);
        opacity: 1;
      }

      .toast.error {
        background: #ef4444;
      }

      /* ========================================
           Hidden
        ======================================== */
      .hidden {
        display: none !important;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <!-- Header & Drop Zone -->
      <div class="header-row">
        <div class="header-content">
          <div class="app-logo">
            <div class="app-icon">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <line x1="18" y1="20" x2="18" y2="10"></line>
                <line x1="12" y1="20" x2="12" y2="4"></line>
                <line x1="6" y1="20" x2="6" y2="14"></line>
              </svg>
            </div>
            <div class="app-title-group">
              <div class="app-title-main">CrowdLog Analytics</div>
              <div class="app-title-sub">Ê•≠ÂãôÊôÇÈñì‰∫àÂÆüÂàÜÊûê„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</div>
            </div>
          </div>
        </div>

        <div class="file-timestamp-box">
          <div id="fileTimestamp" class="file-timestamp"></div>
        </div>

        <div style="display: flex; gap: 15px; align-items: stretch">
          <div class="drop-area-vertical">
            <div class="drop-zone" id="dropZone" aria-label="CSV„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû">
              <div style="display:flex;align-items:center;gap:12px;width:100%;">
                <div class="drop-zone-icon" aria-hidden="true">
                  <!-- Excel/CSVÈ¢®„Ç¢„Ç§„Ç≥„É≥: Á∞°Êòì„Å™Ë°®„Å®Â∞è„Åï„Å™Á∑ë„ÅÆ„Éê„ÉÉ„Ç∏ -->
                  <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                    <rect x="1" y="3" width="14" height="18" rx="2" fill="#ffffff" stroke="#4CAF50" stroke-width="1.2"></rect>
                    <path d="M3 7h12M3 11h12M3 15h12" stroke="#4CAF50" stroke-width="0.9" stroke-linecap="round"></path>
                    <rect x="16" y="5" width="6" height="6" rx="1" fill="#1E8E3E"></rect>
                    <text x="18.5" y="9.2" font-size="3" fill="#fff" font-family="sans-serif">CSV</text>
                  </svg>
                </div>
                <div style="display:flex;flex-direction:column;gap:4px;flex:1;">
                  <div style="display:flex;align-items:center;gap:8px;">
                    <input type="file" id="fileInput" accept=".csv" aria-label="CSV„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû" />
                    <button type="button" id="btnSelectFile" class="btn-select-file">CSV„ÇíË™≠„ÅøËæº„ÇÄ</button>
                  </div>
                  <div class="file-info hidden" id="fileInfo" style="font-size:0.85rem;color:var(--text-secondary);"></div>
                </div>
              </div>
            </div>

            <!-- ÊñáÂ≠ó„Ç≥„Éº„ÉâÈÅ∏Êäû„ÅØÂªÉÊ≠¢: Â∏∏„Å´Ëá™ÂãïÊ§úÂá∫„Çí‰ΩøÁî® -->
          </div>
          <div id="fileControls"
            style="
              display: flex;
              flex-direction: column;
              gap: 5px;
              justify-content: center;
            "
          >
            <button
              class="btn btn-secondary btn-small"
              id="btnReload"
              onclick="location.reload()"
              style="white-space: nowrap"
            >
              üîÑ ÂÜçË™≠Ëæº
            </button>
            <button
              class="btn btn-danger btn-small hidden"
              id="btnClear"
              onclick="clearData()"
              style="white-space: nowrap"
            >
              üóëÔ∏è „ÇØ„É™„Ç¢
            </button>
          </div>
        </div>
      </div>

      <!-- Control Panel REMOVED -->

      <!-- Filter Section -->
      <div class="filter-section hidden" id="filterSection">
        <div class="filter-group" id="mainControls">
          <!-- Period Selector -->
          <div
            style="
              margin-bottom: 24px;
              border-bottom: 1px solid var(--border-color);
              padding-bottom: 16px;
            "
          >
            <div class="filter-title">üìÖ ÈõÜË®àÊúüÈñì</div>
            <div
              class="period-selector"
              style="
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 0.85rem;
              "
            >
              <select
                id="periodStart"
                onchange="updatePeriodFilter()"
                class="filter-search"
                style="
                  margin-bottom: 0;
                  padding: 4px 8px;
                  width: 100px;
                  font-size: 0.85rem;
                "
              >
              </select>
              </select>
              <span style="color: var(--text-sub)">„Äú</span>
              <select
                id="periodEnd"
                onchange="updatePeriodFilter()"
                class="filter-search"
                style="
                  margin-bottom: 0;
                  padding: 4px 8px;
                  width: 100px;
                  font-size: 0.85rem;
                "
              >
              </select>
              </select>
              <button
                class="btn-small btn-outline"
                onclick="resetPeriod()"
                style="padding: 4px 8px"
                title="ÂÖ®ÊúüÈñì„Å´„É™„Çª„ÉÉ„Éà"
              >
                ‚Ü∫
              </button>
            </div>
          </div>

          <div class="filter-title">üìà ÂàÜÊûê„Çø„Ç§„Éó</div>
          <div
            class="radio-group vertical-radio-group"
            id="analysisType"
            role="radiogroup"
          >
            <label class="radio-item active">
              <input type="radio" name="analysisType" value="overall" checked />
              ÂÖ®‰Ωì
            </label>
            <label class="radio-item">
              <input type="radio" name="analysisType" value="project" />
              „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂà•
            </label>
            <label class="radio-item">
              <input type="radio" name="analysisType" value="department" />
              ÈÉ®ÁΩ≤Âà•
            </label>
            <label class="radio-item">
              <input type="radio" name="analysisType" value="employee" />
              ÂæìÊ•≠Âì°Âà•
            </label>
            <label class="radio-item">
              <input type="radio" name="analysisType" value="monthly" />
              ÊúàÂà•Êé®Áßª
            </label>
          </div>
        </div>

        <div class="filter-group" id="projectFilters">
          <div class="filter-title">üìÅ „Éó„É≠„Ç∏„Çß„ÇØ„Éà</div>
          <input
            type="text"
            class="filter-search"
            id="projectSearch"
            placeholder="üîç Ê§úÁ¥¢..."
          />
          <div class="filter-actions">
            <button class="btn-small" onclick="selectAll('projects')">
              ÂÖ®ÈÅ∏Êäû
            </button>
            <button
              class="btn-small btn-outline"
              onclick="deselectAll('projects')"
            >
              ÂÖ®Ëß£Èô§
            </button>
            <select
              class="filter-sort-select"
              onchange="updateFilterSort('projects', this.value)"
            >
              <option value="name_asc">ÊòáÈ†Ü</option>
              <option value="name_desc">ÈôçÈ†Ü</option>
              <option value="selected">ÈÅ∏ÊäûÈ†Ü</option>
            </select>
          </div>
          <div class="filter-items" id="projectFilterItems"></div>
        </div>
        <div class="filter-group" id="departmentFilters">
          <div class="filter-title">üè¢ ÈÉ®ÁΩ≤</div>
          <input
            type="text"
            class="filter-search"
            id="departmentSearch"
            placeholder="üîç Ê§úÁ¥¢..."
          />
          <div class="filter-actions">
            <button class="btn-small" onclick="selectAll('departments')">
              ÂÖ®ÈÅ∏Êäû
            </button>
            <button
              class="btn-small btn-outline"
              onclick="deselectAll('departments')"
            >
              ÂÖ®Ëß£Èô§
            </button>
            <select
              class="filter-sort-select"
              onchange="updateFilterSort('departments', this.value)"
            >
              <option value="name_asc">ÊòáÈ†Ü</option>
              <option value="name_desc">ÈôçÈ†Ü</option>
              <option value="selected">ÈÅ∏ÊäûÈ†Ü</option>
            </select>
          </div>
          <div class="filter-items" id="departmentFilterItems"></div>
        </div>
        <div class="filter-group" id="employeeFilters">
          <div class="filter-title">üë§ ÂæìÊ•≠Âì°</div>
          <input
            type="text"
            class="filter-search"
            id="employeeSearch"
            placeholder="üîç Ê§úÁ¥¢..."
          />
          <div class="filter-actions">
            <button class="btn-small" onclick="selectAll('employees')">
              ÂÖ®ÈÅ∏Êäû
            </button>
            <button
              class="btn-small btn-outline"
              onclick="deselectAll('employees')"
            >
              ÂÖ®Ëß£Èô§
            </button>
            <select
              class="filter-sort-select"
              onchange="updateFilterSort('employees', this.value)"
            >
              <option value="name_asc">ÊòáÈ†Ü</option>
              <option value="name_desc">ÈôçÈ†Ü</option>
              <option value="selected">ÈÅ∏ÊäûÈ†Ü</option>
            </select>
          </div>
          <div class="filter-items" id="employeeFilterItems"></div>
        </div>
      </div>

      <!-- Favorites Section -->
      <div class="favorites-section hidden" id="favoritesSection">
        <div
          style="
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: space-between;
          "
        >
          <div style="display: flex; align-items: center; gap: 10px">
            <div style="font-weight: 600; color: var(--accent-purple)">
              ‚òÖ „ÅäÊ∞ó„Å´ÂÖ•„Çä
            </div>
          </div>

          <div style="display: flex; align-items: center; gap: 10px; flex: 1">
            <select
              id="savedFiltersSelect"
              class="filter-search"
              style="margin-bottom: 0; width: auto; flex: 1"
              onchange="applySavedFilter(this.value)"
            >
              <option value="">(Êù°‰ª∂„ÇíÈÅ∏Êäû)</option>
            </select>
            <button
              class="btn-icon-tiny"
              id="btnSaveFilter"
              onclick="saveCurrentFilter()"
              title="ÁèæÂú®„ÅÆÊù°‰ª∂„ÇíÊñ∞Ë¶è‰øùÂ≠ò"
              style="font-size: 1.5rem"
            >
              ‚ûï
            </button>
          </div>

          <div style="display: flex; gap: 8px">
            <button
              class="btn-icon"
              id="btnOverwriteFilter"
              onclick="overwriteCurrentFilter()"
              title="‰∏äÊõ∏„Åç‰øùÂ≠ò"
              disabled
            >
              üíæ
            </button>
            <button
              class="btn-icon"
              id="btnCopyFilter"
              onclick="copyCurrentFilter()"
              title="Ë§áË£Ω„Åó„Å¶‰øùÂ≠ò"
              disabled
            >
              üìë
            </button>
            <button
              class="btn-icon"
              id="btnRenameFilter"
              onclick="renameCurrentFilter()"
              title="ÂêçÂâç„ÇíÂ§âÊõ¥"
              disabled
            >
              ‚úèÔ∏è
            </button>
            <button
              class="btn-icon danger"
              id="btnDeleteFilter"
              onclick="deleteCurrentFilter()"
              title="ÂâäÈô§"
              disabled
            >
              üóëÔ∏è
            </button>
          </div>
        </div>
      </div>

      <!-- Summary Cards -->
       <!--
      <div class="summary-cards hidden" id="summaryCards">
        <div class="summary-card">
          <div class="summary-card-value planned" id="totalPlanned">0</div>
          <div class="summary-card-label">‰∫àÂÆöÊôÇÈñìÔºàÂêàË®àÔºâ</div>
        </div>
        <div class="summary-card">
          <div class="summary-card-value actual" id="totalActual">0</div>
          <div class="summary-card-label">ÂÆüÁ∏æÊôÇÈñìÔºàÂêàË®àÔºâ</div>
        </div>
        <div class="summary-card">
          <div class="summary-card-value" id="totalDiff">0</div>
          <div class="summary-card-label">Â∑ÆÁï∞ÔºàÂÆüÁ∏æ - ‰∫àÂÆöÔºâ</div>
        </div>
        <div class="summary-card">
          <div class="summary-card-value" id="totalRate">0%</div>
          <div class="summary-card-label">Âà∞ÈÅîÁéá</div>
        </div>
      </div>
    -->

      <!-- Chart Section -->
      <div class="chart-section hidden" id="chartSection">
        <div class="chart-container">
          <canvas id="chart" width="1100" height="350"></canvas>
        </div>
        <div class="chart-footer">
          <div class="legend">
            <div class="legend-item">
              <div class="legend-color planned"></div>
              <span>‰∫àÂÆöÊôÇÈñì</span>
            </div>
            <div class="legend-item">
              <div class="legend-color actual"></div>
              <span>ÂÆüÁ∏æÊôÇÈñì</span>
            </div>
          </div>

          <div class="chart-controls">
            <div class="chart-control-group">
              <span class="chart-control-label">„Ç∞„É©„Éï:</span>
              <div class="radio-group" id="chartType" role="radiogroup">
                <label class="radio-item active">
                  <input type="radio" name="chartType" value="bar" checked />
                  Ê£í
                </label>
                <label class="radio-item">
                  <input type="radio" name="chartType" value="line" />
                  Á∑ö
                </label>
              </div>
            </div>
            <div class="chart-control-group">
              <span class="chart-control-label">Âü∫Ê∫ñÁ∑ö:</span>
              <input id="yLineValue" type="number" step="0.1" placeholder="ÂÄ§" style="width:80px;padding:4px;border:1px solid var(--border-color);border-radius:4px;" />
              <label style="display:flex;align-items:center;gap:6px;margin-left:6px;">
                <input id="yLineToggle" type="checkbox" style="width:16px;height:16px;" /> Ë°®Á§∫
              </label>
            </div>
            <div class="chart-control-group">
              <span class="chart-control-label">Âçò‰Ωç:</span>
              <div class="radio-group" id="unitType" role="radiogroup">
                <label class="radio-item">
                  <input type="radio" name="unitType" value="hours" />
                  ÊôÇÈñì(h)
                </label>
                <label class="radio-item active">
                  <input type="radio" name="unitType" value="days" checked />
                  ‰∫∫Êó•
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Data Table -->
        <div class="table-container" id="dataTableContainer">
          <table class="data-table" id="dataTable">
            <thead>
              <tr>
                <th class="align-left" data-key="label">È†ÖÁõÆ</th>
                <th data-key="planned">‰∫àÂÆö</th>
                <th data-key="actual">ÂÆüÁ∏æ</th>
                <th data-key="diff">Â∑ÆÁï∞</th>
                <th data-key="rate">ÈÅîÊàêÁéá</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast" aria-live="polite" role="status"></div>

    <script>
      (function () {
        // ========================================
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        // ========================================
        let appData = {
          records: [],
          months: [],
          departments: [],
          projects: [],
          employees: [],
          savedFilters: [],
        };

        let filters = {
          projects: [],
          departments: [],
          employees: [],
          periodStart: "",
          periodEnd: "",
        };

        let isManHour = true; // „Éá„Éï„Ç©„É´„Éà‰∫∫Êó•

        let filterSorts = {
          projects: "selected",
          departments: "selected",
          employees: "selected",
        };

        function updateFilterSort(type, value) {
          filterSorts[type] = value;
          updateFiltersUI();
        }

        function getSortedItems(type) {
          let items = [...appData[type]]; // „ÇΩ„Éº„ÇπÈÖçÂàó„Çí„Ç≥„Éî„Éº
          const sortType = filterSorts[type];

          if (sortType === "selected") {
            // ÈÅ∏ÊäûÈ†Ü: ÈÅ∏ÊäûÊ∏à„Åø„Ç¢„Ç§„ÉÜ„É†„ÅØ filters[type] „ÅÆÈ†ÜÂ∫è„ÇíÂ∞äÈáç„Åó„Å¶ÂÖàÈ†≠„Å´‰∏¶„Åπ„ÄÅ
            // Êú™ÈÅ∏Êäû„ÅØÂêçÂâçÈ†Ü„ÅßÂæå„Å´‰∏¶„Åπ„Çã
            const selected = [];
            const remaining = new Set(items);
            // filters[type] „Å´„ÅÇ„ÇãÈ†Ü„Åß selected „Å´ËøΩÂä†ÔºàÂ≠òÂú®„Åô„ÇãÂ†¥Âêà„ÅÆ„ÅøÔºâ
            filters[type].forEach((v) => {
              if (remaining.has(v)) {
                selected.push(v);
                remaining.delete(v);
              }
            });
            // ÊÆã„Çä„ÅØÂêçÂâçÈ†Ü„Å´„ÇΩ„Éº„Éà„Åó„Å¶ËøΩÂä†
            const rest = Array.from(remaining).sort((a, b) => a.localeCompare(b, "ja"));
            items = selected.concat(rest);
          } else if (sortType === "name_desc") {
            items.sort((a, b) => b.localeCompare(a, "ja"));
          } else {
            items.sort((a, b) => a.localeCompare(b, "ja"));
          }
          return items;
        }

        const STORAGE_KEY = "crowdlog_data";

        // ========================================
        // ÂàùÊúüÂåñ
        // ========================================
        document.addEventListener("DOMContentLoaded", () => {
          initDropZone();
          initControlListeners();
          loadFromStorage();
        });

        // ========================================
        // „Éâ„É≠„ÉÉ„Éó„Çæ„Éº„É≥
        // ========================================
        function initDropZone() {
          // „Éï„Ç°„Ç§„É´ÂÖ•Âäõ„Å®„Ç´„Çπ„Çø„É†„Éú„Çø„É≥
          const fileInput = document.getElementById("fileInput");
          const btnSelect = document.getElementById("btnSelectFile");
          const dropZone = document.getElementById("dropZone");
          const fileControls = document.getElementById("fileControls");

          if (btnSelect && fileInput) {
            btnSelect.addEventListener("click", () => fileInput.click());
          }

          if (fileInput) {
            fileInput.addEventListener("change", (e) => {
              const file = e.target.files[0];
              if (file) processFile(file);
              setTimeout(alignDropZoneHeight, 50);
            });
          }

          // „Éâ„É©„ÉÉ„Ç∞ÔºÜ„Éâ„É≠„ÉÉ„Éó„ÇíÂæ©Ê¥ª
          function prevent(e) {
            e.preventDefault();
            e.stopPropagation();
          }

          function alignDropZoneHeight() {
            if (dropZone && fileControls) {
              dropZone.style.height = fileControls.offsetHeight + "px";
            }
          }
          // Â§ñÈÉ®„Åã„Çâ„ÇÇÂëº„Åπ„Çã„Çà„ÅÜ„Å´„Ç®„ÇØ„Çπ„Éù„Éº„Éà
          window.alignDropZoneHeight = alignDropZoneHeight;

          if (dropZone) {
            ["dragenter", "dragover"].forEach((ev) =>
              dropZone.addEventListener(ev, (e) => {
                prevent(e);
                dropZone.classList.add("dragover");
              })
            );

            ["dragleave", "drop"].forEach((ev) =>
              dropZone.addEventListener(ev, (e) => {
                prevent(e);
                dropZone.classList.remove("dragover");
                if (ev === "drop") {
                  const dt = e.dataTransfer;
                  const files = dt && dt.files ? dt.files : null;
                  if (files && files.length) {
                    processFile(files[0]);
                    setTimeout(alignDropZoneHeight, 50);
                  }
                }
              })
            );
          }

          // ÂàùÊúüÈÖçÁΩÆ„Å®„É™„Çµ„Ç§„Ç∫ÂØæÂøú
          alignDropZoneHeight();
          window.addEventListener("resize", alignDropZoneHeight);
        }

        // ========================================
        // „Éï„Ç°„Ç§„É´Âá¶ÁêÜ
        // ========================================
        function processFile(file) {
          if (!file.name.endsWith(".csv")) {
            showToast("CSV„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ", true);
            return;
          }

          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const arrayBuffer = e.target.result;
              const pref = 'auto';
              const decoded = decodeArrayBufferToText(arrayBuffer, pref);
              console.log('file encoding used:', decoded.encoding);
              const text = decoded.text;
              parseCSV(text);
              // CSVË™≠„ÅøËæº„ÅøÁõ¥Âæå„ÅØ„Éá„Éï„Ç©„É´„Éà„Åß„ÄåÈÅ∏ÊäûÈ†Ü„Äç„Çí‰ΩøÁî®„Åô„Çã
              filterSorts.projects = 'selected';
              filterSorts.departments = 'selected';
              filterSorts.employees = 'selected';
              // Ê∞∏Á∂öÂåñ
              try {
                appData.filterSorts = { ...filterSorts };
                saveToStorage();
              } catch (e) {
                console.warn('persist filterSorts failed', e);
              }
              // „Éï„Ç°„Ç§„É´Âêç„Åã„ÇâÊó•ÊôÇ„ÇíÊäΩÂá∫„Åó„Å¶‰øùÂ≠òÔºà„Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÊåÅ„Åô„Çã„Åü„ÇÅÂÖà„Å´„Çª„ÉÉ„ÉàÔºâ
              try {
                const dt = extractDatetimeFromFilename(file.name);
                if (dt) {
                  appData.fileTimestamp = dt;
                } else {
                  appData.fileTimestamp = null;
                }
                appData.lastFileName = file.name;
                appData.lastFileEncoding = decoded.encoding;
              } catch (err) {
                console.error('timestamp parse error', err);
              }
              saveToStorage();
              showUI();
              updateChart();
              showToast("„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü ‚úì");

              // „Éï„Ç°„Ç§„É´ÂêçË°®Á§∫
              const fileInfo = document.getElementById("fileInfo");
              fileInfo.textContent = `üìÑ ${file.name} (${decoded.encoding})`;
              fileInfo.classList.remove("hidden");

              // DOM „Å´Êó•ÊôÇ„ÇíË°®Á§∫ÔºàappData.fileTimestamp „Çí‰Ωø„ÅÜÔºâ
              const tsEl = document.getElementById("fileTimestamp");
              if (tsEl) {
                tsEl.textContent = appData.fileTimestamp
                  ? "CrowdLogÂá∫ÂäõÊó•ÊôÇ: " + appData.fileTimestamp
                  : "";
                tsEl.classList.remove("hidden");
              }
            } catch (error) {
              console.error(error);
              showToast("„Éï„Ç°„Ç§„É´„ÅÆËß£Êûê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: " + error.message, true);
            }
          };
          reader.readAsArrayBuffer(file);
        }

        // ========================================
        // CSV„Éë„Éº„Çπ
        // ========================================
        // CSV„Éë„Éº„ÇπÔºàÂºïÁî®Á¨¶ÂÜÖ„ÅÆ„Ç´„É≥„Éû„ÉªÊîπË°å„ÄÅ‰∫åÈáçÂºïÁî®Á¨¶ "" „ÇíËÄÉÊÖÆ„Åó„ÅüÂ†ÖÁâ¢ÁâàÔºâ
        function parseCSV(text) {
          const rows = parseCSVRows(text).filter((r) =>
            r.some((c) => c.trim() !== "")
          );
          if (rows.length < 2) {
            throw new Error("„Éá„Éº„Çø„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô");
          }

          const headers = rows[0].map((h) => (h || "").trim());
          console.log("Headers:", headers);

          // Âàó„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÇíÁâπÂÆöÔºàË§áÊï∞„ÅÆÂÄôË£úÂêç„Å´ÂØæÂøúÔºâ
          const colIndex = {
            employee: findColumnIndex(headers, [
              "Á§æÂì°Âêç",
              "ÊãÖÂΩìËÄÖÂêç",
              "ÂæìÊ•≠Âì°Âêç",
              "„É°„É≥„Éê„ÉºÂêç",
            ]),
            project: findColumnIndex(headers, [
              "„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç",
              "„Éó„É≠„Ç∏„Çß„ÇØ„Éà",
              "PJÂêç",
            ]),
            department: findColumnIndex(headers, [
              "ÈÉ®ÁΩ≤Âêç",
              "„É°„É≥„Éê„ÉºÈÉ®ÁΩ≤",
              "ÈÉ®ÁΩ≤",
              "ÊâÄÂ±û",
            ]),
            type: findColumnIndex(headers, [
              "„É°„É≥„Éê„ÉºÁ®ÆÈ°û",
              "‰∫àÂÆü„Éï„É©„Ç∞",
              "‰∫àÂÆü",
              "Á®ÆÈ°û",
              "Âå∫ÂàÜ",
            ]),
            unit: findColumnIndex(headers, ["Â∑•Êï∞Âçò‰Ωç", "Âçò‰Ωç", "unit"]),
            total: findColumnIndex(headers, ["ÂêàË®à", "Ë®à", "Total"]),
          };

          console.log("Column indices:", colIndex);

          // ÊúàÂàó„ÇíÁâπÂÆöÔºàÊó•‰ªòÂΩ¢Âºè„ÅÆ„Éò„ÉÉ„ÉÄ„ÉºÔºâ
          const monthColumns = [];
          headers.forEach((header, index) => {
            // YYYY/M/D „Åæ„Åü„ÅØ YYYY/MM/DD ÂΩ¢Âºè
            if (/^\d{4}\/\d{1,2}\/\d{1,2}$/.test(header.trim())) {
              monthColumns.push({ index, header: header.trim() });
            }
          });

          console.log("Month columns:", monthColumns);

          // ÊúàÊ¨°Âàó„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÄÅÂêàË®àÂàó„Çí‰ª£Êõø„Å®„Åó„Å¶‰Ωø„ÅÜÔºàÂ≠òÂú®„Åô„Çå„Å∞Ôºâ
          if (monthColumns.length === 0) {
            if (colIndex.total >= 0) {
              monthColumns.push({
                index: colIndex.total,
                header: headers[colIndex.total].trim(),
              });
            } else {
              throw new Error(
                "ÊúàÊ¨°„Éá„Éº„ÇøÂàó„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„ÇìÔºàÊó•‰ªòÂΩ¢Âºè: YYYY/M/DÔºâ„ÄÇÂêàË®àÂàó„ÇÇË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ"
              );
            }
          }

          // Êúà„É™„Çπ„Éà‰ΩúÊàêÔºàÈáçË§áÈô§Âéª„ÄÅYYYY/MMÂΩ¢Âºè„Å´Â§âÊèõÔºâ
          const monthSet = new Set();
          monthColumns.forEach((col) => {
            const parts = col.header.split("/");
            const monthKey = `${parts[0]}/${parts[1].padStart(2, "0")}`;
            monthSet.add(monthKey);
          });
          appData.months = Array.from(monthSet).sort();

          // „Éá„Éº„Çø„Çí„Éë„Éº„Çπ
          appData.records = [];
          const departmentSet = new Set();
          const projectSet = new Set();
          const employeeSet = new Set();
          for (let i = 1; i < rows.length; i++) {
            const values = rows[i];
            if (!values || values.length < 1) continue;

            // ÂêÑ„Éï„Ç£„Éº„É´„Éâ„ÇíÂèñÂæóÔºà-1„ÅÆÂ†¥Âêà„ÅØÁ©∫ÊñáÂ≠óÔºâ
            let employee =
              colIndex.employee >= 0
                ? (values[colIndex.employee] || "").trim()
                : "";
            let project =
              colIndex.project >= 0
                ? (values[colIndex.project] || "").trim()
                : "";
            let department =
              colIndex.department >= 0
                ? (values[colIndex.department] || "").trim()
                : "";
            let type =
              colIndex.type >= 0 ? (values[colIndex.type] || "").trim() : "";

            // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç„Åã„Çâ„Ç≥„Éº„ÉâÈÉ®ÂàÜ„ÇíÈô§Âéª
            // ‰æã: "103005-9 ÂêåÂπ¥‰∫ãÊ•≠" ‚Üí "ÂêåÂπ¥‰∫ãÊ•≠"„ÄÅ"P001 È°ßÂÆ¢ÁÆ°ÁêÜ" ‚Üí "È°ßÂÆ¢ÁÆ°ÁêÜ"
            project = removeCodePrefix(project);

            // ÈÉ®ÁΩ≤Âêç„Åã„Çâ„Ç≥„Éº„ÉâÈÉ®ÂàÜ„ÇíÈô§Âéª
            // ‰æã: "100001 „ÉÜ„Çπ„ÉàÈÉ®" ‚Üí "„ÉÜ„Çπ„ÉàÈÉ®"
            department = removeCodePrefix(department);

            // ‰∫àÂÆü„Çø„Ç§„Éó„ÇíÊ≠£Ë¶èÂåñÔºà‰∫àÁÆó‚Üí‰∫à„ÄÅÂÆüÁ∏æ‚ÜíÂÆüÔºâ
            let normalizedType = "";
            if (
              type.includes("‰∫àÁÆó") ||
              type === "‰∫à" ||
              type.includes("Ë®àÁîª") ||
              type.includes("Plan")
            ) {
              normalizedType = "‰∫à";
            } else if (
              type.includes("ÂÆüÁ∏æ") ||
              type === "ÂÆü" ||
              type.includes("Actual")
            ) {
              normalizedType = "ÂÆü";
            }

            // ÂøÖÈ†à„Éï„Ç£„Éº„É´„Éâ„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØÔºàÂæìÊ•≠Âì°„Å®‰∫àÂÆü„Çø„Ç§„Éó„ÅØÂøÖÈ†àÔºâ
            if (!employee || !normalizedType) {
              console.log(
                `Skipping row ${i}: employee="${employee}", type="${type}"`
              );
              continue;
            }

            // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Å®ÈÉ®ÁΩ≤„ÅåÁ©∫„ÅÆÂ†¥Âêà„ÅØ„Éá„Éï„Ç©„É´„ÉàÂÄ§
            if (!project) project = "(Êú™Ë®≠ÂÆö)";
            if (!department) department = "(Êú™Ë®≠ÂÆö)";

            departmentSet.add(department);
            projectSet.add(project);
            employeeSet.add(employee);

            // ÊúàÊ¨°„Éá„Éº„Çø„ÇíÂèéÈõÜ
            const monthlyData = {};
            // Ë°å„Åî„Å®„ÅÆÂçò‰ΩçÂà§ÂÆö
            // - CSVÂÜÖ„ÅÆÂçò‰Ωç„Åå„Äå‰∫∫Êó•„Äç„ÅÆÂ†¥Âêà„ÅØÊôÇÈñì„Å´ÊèõÁÆóÔºà* HOURS_PER_DAYÔºâ„Åó„Å¶ÂÜÖÈÉ®„ÅØÊôÇÈñì„Åß‰øùÊåÅ
            // - CSVÂÜÖ„ÅÆÂçò‰Ωç„Åå„Äå‰∫∫ÊôÇ„Äç„ÄåÊôÇÈñì„Äç„Äåh„ÄçÁ≠â„ÅÆÂ†¥Âêà„ÅØ„Åù„ÅÆ„Åæ„ÅæÊôÇÈñì„Å®„Åó„Å¶Êâ±„ÅÜ
            let multiplier = 1;
            if (colIndex.unit >= 0) {
              const unitVal = (values[colIndex.unit] || "").trim();
              if (/(‰∫∫Êó•|Êó•|\bdays?\b|\bd\b)/i.test(unitVal)) {
                multiplier = HOURS_PER_DAY;
              } else if (/(‰∫∫ÊôÇ|ÊôÇÈñì|h|hours?|hr\b)/i.test(unitVal)) {
                multiplier = 1;
              } else {
                // ‰∏çÊòé„Å™Âçò‰Ωç„ÅØ„Éá„Éï„Ç©„É´„Éà„ÅßÊôÇÈñìÊâ±„ÅÑÔºàÂÆâÂÖ®ÂÅ¥Ôºâ
                multiplier = 1;
              }
            }

            monthColumns.forEach((col) => {
              // „Éò„ÉÉ„ÉÄ„Éº„ÅåÊó•‰ªòÂΩ¢Âºè„Å™„Çâ YYYY/MM „Å´Êï¥ÂΩ¢„Åô„Çã„ÄÇÂêàË®àÂàóÁ≠â„ÅØ„Åù„ÅÆ„Åæ„Åæ„Éò„ÉÉ„ÉÄ„Éº„Çí‰Ωø„ÅÜ„ÄÇ
              const parts = col.header.split("/");
              const monthKey =
                parts.length >= 2
                  ? `${parts[0]}/${parts[1].padStart(2, "0")}`
                  : col.header.trim();
              const raw = parseFloat(values[col.index]);
              const value = (isNaN(raw) ? 0 : raw) * multiplier;
              if (!monthlyData[monthKey]) {
                monthlyData[monthKey] = 0;
              }
              monthlyData[monthKey] += value;
            });

            appData.records.push({
              department,
              project,
              employee,
              type: normalizedType,
              monthlyData,
            });
          }

          appData.departments = Array.from(departmentSet).sort();
          appData.projects = Array.from(projectSet).sort();
          appData.employees = Array.from(employeeSet).sort();

          console.log("Parsed records:", appData.records.length);
          console.log("Departments:", appData.departments);
          console.log("Projects:", appData.projects);
          console.log("Employees:", appData.employees);

          // „Éï„Ç£„É´„Çø„ÉºÂàùÊúüÂåñÔºàÂÖ®„Å¶Ëß£Èô§Ôºâ
          filters.projects = [];
          filters.departments = [];
          filters.employees = [];

          if (appData.records.length === 0) {
            throw new Error(
              "ÊúâÂäπ„Å™„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇÂàóÂêç„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ: Á§æÂì°Âêç/ÊãÖÂΩìËÄÖÂêç„ÄÅ„É°„É≥„Éê„ÉºÁ®ÆÈ°û/‰∫àÂÆü„Éï„É©„Ç∞Ôºà‰∫àÁÆó/ÂÆüÁ∏æ or ‰∫à/ÂÆüÔºâ"
            );
          }
        }

        // CSV„ÅÆÂÖ®„ÉÜ„Ç≠„Çπ„Éà„Åã„ÇâË°åÂçò‰Ωç„ÅÆÈÖçÂàóÔºàÈÖçÂàó„ÅÆÈÖçÂàóÔºâ„ÇíËøî„Åô
        function parseCSVRows(text) {
          const rows = [];
          let cur = [];
          let field = "";
          let inQuotes = false;

          for (let i = 0; i < text.length; i++) {
            const char = text[i];
            const next = text[i + 1];

            if (char === '"') {
              if (inQuotes && next === '"') {
                // „Ç®„Çπ„Ç±„Éº„Éó„Åï„Çå„Åü„ÉÄ„Éñ„É´„ÇØ„Ç©„Éº„Éà
                field += '"';
                i++; // 1ÊñáÂ≠óÈÄ≤„ÇÅ„Çã
              } else {
                inQuotes = !inQuotes;
              }
            } else if (char === "," && !inQuotes) {
              cur.push(field);
              field = "";
            } else if ((char === "\n" || char === "\r") && !inQuotes) {
              // ÊîπË°åÂá¶ÁêÜÔºàCRLFÂØæÂøúÔºâ
              if (char === "\r" && next === "\n") {
                // consume CRLF as single newline
                // advance i to skip \n in next loop
                // but outer loop will increment i, so increment once here
                i++;
              }
              cur.push(field);
              rows.push(cur);
              cur = [];
              field = "";
            } else {
              field += char;
            }
          }

          // ÊÆã„Çä„ÅÆ„Éï„Ç£„Éº„É´„Éâ/Ë°å„ÇíÁ¢∫ÂÆö
          if (inQuotes) {
            // ÁµÇÁ´Ø„ÅßÂºïÁî®Á¨¶„ÅåÈñâ„Åò„Çâ„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØË®±ÂÆπ„Åó„Å¶Âá¶ÁêÜ„ÇíÁ∂ö„Åë„Çã
            inQuotes = false;
          }
          if (field !== "" || cur.length > 0) {
            cur.push(field);
            rows.push(cur);
          }
          return rows;
        }

        // „Éï„Ç°„Ç§„É´Âêç„Åã„ÇâÊó•ÊôÇ„ÇíÊäΩÂá∫„Åô„Çã„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
        function extractDatetimeFromFilename(name) {
          if (!name) return null;
          const base = name.replace(/\.[^.]+$/, '');
          const patterns = [
            /(?<y>\d{4})(?<m>\d{2})(?<d>\d{2})[_-]?(?<h>\d{2})(?<min>\d{2})(?<s>\d{2})?/, // YYYYMMDD_HHMMSS
            /(?<y>\d{4})[-_.](?<m>\d{2})[-_.](?<d>\d{2})[ T](?<h>\d{2})[:.](?<min>\d{2})[:.](?<s>\d{2})/, // YYYY-MM-DD HH:MM:SS
            /(?<y>\d{4})[-_.](?<m>\d{2})[-_.](?<d>\d{2})/, // YYYY-MM-DD
            /(?<y>\d{4})(?<m>\d{2})(?<d>\d{2})/ // YYYYMMDD
          ];
          for (const p of patterns) {
            const m = base.match(p);
            if (m && m.groups && m.groups.y) {
              const y = m.groups.y;
              const mo = m.groups.m || '01';
              const d = m.groups.d || '01';
              const h = m.groups.h || '00';
              const min = m.groups.min || '00';
              const s = m.groups.s || '00';
              const iso = `${y}-${mo}-${d}T${h}:${min}:${s}`;
              const dt = new Date(iso);
              if (!isNaN(dt.getTime())) {
                return dt.toLocaleString();
              }
            }
          }
          return null;
        }

        // ArrayBuffer „ÇíÊñáÂ≠óÂàó„Å´Â§âÊèõÔºàËá™ÂãïÂà§ÂÆö or ÊåáÂÆöÔºâ„ÄÇÊàª„ÇäÂÄ§„ÅØ { text, encoding }
        function decodeArrayBufferToText(buffer, preferred = 'auto') {
          const bytes = new Uint8Array(buffer);

          const tryDecode = (enc) => {
            try {
              // ‰∏ÄÈÉ®„Éñ„É©„Ç¶„Ç∂„Åß„ÅØ 'shift_jis' „ÅÆ‰ª£„Çè„Çä„Å´ 'shift-jis' „ÇÑ 'windows-31j' „ÅåÂøÖË¶Å
              const dec = new TextDecoder(enc, { fatal: false });
              return dec.decode(bytes);
            } catch (e) {
              return null;
            }
          };

          // BOM Âà§ÂÆöÔºàUTF-8 BOMÔºâ
          if (bytes.length >= 3 && bytes[0] === 0xef && bytes[1] === 0xbb && bytes[2] === 0xbf) {
            const txt = tryDecode('utf-8');
            return { text: txt || '', encoding: 'UTF-8 (BOM)' };
          }

          if (preferred === 'utf-8') {
            const txt = tryDecode('utf-8') || '';
            return { text: txt, encoding: 'UTF-8' };
          }
          if (preferred === 'shift_jis') {
            const txt = tryDecode('shift_jis') || tryDecode('shift-jis') || tryDecode('windows-31j') || '';
            return { text: txt, encoding: 'Shift_JIS' };
          }

          // Ëá™ÂãïÂà§ÂÆö: „Åæ„Åö UTF-8 „ÇíË©¶„Åô„ÄÇÂ§±Êïó„ÇÑÁΩÆÊèõÊñáÂ≠ó„ÅåÂ§ö„Åë„Çå„Å∞ Shift_JIS „ÇíË©¶„Åô„ÄÇ
          let utf8 = tryDecode('utf-8') || '';
          const replacementCount = (utf8.match(/\uFFFD/g) || []).length;
          const threshold = Math.max(2, Math.floor(utf8.length * 0.01));
          if (replacementCount > threshold) {
            const sj = tryDecode('shift_jis') || tryDecode('shift-jis') || tryDecode('windows-31j');
            if (sj) return { text: sj, encoding: 'Shift_JIS (auto)' };
          }

          // ÁΩÆÊèõÊñáÂ≠ó„ÅåÂ∞ë„Å™„Åë„Çå„Å∞ UTF-8 „Çí‰Ωø„ÅÜ
          return { text: utf8, encoding: 'UTF-8 (auto)' };
        }

        // „Ç≥„Éº„Éâ„Éó„É¨„Éï„Ç£„ÉÉ„ÇØ„Çπ„ÇíÈô§Âéª„Åô„ÇãÈñ¢Êï∞
        // ‰æã: "103005-9 ÂêåÂπ¥‰∫ãÊ•≠" ‚Üí "ÂêåÂπ¥‰∫ãÊ•≠"
        // ‰æã: "100001 „ÉÜ„Çπ„ÉàÈÉ®" ‚Üí "„ÉÜ„Çπ„ÉàÈÉ®"
        // ‰æã: "P001 È°ßÂÆ¢ÁÆ°ÁêÜ" ‚Üí "È°ßÂÆ¢ÁÆ°ÁêÜ"
        function removeCodePrefix(text) {
          if (!text) return text;

          // „Éë„Çø„Éº„É≥: „ÄåÊï∞Â≠ó„ÇÑ„Ç¢„É´„Éï„Ç°„Éô„ÉÉ„Éà„ÄÅ„Éè„Ç§„Éï„É≥„ÅßÊßãÊàê„Åï„Çå„Çã„Ç≥„Éº„Éâ + „Çπ„Éö„Éº„Çπ + Êó•Êú¨Ë™ûÂêç„Äç
          // ‰æã: "103005-9 ÂêåÂπ¥‰∫ãÊ•≠", "100001 „ÉÜ„Çπ„ÉàÈÉ®", "P001 „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç"
          const match = text.match(/^[A-Za-z0-9\-_]+\s+(.+)$/);
          if (match) {
            return match[1].trim();
          }
          return text;
        }

        function findColumnIndex(
          headers,
          possibleNames,
          excludePatterns = ["„Ç≥„Éº„Éâ", "code", "Code", "ID"]
        ) {
          // „Åæ„Åö„ÄÅÈô§Â§ñ„Éë„Çø„Éº„É≥„Å´Ë©≤ÂΩì„Åó„Å™„ÅÑÂàó„ÅßÊ§úÁ¥¢
          for (let i = 0; i < headers.length; i++) {
            const header = headers[i].trim();
            // Èô§Â§ñ„Éë„Çø„Éº„É≥„Å´Ë©≤ÂΩì„Åô„ÇãÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„Éó
            if (excludePatterns.some((pattern) => header.includes(pattern))) {
              continue;
            }
            if (possibleNames.some((name) => header.includes(name))) {
              return i;
            }
          }

          // Ë¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅØÈô§Â§ñ„Éë„Çø„Éº„É≥„ÇíÁÑ°Ë¶ñ„Åó„Å¶ÂÜçÊ§úÁ¥¢
          for (let i = 0; i < headers.length; i++) {
            const header = headers[i].trim();
            if (possibleNames.some((name) => header.includes(name))) {
              return i;
            }
          }
          return -1;
        }

        // ========================================
        // ========================================
        // „Çπ„Éà„É¨„Éº„Ç∏‰øùÂ≠ò„ÉªË™≠„ÅøËæº„Åø
        // ========================================

        // ========================================
        // UIË°®Á§∫
        // ========================================
        function showUI() {
          const summaryCards = document.getElementById("summaryCards");
          if (summaryCards) {
            summaryCards.classList.remove("hidden");
          }
          document.getElementById("filterSection").classList.remove("hidden");
          document
            .getElementById("favoritesSection")
            .classList.remove("hidden");
          document.getElementById("chartSection").classList.remove("hidden");
          document.getElementById("btnClear").classList.remove("hidden");

          loadSavedFilters();
          updateFiltersUI();
          updatePeriodSelector();
          updateSummary();
        }

        /* Period/Reset handlers are defined later (more robust). Duplicate simple implementations removed. */

        function updateFiltersUI() {
          // „Éï„Ç£„É´„Çø„ÇΩ„Éº„ÉàÈÅ∏ÊäûËÇ¢„ÅÆË°®Á§∫„ÇíÁèæÂú®„ÅÆË®≠ÂÆö„Å´Âêà„Çè„Åõ„Çã
          try {
            const projSel = document.querySelector('#projectFilters .filter-sort-select');
            if (projSel) projSel.value = filterSorts.projects || 'name_asc';
            const deptSel = document.querySelector('#departmentFilters .filter-sort-select');
            if (deptSel) deptSel.value = filterSorts.departments || 'name_asc';
            const empSel = document.querySelector('#employeeFilters .filter-sort-select');
            if (empSel) empSel.value = filterSorts.employees || 'name_asc';
          } catch (e) {
            console.warn('updateFiltersUI: set select value failed', e);
          }
          // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éï„Ç£„É´„Çø„ÉºÔºàÂÆâÂÖ®„Å´DOM„ÅßÊßãÁØâÔºâ
          const projectItems = document.getElementById("projectFilterItems");
          projectItems.innerHTML = "";
          getSortedItems("projects").forEach((p) => {
            const label = document.createElement("label");
            label.className =
              "filter-chip" + (filters.projects.includes(p) ? " active" : "");
            label.setAttribute("data-value", p);

            const input = document.createElement("input");
            input.type = "checkbox";
            input.value = p;
            if (filters.projects.includes(p)) input.checked = true;

            // „É©„Éô„É´„ÇØ„É™„ÉÉ„ÇØ„ÅßÁ¢∫ÂÆü„Å´„Éà„Ç∞„É´„Åô„ÇãÔºàinput change „Å´‰æùÂ≠ò„Åó„Å™„ÅÑÔºâ
            label.addEventListener("click", (ev) => {
              ev.preventDefault();
              toggleFilter("projects", p);
            });

            label.appendChild(input);
            label.appendChild(document.createTextNode(p));
            projectItems.appendChild(label);
          });

          // ÈÉ®ÁΩ≤„Éï„Ç£„É´„Çø„ÉºÔºàÂÆâÂÖ®„Å´DOM„ÅßÊßãÁØâÔºâ
          const departmentItems = document.getElementById(
            "departmentFilterItems"
          );
          departmentItems.innerHTML = "";
          getSortedItems("departments").forEach((d) => {
            const label = document.createElement("label");
            label.className =
              "filter-chip" +
              (filters.departments.includes(d) ? " active" : "");
            label.setAttribute("data-value", d);

            const input = document.createElement("input");
            input.type = "checkbox";
            input.value = d;
            if (filters.departments.includes(d)) input.checked = true;

            label.addEventListener("click", (ev) => {
              ev.preventDefault();
              toggleFilter("departments", d);
            });

            label.appendChild(input);
            label.appendChild(document.createTextNode(d));
            departmentItems.appendChild(label);
          });

          // ÂæìÊ•≠Âì°„Éï„Ç£„É´„Çø„ÉºÔºàÂÆâÂÖ®„Å´DOM„ÅßÊßãÁØâÔºâ
          const employeeItems = document.getElementById("employeeFilterItems");
          employeeItems.innerHTML = "";
          getSortedItems("employees").forEach((e) => {
            const label = document.createElement("label");
            label.className =
              "filter-chip" + (filters.employees.includes(e) ? " active" : "");
            label.setAttribute("data-value", e);

            const input = document.createElement("input");
            input.type = "checkbox";
            input.value = e;
            if (filters.employees.includes(e)) input.checked = true;

            label.addEventListener("click", (ev) => {
              ev.preventDefault();
              toggleFilter("employees", e);
            });

            label.appendChild(input);
            label.appendChild(document.createTextNode(e));
            employeeItems.appendChild(label);
          });

          // Ê§úÁ¥¢Áä∂ÊÖã„ÇíÂæ©ÂÖÉÔºà„Åü„Å†„ÅóÊúÄÂàù„ÅÆÊõ¥Êñ∞ÊôÇ„ÅØÊ§úÁ¥¢„ÉÜ„Ç≠„Çπ„Éà„Çí‰øùÊåÅÔºâ
          const projectSearch = document.getElementById("projectSearch").value;
          if (projectSearch) filterItems("projects", projectSearch);

          const departmentSearch =
            document.getElementById("departmentSearch").value;
          if (departmentSearch) filterItems("departments", departmentSearch);

          const employeeSearch =
            document.getElementById("employeeSearch").value;
          if (employeeSearch) {
            filterItems("employees", employeeSearch);
          } else {
            // Ê§úÁ¥¢„ÉÜ„Ç≠„Çπ„Éà„ÅåÁ©∫„ÅÆÂ†¥Âêà„ÅØÂÖ®ÂæìÊ•≠Âì°„ÉÅ„ÉÉ„Éó„ÇíË°®Á§∫
            const allEmpChips = document
              .getElementById("employeeFilterItems")
              .querySelectorAll(".filter-chip");
            allEmpChips.forEach((chip) => {
              chip.style.display = "flex";
            });
          }
        }

        function filterItems(type, searchText) {
          const containerId =
            type === "projects"
              ? "projectFilterItems"
              : type === "departments"
              ? "departmentFilterItems"
              : "employeeFilterItems";
          const container = document.getElementById(containerId);
          const chips = container.querySelectorAll(".filter-chip");
          const lowerSearch = searchText.toLowerCase();
          chips.forEach((chip) => {
            const value = chip.getAttribute("data-value").toLowerCase();
            if (value.includes(lowerSearch)) {
              chip.style.display = "flex";
            } else {
              chip.style.display = "none";
            }
          });
        }

        function escapeHtml(text) {
          if (text == null) return "";
          return String(text)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/\"/g, "&quot;")
            .replace(/'/g, "&#39;");
        }

        function toggleFilter(type, value) {
          console.log(
            `toggleFilter called: type=${type}, value=${value}, before:`,
            JSON.parse(JSON.stringify(filters))
          );
          const index = filters[type].indexOf(value);
          if (index > -1) {
            // Ëß£Èô§Âá¶ÁêÜ
            if (type === "departments") {
              // ÈÉ®ÁΩ≤Ëß£Èô§ÊôÇ„ÅØ„ÄÅ„Åù„ÅÆÈÉ®ÁΩ≤„Å´Á¥ê„Å•„ÅèÂæìÊ•≠Âì°ÈÅ∏Êäû„ÇíËß£Èô§„Åô„Çã„Åå„ÄÅ
              // ‰ªñ„ÅÆÈÅ∏ÊäûÊ∏à„ÅøÈÉ®ÁΩ≤„Å´ÊâÄÂ±û„Åô„ÇãÂæìÊ•≠Âì°„ÅØÊÆã„Åô
              const departmentEmployees = appData.records
                .filter((r) => r.department === value)
                .map((r) => r.employee);
              const uniqueEmployees = [...new Set(departmentEmployees)];
              const otherSelectedDepts = filters.departments.filter(
                (d) => d !== value
              );
              uniqueEmployees.forEach((emp) => {
                const stillInOtherDept = appData.records.some(
                  (r) =>
                    r.employee === emp &&
                    otherSelectedDepts.includes(r.department)
                );
                if (!stillInOtherDept) {
                  const ei = filters.employees.indexOf(emp);
                  if (ei > -1) filters.employees.splice(ei, 1);
                }
              });
            }
            filters[type].splice(index, 1);
          } else {
            // ÈÅ∏ÊäûÂá¶ÁêÜ
            filters[type].push(value);

            // ÈÉ®ÁΩ≤ÈÅ∏ÊäûÊôÇ„Å´„ÄÅ„Åù„ÅÆÈÉ®ÁΩ≤„ÅÆÂæìÊ•≠Âì°„ÇíËá™ÂãïÈÅ∏Êäû
            if (type === "departments") {
              const departmentEmployees = appData.records
                .filter((r) => r.department === value)
                .map((r) => r.employee);
              const uniqueEmployees = [...new Set(departmentEmployees)];

              uniqueEmployees.forEach((emp) => {
                if (!filters.employees.includes(emp)) {
                  filters.employees.push(emp);
                }
              });
            }
          }
          console.log(
            `toggleFilter after:`,
            JSON.parse(JSON.stringify(filters))
          );
          updateFiltersUI();
          updateChart();
          persistCurrentFilters();
          updateSummary();
        }

        function selectAll(type) {
          filters[type] = [...appData[type]];
          updateFiltersUI();
          updateChart();
          updateSummary();
          persistCurrentFilters();
        }

        function deselectAll(type) {
          filters[type] = [];
          updateFiltersUI();
          updateChart();
          updateSummary();
          persistCurrentFilters();
        }

        // ========================================
        // „Ç≥„É≥„Éà„É≠„Éº„É´„É™„Çπ„Éä„Éº
        // ========================================
        function initControlListeners() {
          // ÂàÜÊûê„Çø„Ç§„Éó
          document
            .querySelectorAll('input[name="analysisType"]')
            .forEach((radio) => {
              radio.addEventListener("change", () => {
                updateRadioStyles("analysisType");
                updateChart();
              });
            });

          // „Ç∞„É©„ÉïÁ®ÆÈ°û
          document
            .querySelectorAll('input[name="chartType"]')
            .forEach((radio) => {
              radio.addEventListener("change", () => {
                updateRadioStyles("chartType");
                updateChart();
              });
            });

          // Âçò‰Ωç„Çø„Ç§„Éó
          document
            .querySelectorAll('input[name="unitType"]')
            .forEach((radio) => {
              radio.addEventListener("change", () => {
                updateRadioStyles("unitType");
                updateChart();
                updateSummary();
              });
            });

          // Ê§úÁ¥¢ÂÖ•Âäõ„ÅÆ„Éá„Éê„Ç¶„É≥„ÇπÂá¶ÁêÜÔºà„Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÂêë‰∏äÔºâ
          const debounce = (fn, wait) => {
            let t;
            return function (...args) {
              clearTimeout(t);
              t = setTimeout(() => fn.apply(this, args), wait);
            };
          };

          const projectSearch = document.getElementById("projectSearch");
          if (projectSearch)
            projectSearch.addEventListener(
              "input",
              debounce((e) => filterItems("projects", e.target.value), 250)
            );

          const departmentSearch = document.getElementById("departmentSearch");
          if (departmentSearch)
            departmentSearch.addEventListener(
              "input",
              debounce((e) => filterItems("departments", e.target.value), 250)
            );

          const employeeSearch = document.getElementById("employeeSearch");
          if (employeeSearch)
            employeeSearch.addEventListener(
              "input",
              debounce((e) => filterItems("employees", e.target.value), 250)
            );

          // Âü∫Ê∫ñÁ∑ö„Ç≥„É≥„Éà„É≠„Éº„É´: „ÉÅ„Çß„ÉÉ„ÇØ„Å®ÂÖ•ÂäõÂ§âÊõ¥„ÅßÂÜçÊèèÁîª
          const yLineToggle = document.getElementById("yLineToggle");
          const yLineInput = document.getElementById("yLineValue");
          if (yLineToggle) {
            yLineToggle.addEventListener("change", () => {
              updateChart();
            });
          }
          if (yLineInput) {
            yLineInput.addEventListener("input", debounce(() => updateChart(), 200));
            yLineInput.addEventListener("change", () => updateChart());
          }
        }

        function updateRadioStyles(groupId) {
          const container = document.getElementById(groupId);
          container.querySelectorAll(".radio-item").forEach((item) => {
            const input = item.querySelector("input");
            item.classList.toggle("active", input.checked);
          });
        }

        // ========================================
        // „Çµ„Éû„É™„ÉºÊõ¥Êñ∞
        // ========================================
        function updateSummary() {
          const filteredRecords = getFilteredRecords();

          let totalPlanned =  0;
          let totalActual = 0;

          filteredRecords.forEach((record) => {
            const total = sumMonthlyData(record.monthlyData);
            if (record.type === "‰∫à") {
              totalPlanned += total;
            } else if (record.type === "ÂÆü") {
              totalActual += total;
            }
          });

          const diff = totalActual - totalPlanned;
          const rate =
            totalPlanned > 0 ? (totalActual / totalPlanned) * 100 : 0;

          const unit = getUnitLabel();
          const displayPlanned = convertToDisplayUnit(totalPlanned);
          const displayActual = convertToDisplayUnit(totalActual);
          const displayDiff = convertToDisplayUnit(diff);

          const plannedEl = document.getElementById("totalPlanned");
          const actualEl = document.getElementById("totalActual");
          const diffEl = document.getElementById("totalDiff");
          const rateEl = document.getElementById("totalRate");

          if (plannedEl) {
            plannedEl.textContent = displayPlanned.toFixed(1) + unit;
          }
          if (actualEl) {
            actualEl.textContent = displayActual.toFixed(1) + unit;
          }
          if (diffEl) {
            diffEl.textContent =
              (displayDiff >= 0 ? "+" : "") + displayDiff.toFixed(1) + unit;
            diffEl.className =
              "summary-card-value " +
              (diff >= 0 ? "diff-positive" : "diff-negative");
          }
          if (rateEl) {
            rateEl.textContent = rate.toFixed(1) + "%";
            rateEl.className =
              "summary-card-value " +
              (rate >= 100 ? "diff-positive" : "diff-negative");
          }
        }

        // ========================================
        // „Éï„Ç£„É´„Çø„ÉºÊ∏à„Åø„É¨„Ç≥„Éº„ÉâÂèñÂæó
        // ========================================
        function getFilteredRecords() {
          // ÂÖ®„Éï„Ç£„É´„Çø„ÅåÁ©∫ÔºàÂÖ®Ëß£Èô§Ôºâ„ÅÆÂ†¥Âêà„ÅØ„ÄåË°®Á§∫„Å™„Åó„Äç„Å®„Åô„Çã
          if (
            (!filters.projects || filters.projects.length === 0) &&
            (!filters.departments || filters.departments.length === 0) &&
            (!filters.employees || filters.employees.length === 0)
          ) {
            return [];
          }

          // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÈÅ∏Êäû„ÅåÁ©∫„ÅÆÂ†¥Âêà„ÅØÂÖ®ÈÅ∏ÊäûÊâ±„ÅÑÔºà„ÉØ„Ç§„É´„Éâ„Ç´„Éº„ÉâÔºâ
          const projectSelected = filters.projects && filters.projects.length > 0;

          return appData.records.filter((record) => {
            const passProject =
              !projectSelected || filters.projects.includes(record.project);

            const deptSelected = filters.departments.length > 0;
            const empSelected = filters.employees.length > 0;

            // ÊåØ„ÇãËàû„ÅÑ:
            // - „Å©„Å°„Çâ„ÇÇÊú™ÈÅ∏Êäû => „ÉØ„Ç§„É´„Éâ„Ç´„Éº„ÉâÔºàtrueÔºâ
            // - ÁâáÊñπ„Å†„ÅëÈÅ∏Êäû => „Åù„ÅÆÈÅ∏Êäû„Åß„Éï„Ç£„É´„Çø
            // - ‰∏°ÊñπÈÅ∏Êäû => ÂæìÊ•≠Âì°ÈÅ∏Êäû„ÅßÁµû„ÇäËæº„ÇÄÔºàÈÉ®ÁΩ≤„Å®ÂæìÊ•≠Âì°„ÅÆANDÔºâ
            // „É≠„Ç∏„ÉÉ„ÇØ‰øÆÊ≠£:
            // - ÂæìÊ•≠Âì°„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„ÄÅ„Åù„ÅÆÂæìÊ•≠Âì°„ÇíÂÑ™ÂÖà„Åó„Å¶ÂèçÊò†„Åô„ÇãÔºàÈÉ®ÁΩ≤„ÅÆÈÅ∏Êäû„Å´Èñ¢„Çè„Çâ„ÅöÂê´„ÇÅ„ÇãÔºâ
            // - ÈÉ®ÁΩ≤„ÅÆ„ÅøÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÈÉ®ÁΩ≤„Åß„Éï„Ç£„É´„Çø
            // - „Å©„Å°„Çâ„ÇÇÊú™ÈÅ∏Êäû„ÅÆÂ†¥Âêà„ÅØ„ÉØ„Ç§„É´„Éâ„Ç´„Éº„Éâ
            let passDeptEmp = true;
            if (deptSelected && empSelected) {
              // ‰∏°ÊñπÈÅ∏ÊäûÊôÇ„ÅØ„ÄåÈÉ®ÁΩ≤„Å´Â±û„Åô„Çã„Äç„Åæ„Åü„ÅØ„ÄåÂæìÊ•≠Âì°„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Çã„Äç„Å©„Å°„Çâ„Åã„ÅßÈÄö„Åô
              passDeptEmp =
                filters.departments.includes(record.department) ||
                filters.employees.includes(record.employee);
            } else if (deptSelected) {
              passDeptEmp = filters.departments.includes(record.department);
            } else if (empSelected) {
              passDeptEmp = filters.employees.includes(record.employee);
            }

            return passProject && passDeptEmp;
          });
        }

        // ========================================
        // ÊúüÈñì„Éï„Ç£„É´„Çø„ÉºÂà∂Âæ°
        // ========================================
        function updatePeriodSelector() {
          const startSelect = document.getElementById("periodStart");
          const endSelect = document.getElementById("periodEnd");

          if (!startSelect || !endSelect) return;

          // ÈÅ∏ÊäûËÇ¢„ÅÆ„ÇØ„É™„Ç¢Ôºà‰øùÊåÅ„Åó„Å¶„ÅÑ„ÇãÂÄ§„Åå„ÅÇ„Çå„Å∞Ë¶ö„Åà„Å¶„Åä„ÅèÔºâ
          const currentStart = filters.periodStart;
          const currentEnd = filters.periodEnd;

          // „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ‰∏çË¶Å„ÅÆ„Åü„ÇÅÂàùÊúüÁ©∫„Å´„Åô„ÇãÔºàÂæå„ÅßÊúà„É™„Çπ„Éà„ÅßÂüã„ÇÅ„ÇãÔºâ
          startSelect.innerHTML = '';
          endSelect.innerHTML = '';

          const months = appData.months;

          months.forEach((month) => {
            const opt1 = document.createElement("option");
            opt1.value = month;
            opt1.textContent = month;
            startSelect.appendChild(opt1);

            const opt2 = document.createElement("option");
            opt2.value = month;
            opt2.textContent = month;
            endSelect.appendChild(opt2);
          });

          // Êú™Ë®≠ÂÆö„ÅÆÂ†¥Âêà„ÅØËá™ÂãïË®≠ÂÆöÔºàÂÖ®ÊúüÈñìÔºâ
          if (!filters.periodStart && months.length > 0) {
            filters.periodStart = months[0];
          }
          if (!filters.periodEnd && months.length > 0) {
            filters.periodEnd = months[months.length - 1];
          }

          // „Éó„É´„ÉÄ„Ç¶„É≥„Å´ÂèçÊò†
          startSelect.value = filters.periodStart;
          endSelect.value = filters.periodEnd;
        }

        function updatePeriodFilter() {
          const startSelect = document.getElementById("periodStart");
          const endSelect = document.getElementById("periodEnd");

          filters.periodStart = startSelect.value;
          filters.periodEnd = endSelect.value;

          console.log("updatePeriodFilter: periodStart=", filters.periodStart, "periodEnd=", filters.periodEnd);

          // ÈñãÂßãÊúà„Å®ÁµÇ‰∫ÜÊúà„ÅåÈÄÜËª¢„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÁµÇ‰∫ÜÊúà„ÇíÈñãÂßãÊúà„Å´Âêà„Çè„Åõ„Çã
          if (filters.periodStart && filters.periodEnd && filters.periodStart > filters.periodEnd) {
            filters.periodEnd = filters.periodStart;
            // UIÂèçÊò†
            endSelect.value = filters.periodEnd;
            showToast("ÈñãÂßãÊúà„ÅåÁµÇ‰∫ÜÊúà„Çà„ÇäÂæå„Åß„Åô„ÄÇÁµÇ‰∫ÜÊúà„ÇíÈñãÂßãÊúà„Å´Âêà„Çè„Åõ„Åæ„Åó„Åü„ÄÇ", false);
            console.log("period adjusted: periodEnd set to", filters.periodEnd);
          }

          // ÊúüÈñìÂ§âÊõ¥ÊôÇ
          updateChart();
          updateSummary();
        }

        function resetPeriod() {
          const months = appData.months;
          if (months.length > 0) {
            filters.periodStart = months[0];
            filters.periodEnd = months[months.length - 1];
            updatePeriodSelector(); // UI„Å´ÂèçÊò†
            updateChart();
            updateSummary();
          }
        }

        // ÊúüÈñì„Éï„Ç£„É´„Çø„Éº„ÇíÈÅ©Áî®„Åó„ÅüÊúà„É™„Çπ„Éà„ÇíÂèñÂæó
        function getFilteredMonths() {
          let months = [...appData.months];

          if (filters.periodStart) {
            months = months.filter((m) => m >= filters.periodStart);
          }
          if (filters.periodEnd) {
            months = months.filter((m) => m <= filters.periodEnd);
          }

          console.log("getFilteredMonths ->", months, "(filters)", filters.periodStart, filters.periodEnd);

          return months;
        }

        // ========================================
        // „ÉÜ„Éº„Éñ„É´„ÇΩ„Éº„ÉàÊ©üËÉΩ
        // ========================================
        let currentChartData = [];
        let tableSort = { key: null, order: "asc" };

        function sortTable(key) {
          if (tableSort.key === key) {
            if (tableSort.order === "asc") {
              tableSort.order = "desc";
            } else if (tableSort.order === "desc") {
              tableSort.key = null; // „ÇΩ„Éº„ÉàËß£Èô§
              tableSort.order = "asc";
            }
          } else {
            tableSort.key = key;
            tableSort.order = "asc";
          }

          // „Éá„Éº„Çø„ÅÆ„ÇΩ„Éº„Éà
          sortChartData(currentChartData);

          // „Ç∞„É©„ÉïÂÜçÊèèÁîª
          const chartType = document.querySelector(
            'input[name="chartType"]:checked'
          ).value;
          if (chartType === "bar") {
            drawBarChart(currentChartData);
          } else {
            drawLineChart(currentChartData);
          }

          // „ÉÜ„Éº„Éñ„É´ÂÜçÊèèÁîª
          drawTable(currentChartData);
        }

        // ========================================
        // Âçò‰ΩçÂ§âÊèõÁî®ÂÆöÊï∞„Å®Èñ¢Êï∞
        // ========================================
        const HOURS_PER_DAY = 7.5;

        function getUnitType() {
          const radio = document.querySelector(
            'input[name="unitType"]:checked'
          );
          return radio ? radio.value : "hours";
        }

        function convertToDisplayUnit(hours) {
          if (getUnitType() === "days") {
            return hours / HOURS_PER_DAY;
          }
          return hours;
        }

        function getUnitLabel() {
          return getUnitType() === "days" ? "‰∫∫Êó•" : "h";
        }

        // „Ç≠„É™„ÅÆËâØ„ÅÑÁõÆÁõõ„ÇäÈñìÈöî„ÇíË®àÁÆó
        function calculateNiceStep(max, targetTicks = 5) {
          if (max <= 0) return 10;

          // Â§ß„Åæ„Åã„Å™„Çπ„ÉÜ„ÉÉ„ÉóÂπÖ
          const roughStep = max / targetTicks;

          // Ê°ÅÊï∞„ÇíÊ±Ç„ÇÅ„Çã (‰æã: 85 -> 10, 120 -> 100)
          const power = Math.floor(Math.log10(roughStep));
          const magnitude = Math.pow(10, power);

          // Ê≠£Ë¶èÂåñ„Åï„Çå„Åü„Çπ„ÉÜ„ÉÉ„Éó (‰æã: 8.5, 1.2)
          const normalizedStep = roughStep / magnitude;

          let niceStep;
          if (normalizedStep <= 1) {
            niceStep = 1;
          } else if (normalizedStep <= 2) {
            niceStep = 2;
          } else if (normalizedStep <= 5) {
            niceStep = 5;
          } else {
            niceStep = 10;
          }

          return niceStep * magnitude;
        }

        // ÊúüÈñì„Éï„Ç£„É´„Çø„Éº„ÇíÈÅ©Áî®„Åó„Å¶ÊúàÊ¨°„Éá„Éº„Çø„ÇíÂêàË®à
        function sumMonthlyData(monthlyData) {
          const filteredMonths = getFilteredMonths();
          let total = 0;

          filteredMonths.forEach((month) => {
            // monthlyData „ÅÆ„Ç≠„Éº„Åå YYYY/MM ÂΩ¢Âºè„Åß„ÅÇ„Çã„Åì„Å®„ÇíÊÉ≥ÂÆö
            if (monthlyData[month]) {
              total += monthlyData[month];
            }
          });

          console.log("sumMonthlyData for record", monthlyData, "-> total=", total);

          return total;
        }

        // ========================================
        // „Ç∞„É©„ÉïÊèèÁîª
        // ========================================
        function updateChart() {
          const analysisType = document.querySelector(
            'input[name="analysisType"]:checked'
          ).value;
          const chartType = document.querySelector(
            'input[name="chartType"]:checked'
          ).value;
          const filteredRecords = getFilteredRecords();
          console.log("updateChart called", { analysisType, chartType, filters, filteredCount: filteredRecords.length });

          let chartData;
          switch (analysisType) {
            case "overall":
              chartData = aggregateOverall(filteredRecords);
              break;
            case "project":
              chartData = aggregateByKey(filteredRecords, "project");
              break;
            case "department":
              chartData = aggregateByKey(filteredRecords, "department");
              break;
            case "employee":
              chartData = aggregateByKey(filteredRecords, "employee");
              break;
            case "monthly":
              chartData = aggregateByMonth(filteredRecords);
              break;
          }

          // „ÇΩ„Éº„Éà
          console.log("chartData computed:", chartData);
          sortChartData(chartData);

          if (chartType === "bar") {
            console.log("calling drawBarChart with", chartData.length);
            drawBarChart(chartData);
          } else {
            console.log("calling drawLineChart with", chartData.length);
            drawLineChart(chartData);
          }

          // „ÉÜ„Éº„Éñ„É´ÊèèÁîª
          drawTable(chartData);
          console.log("updateChart finished");
        }

        function aggregateOverall(records) {
          let planned = 0;
          let actual = 0;

          records.forEach((record) => {
            const total = sumMonthlyData(record.monthlyData);
            if (record.type === "‰∫à") {
              planned += total;
            } else if (record.type === "ÂÆü") {
              actual += total;
            }
          });

          return [
            {
              label: "ÂÖ®‰Ωì",
              planned,
              actual,
            },
          ];
        }

        function aggregateByKey(records, key) {
          const grouped = {};
          const empDepts = {};

          records.forEach((record) => {
            const groupKey = record[key];

            if (key === "employee" && record.department) {
              empDepts[groupKey] = record.department;
            }

            if (!grouped[groupKey]) {
              grouped[groupKey] = { planned: 0, actual: 0 };
            }
            const total = sumMonthlyData(record.monthlyData);
            if (record.type === "‰∫à") {
              grouped[groupKey].planned += total;
            } else if (record.type === "ÂÆü") {
              grouped[groupKey].actual += total;
            }
          });

          return Object.entries(grouped).map(([label, data]) => {
            const item = {
              label,
              planned: data.planned,
              actual: data.actual,
            };
            if (key === "employee") {
              item.department = empDepts[label] || "-";
            }
            return item;
          });
        }

        function aggregateByMonth(records) {
          const filteredMonths = getFilteredMonths();
          const grouped = {};

          filteredMonths.forEach((month) => {
            grouped[month] = { planned: 0, actual: 0 };
          });

          records.forEach((record) => {
            Object.entries(record.monthlyData).forEach(([month, value]) => {
              if (grouped[month]) {
                if (record.type === "‰∫à") {
                  grouped[month].planned += value;
                } else if (record.type === "ÂÆü") {
                  grouped[month].actual += value;
                }
              }
            });
          });

          return Object.entries(grouped).map(([label, data]) => ({
            label,
            planned: data.planned,
            actual: data.actual,
          }));
        }

        // ========================================
        // „Éá„Éº„Çø„ÇΩ„Éº„ÉàÂá¶ÁêÜÔºà„Ç∞„É©„Éï„Éª„ÉÜ„Éº„Éñ„É´ÂÖ±ÈÄöÔºâ
        // ========================================
        function sortChartData(data) {
          if (!tableSort.key || !data) return;

          data.sort((a, b) => {
            let valA, valB;
            if (tableSort.key === "label") {
              valA = a.label;
              valB = b.label;
              return tableSort.order === "asc"
                ? valA.localeCompare(valB, "ja")
                : valB.localeCompare(valA, "ja");
            } else if (tableSort.key === "department") {
              valA = a.department || "";
              valB = b.department || "";
              return tableSort.order === "asc"
                ? valA.localeCompare(valB, "ja")
                : valB.localeCompare(valA, "ja");
            } else {
              const getVal = (item, k) => {
                if (k === "planned") return item.planned;
                if (k === "actual") return item.actual;
                if (k === "diff") return item.actual - item.planned;
                if (k === "rate")
                  return item.planned > 0
                    ? (item.actual / item.planned) * 100
                    : 0;
                return 0;
              };
              valA = getVal(a, tableSort.key);
              valB = getVal(b, tableSort.key);
              return tableSort.order === "asc" ? valA - valB : valB - valA;
            }
          });
        }

        // ========================================
        // „Éá„Éº„Çø„ÉÜ„Éº„Éñ„É´ÊèèÁîª
        // ========================================
        function drawTable(data) {
          // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞Êõ¥Êñ∞
          if (data) currentChartData = data;
          const targetData = currentChartData;
          const tbody = document.querySelector("#dataTable tbody");
          const container = document.getElementById("dataTableContainer");

          if (!targetData || targetData.length === 0) {
            container.style.display = "none";
            return;
          }
          container.style.display = "block";

          const unit = getUnitLabel();

          // ÂàÜÊûê„Çø„Ç§„ÉóÂèñÂæó
          const currentAnalysisType = document.querySelector(
            'input[name="analysisType"]:checked'
          ).value;
          const showDept = currentAnalysisType === "employee";

          let labelText = "È†ÖÁõÆ";
          if (currentAnalysisType === "project") labelText = "„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç";
          else if (currentAnalysisType === "department") labelText = "ÈÉ®ÁΩ≤Âêç";
          else if (currentAnalysisType === "employee") labelText = "Ê∞èÂêç";
          else if (currentAnalysisType === "monthly") labelText = "Âπ¥Êúà";

          // „Éá„Éº„ÇøÂ§âÊèõ„Å®„ÇΩ„Éº„ÉàÁî®„Éó„É≠„Éë„ÉÜ„Ç£ËøΩÂä†
          let processedData = targetData.map((item) => {
            const planned = convertToDisplayUnit(item.planned);
            const actual = convertToDisplayUnit(item.actual);
            const diff = actual - planned;
            const rate = planned > 0 ? (actual / planned) * 100 : 0;
            return {
              ...item,
              displayPlanned: planned,
              displayActual: actual,
              diff,
              rate,
            };
          });

          // „Éò„ÉÉ„ÉÄ„ÉºÂãïÁöÑÊõ¥Êñ∞
          const thead = document.querySelector("#dataTable thead");
          let headerHTML = `<tr><th class="align-left" data-key="label">${labelText}</th>`;
          if (showDept) {
            headerHTML +=
              '<th class="align-left" data-key="department">ÈÉ®ÁΩ≤</th>';
          }
          headerHTML +=
            '<th data-key="planned">‰∫àÂÆö</th><th data-key="actual">ÂÆüÁ∏æ</th><th data-key="diff">Â∑ÆÁï∞</th><th data-key="rate">Âà∞ÈÅîÁéá</th></tr>';
          thead.innerHTML = headerHTML;

          // „Éò„ÉÉ„ÉÄ„ÉºÊõ¥Êñ∞
          updateTableHeader();

          let totalPlanned = 0;
          let totalActual = 0;

          const rows = processedData
            .map((item) => {
              totalPlanned += item.displayPlanned;
              totalActual += item.displayActual;

              const safeLabel = escapeHtml(item.label);
              const deptCell = showDept
                ? `<td class="align-left">${escapeHtml(
                    item.department || "-"
                  )}</td>`
                : "";

              return `
                    <tr>
                        <td class="align-left">${safeLabel}</td>
                        ${deptCell}
                        <td>${item.displayPlanned.toFixed(1)}${unit}</td>
                        <td>${item.displayActual.toFixed(1)}${unit}</td>
                        <td style="color: ${
                          item.diff > 0
                            ? "#5c9476"
                            : item.diff < 0
                            ? "#ef4444"
                            : "inherit"
                        }">
                            ${item.diff > 0 ? "+" : ""}${item.diff.toFixed(
                1
              )}${unit}
                        </td>
                        <td>${item.rate.toFixed(1)}%</td>
                    </tr>
                `;
            })
            .join("");

          // ÂêàË®àË°å
          const totalDiff = totalActual - totalPlanned;
          const totalRate =
            totalPlanned > 0 ? (totalActual / totalPlanned) * 100 : 0;

          const totalRow = `
                <tr style="font-weight: bold; background-color: var(--bg-tertiary);">
                    <td class="align-left" colspan="${
                      showDept ? 2 : 1
                    }">ÂêàË®à</td>
                    <td>${totalPlanned.toFixed(1)}${unit}</td>
                    <td>${totalActual.toFixed(1)}${unit}</td>
                    <td style="color: ${
                      totalDiff > 0
                        ? "#5c9476"
                        : totalDiff < 0
                        ? "#ef4444"
                        : "inherit"
                    }">
                        ${totalDiff > 0 ? "+" : ""}${totalDiff.toFixed(
            1
          )}${unit}
                    </td>
                    <td>${totalRate.toFixed(1)}%</td>
                </tr>
            `;

          tbody.innerHTML = rows + totalRow;
        }

        function updateTableHeader() {
          const currentAnalysisType = document.querySelector(
            'input[name="analysisType"]:checked'
          ).value;
          let labelText = "È†ÖÁõÆ";
          if (currentAnalysisType === "project") labelText = "„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç";
          else if (currentAnalysisType === "department") labelText = "ÈÉ®ÁΩ≤Âêç";
          else if (currentAnalysisType === "employee") labelText = "Ê∞èÂêç";
          else if (currentAnalysisType === "monthly") labelText = "Âπ¥Êúà";

          const headers = document.querySelectorAll("#dataTable th");
          headers.forEach((th) => {
            const key = th.getAttribute("data-key");
            if (!key) return;

            th.onclick = () => sortTable(key);

            const textBase =
              key === "label"
                ? labelText
                : key === "department"
                ? "ÈÉ®ÁΩ≤"
                : key === "planned"
                ? "‰∫àÂÆö"
                : key === "actual"
                ? "ÂÆüÁ∏æ"
                : key === "diff"
                ? "Â∑ÆÁï∞"
                : "Âà∞ÈÅîÁéá";

            let iconChar = "‚ñ≤";
            let iconClass = "sort-icon";

            if (tableSort.key === key) {
              iconChar = tableSort.order === "asc" ? "‚ñ≤" : "‚ñº";
              iconClass += " active";
              th.style.backgroundColor = "#eef2f0";
            } else {
              th.style.backgroundColor = "";
            }

            th.innerHTML = `${textBase}<span class="${iconClass}">${iconChar}</span>`;
          });
        }

        // ========================================
        // Ê£í„Ç∞„É©„ÉïÊèèÁîª
        // ========================================
        function drawBarChart(data) {
          const canvas = document.getElementById("chart");

          // „Ç≠„É£„É≥„Éê„Çπ„Çµ„Ç§„Ç∫Ë™øÊï¥ÔºàÈ´òDPIÂØæÂøúÔºâ
          const containerWidth = canvas.parentElement.offsetWidth - 50;
          const cssWidth = Math.max(containerWidth, 600);
          const cssHeight = 350;
          const ratio = window.devicePixelRatio || 1;
          canvas.width = Math.round(cssWidth * ratio);
          canvas.height = Math.round(cssHeight * ratio);
          canvas.style.width = cssWidth + "px";
          canvas.style.height = cssHeight + "px";
          const ctx = canvas.getContext("2d");
          ctx.setTransform(ratio, 0, 0, ratio, 0, 0);

          const width = cssWidth;
          const height = cssHeight;
          let padding = { top: 40, right: 40, bottom: 120, left: 80 };
          let chartWidth = width - padding.left - padding.right;
          let chartHeight = height - padding.top - padding.bottom;

          // „ÇØ„É™„Ç¢
          ctx.clearRect(0, 0, width, height);

          if (data.length === 0) {
            ctx.fillStyle = "#a0a0b0";
            ctx.font = "16px sans-serif";
            ctx.textAlign = "center";
            ctx.fillText("Ë°®Á§∫„Åô„Çã„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì", width / 2, height / 2);
            return;
          }

          // Âçò‰ΩçÂ§âÊèõ„ÇíÈÅ©Áî®„Åó„Åü„Éá„Éº„Çø„Çí‰ΩúÊàê
          const displayData = data.map((d) => ({
            label: d.label,
            planned: convertToDisplayUnit(d.planned),
            actual: convertToDisplayUnit(d.actual),
          }));

          // Âçò‰ΩçÂèñÂæó
          const unit = getUnitLabel();

          // „Éá„Éº„Çø‰∏ä„ÅÆÊúÄÂ§ßÂÄ§
          const dataMax =
            Math.max(...displayData.flatMap((d) => [d.planned, d.actual])) || 0;

          // „Ç≠„É™„ÅÆËâØ„ÅÑ„Çπ„ÉÜ„ÉÉ„Éó„ÇíË®àÁÆó
          const step = calculateNiceStep(dataMax, 5);

          // „Çπ„ÉÜ„ÉÉ„Éó„ÅÆÂÄçÊï∞„Å´Âàá„Çä‰∏ä„ÅíÔºàÊúÄÂ§ßÂÄ§Ôºâ
          const maxValue = Math.ceil(dataMax / step) * step || step;

          // „Ç∞„É™„ÉÉ„ÉâÁ∑ö
          ctx.strokeStyle = "#d1d5db";
          ctx.lineWidth = 1;

          const gridLines = Math.round(maxValue / step);

          for (let i = 0; i <= gridLines; i++) {
            const value = step * i;
            const ratio = value / maxValue;
            const y = padding.top + chartHeight - chartHeight * ratio;

            ctx.beginPath();
            ctx.moveTo(padding.left, y);
            ctx.lineTo(width - padding.right, y);
            ctx.stroke();

            // YËª∏„É©„Éô„É´
            ctx.fillStyle = "#5a5a7a";
            ctx.font = "11px sans-serif";
            ctx.textAlign = "right";
            // Êï¥Êï∞„Å™„ÇâÂ∞ëÊï∞ÁÇπ„Å™„Åó„ÄÅÂ∞ëÊï∞„Å™„Çâ1Ê°Å
            const labelValue = Number.isInteger(step)
              ? value.toString()
              : value.toFixed(1);
            ctx.fillText(labelValue + unit, padding.left - 10, y + 4);
          }

          // ‰ªªÊÑè„ÅÆY„É©„Ç§„É≥ÊèèÁîª
          try {
            const yLineToggle = document.getElementById("yLineToggle");
            const yLineInput = document.getElementById("yLineValue");
            if (yLineToggle && yLineToggle.checked && yLineInput) {
              const yVal = parseFloat(yLineInput.value);
              if (!isNaN(yVal) && maxValue > 0) {
                const ratioVal = Math.max(0, Math.min(yVal / (maxValue || 1), 1));
                const y = padding.top + chartHeight - chartHeight * ratioVal;
                ctx.save();
                ctx.strokeStyle = "rgba(200,40,40,0.9)";
                ctx.lineWidth = 1.5;
                ctx.setLineDash([6, 4]);
                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(width - padding.right, y);
                ctx.stroke();
                ctx.setLineDash([]);
                // „É©„Éô„É´
                ctx.fillStyle = "rgba(200,40,40,0.95)";
                ctx.font = "12px sans-serif";
                ctx.textAlign = "right";
                ctx.fillText(yVal + getUnitLabel(), width - padding.right - 6, y - 6);
                ctx.restore();
              }
            }
          } catch (e) {
            console.warn("yLine draw error", e);
          }

          // Ê£í„Ç∞„É©„ÉïÊèèÁîª
          const groupWidth = chartWidth / displayData.length;
          const barWidth = Math.min(groupWidth * 0.35, 60);
          const gap = barWidth * 0.2;

          // „É©„Éô„É´„ÅÆÂõûËª¢Âà§ÂÆö
          ctx.font = "11px sans-serif";
          const maxLabelWidth = groupWidth - 10;
          const maxLabelPixel = Math.max(...displayData.map((d) => ctx.measureText(d.label).width));
          let rotateLabels = displayData.some(
            (d) => ctx.measureText(d.label).width > maxLabelWidth
          );

          // ÂõûËª¢„É©„Éô„É´„ÅÆÂ†¥Âêà„ÄÅÂ∑¶Á´Ø„ÅåÂàá„Çå„Å™„ÅÑ„Åì„Å®„Åå„ÅÇ„Çã„Åü„ÇÅÂ∑¶‰ΩôÁôΩ„ÇíÂ¢ó„ÇÑ„Åô
          if (rotateLabels && displayData.length > 0) {
            const angleCos = Math.cos(Math.PI / 6); // 30deg
            const requiredLeft = Math.ceil(maxLabelPixel * angleCos - groupWidth / 2 + 12);
            if (requiredLeft > padding.left) {
              padding.left = requiredLeft;
              chartWidth = width - padding.left - padding.right;
              // ÂÜçË®àÁÆó
              // groupWidth will be recomputed below after this block
            }
          }

          // ÂÜçË®àÁÆóÔºàpadding Â§âÊõ¥„Åå„ÅÇ„Çå„Å∞ÂèçÊò†Ôºâ
          const finalChartWidth = chartWidth;
          const finalChartHeight = chartHeight;
          const finalGroupWidth = finalChartWidth / displayData.length;
          // groupWidth/barWidth/gap „ÇíÊúÄÁµÇÂÄ§„ÅßÂÜçË®àÁÆó
          const groupWidthFinal = finalGroupWidth;
          const barWidthFinal = Math.min(groupWidthFinal * 0.35, 60);
          const gapFinal = barWidthFinal * 0.2;

          displayData.forEach((item, index) => {
            const x = padding.left + groupWidthFinal * index + groupWidthFinal / 2;

            // ‰∫àÂÆöÔºà‰ªäÂõû„ÅØ„Ç™„É¨„É≥„Ç∏Ôºâ
            const plannedHeight = (item.planned / maxValue) * chartHeight;
            const plannedGradient = ctx.createLinearGradient(
              0,
              padding.top + chartHeight - plannedHeight,
              0,
              padding.top + chartHeight
            );
            plannedGradient.addColorStop(0, "#f59e0b");
            plannedGradient.addColorStop(1, "#d97706");
            ctx.fillStyle = plannedGradient;
            ctx.fillRect(
              x - barWidthFinal - gapFinal / 2,
              padding.top + chartHeight - plannedHeight,
              barWidthFinal,
              plannedHeight
            );

            // ÂÆüÁ∏æÔºà‰ªäÂõû„ÅØÁ∑ëÔºâ
            const actualHeight = (item.actual / maxValue) * chartHeight;
            const actualGradient = ctx.createLinearGradient(
              0,
              padding.top + chartHeight - actualHeight,
              0,
              padding.top + chartHeight
            );
            actualGradient.addColorStop(0, "#5c9476");
            actualGradient.addColorStop(1, "#4a7a62");
            ctx.fillStyle = actualGradient;
            ctx.fillRect(
              x + gapFinal / 2,
              padding.top + chartHeight - actualHeight,
              barWidthFinal,
              actualHeight
            );

            // ÂÄ§„É©„Éô„É´
            ctx.fillStyle = "#2f3e35";
            ctx.font = "10px sans-serif";
            ctx.textAlign = "center";
            if (item.planned > 0) {
              ctx.fillText(
                item.planned.toFixed(1),
                x - barWidthFinal / 2 - gapFinal / 2,
                padding.top + chartHeight - plannedHeight - 5
              );
            }
            if (item.actual > 0) {
              ctx.fillText(
                item.actual.toFixed(1),
                x + barWidthFinal / 2 + gapFinal / 2,
                padding.top + chartHeight - actualHeight - 5
              );
            }

            // XËª∏„É©„Éô„É´
            ctx.fillStyle = "#5a5a7a";
            ctx.font = "11px sans-serif";

            const label = item.label;

            if (rotateLabels) {
              ctx.save();
              ctx.textAlign = "right";
              ctx.translate(x, padding.top + chartHeight + 10);
              ctx.rotate(-Math.PI / 6);
              ctx.fillText(
                label.substring(0, 15) + (label.length > 15 ? "..." : ""),
                0,
                0
              );
              ctx.restore();
            } else {
              ctx.textAlign = "center";
              ctx.fillText(label, x, padding.top + chartHeight + 20);
            }
          });
        }

        // ========================================
        // Êäò„ÇåÁ∑ö„Ç∞„É©„ÉïÊèèÁîª
        // ========================================
        function drawLineChart(data) {
          const canvas = document.getElementById("chart");
          // È´òDPIÂØæÂøú„Åß„Ç≠„É£„É≥„Éê„Çπ„ÇíË®≠ÂÆö
          const containerWidth = canvas.parentElement.offsetWidth - 50;
          const cssWidth = Math.max(containerWidth, 600);
          const cssHeight = 350;
          const ratio = window.devicePixelRatio || 1;
          canvas.width = Math.round(cssWidth * ratio);
          canvas.height = Math.round(cssHeight * ratio);
          canvas.style.width = cssWidth + "px";
          canvas.style.height = cssHeight + "px";
          const ctx = canvas.getContext("2d");
          ctx.setTransform(ratio, 0, 0, ratio, 0, 0);

          const width = cssWidth;
          const height = cssHeight;
          let padding = { top: 40, right: 40, bottom: 120, left: 80 };
          let chartWidth = width - padding.left - padding.right;
          let chartHeight = height - padding.top - padding.bottom;

          ctx.clearRect(0, 0, width, height);

          if (data.length === 0) {
            ctx.fillStyle = "#5a5a7a";
            ctx.font = "16px sans-serif";
            ctx.textAlign = "center";
            ctx.fillText("Ë°®Á§∫„Åô„Çã„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì", width / 2, height / 2);
            return;
          }

          // Âçò‰ΩçÂ§âÊèõ„ÇíÈÅ©Áî®„Åó„Åü„Éá„Éº„Çø„Çí‰ΩúÊàê
          const displayData = data.map((d) => ({
            label: d.label,
            planned: convertToDisplayUnit(d.planned),
            actual: convertToDisplayUnit(d.actual),
          }));

          // Âçò‰ΩçÂèñÂæó
          const unit = getUnitLabel();

          // „Éá„Éº„Çø‰∏ä„ÅÆÊúÄÂ§ßÂÄ§
          const dataMax =
            Math.max(...displayData.flatMap((d) => [d.planned, d.actual])) || 0;

          // „Ç≠„É™„ÅÆËâØ„ÅÑ„Çπ„ÉÜ„ÉÉ„Éó„ÇíË®àÁÆó
          const step = calculateNiceStep(dataMax, 5);

          // „Çπ„ÉÜ„ÉÉ„Éó„ÅÆÂÄçÊï∞„Å´Âàá„Çä‰∏ä„ÅíÔºàÊúÄÂ§ßÂÄ§Ôºâ
          const maxValue = Math.ceil(dataMax / step) * step || step;

          // „Ç∞„É™„ÉÉ„ÉâÁ∑ö
          ctx.strokeStyle = "#d1d5db";
          ctx.lineWidth = 1;

          const gridLines = Math.round(maxValue / step);

          for (let i = 0; i <= gridLines; i++) {
            const value = step * i;
            const ratio = value / maxValue;
            const y = padding.top + chartHeight - chartHeight * ratio;

            ctx.beginPath();
            ctx.moveTo(padding.left, y);
            ctx.lineTo(width - padding.right, y);
            ctx.stroke();

            ctx.fillStyle = "#5a5a7a";
            ctx.font = "11px sans-serif";
            ctx.textAlign = "right";
            const labelValue = Number.isInteger(step)
              ? value.toString()
              : value.toFixed(1);
            ctx.fillText(labelValue + unit, padding.left - 10, y + 4);
          }

          let stepX = chartWidth / (displayData.length - 1 || 1);

          // „É©„Éô„É´„ÅÆÂõûËª¢Âà§ÂÆö
          ctx.font = "11px sans-serif";
          const maxLabelWidth = Math.max(stepX - 10, 30);
          const maxLabelPixel = Math.max(...displayData.map((d) => ctx.measureText(d.label).width));
          let rotateLabels = displayData.some(
            (d) => ctx.measureText(d.label).width > maxLabelWidth
          );

          // ÂõûËª¢„É©„Éô„É´„ÅÆ„Å®„Åç„ÄÅÂ∑¶Á´Ø„ÅåÂàá„Çå„Å™„ÅÑ„Çà„ÅÜÂ∑¶‰ΩôÁôΩ„ÇíÁ¢∫‰øù
          if (rotateLabels && displayData.length > 0) {
            const angleCos = Math.cos(Math.PI / 6); // 30deg
            const requiredLeft = Math.ceil(maxLabelPixel * angleCos + 12);
            if (requiredLeft > padding.left) {
              padding.left = requiredLeft;
              chartWidth = width - padding.left - padding.right;
              chartHeight = height - padding.top - padding.bottom;
              stepX = chartWidth / (displayData.length - 1 || 1);
            }
          }

          // ‰∫àÂÆöÁ∑öÔºà„Ç™„É¨„É≥„Ç∏Ôºâ
          ctx.beginPath();
          ctx.strokeStyle = "#d97706";
          ctx.lineWidth = 3;
          displayData.forEach((item, index) => {
            const x = padding.left + stepX * index;
            const y =
              padding.top +
              chartHeight -
              (item.planned / maxValue) * chartHeight;
            if (index === 0) {
              ctx.moveTo(x, y);
            } else {
              ctx.lineTo(x, y);
            }
          });
          ctx.stroke();

          // ÂÆüÁ∏æÁ∑öÔºàÁ∑ëÔºâ
          ctx.beginPath();
          ctx.strokeStyle = "#5c9476";
          ctx.lineWidth = 3;
          displayData.forEach((item, index) => {
            const x = padding.left + stepX * index;
            const y =
              padding.top +
              chartHeight -
              (item.actual / maxValue) * chartHeight;
            if (index === 0) {
              ctx.moveTo(x, y);
            } else {
              ctx.lineTo(x, y);
            }
          });
          ctx.stroke();

          // „Éù„Ç§„É≥„Éà„Å®„É©„Éô„É´
          displayData.forEach((item, index) => {
            const x = padding.left + stepX * index;

            // ‰∫àÂÆö„Éù„Ç§„É≥„ÉàÔºà„Ç™„É¨„É≥„Ç∏Ôºâ
            const plannedY =
              padding.top +
              chartHeight -
              (item.planned / maxValue) * chartHeight;
            ctx.beginPath();
            ctx.fillStyle = "#d97706";
            ctx.arc(x, plannedY, 5, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = "#ffffff";
            ctx.beginPath();
            ctx.arc(x, plannedY, 2, 0, Math.PI * 2);
            ctx.fill();

            // ÂÆüÁ∏æ„Éù„Ç§„É≥„ÉàÔºàÁ∑ëÔºâ
            const actualY =
              padding.top +
              chartHeight -
              (item.actual / maxValue) * chartHeight;
            ctx.beginPath();
            ctx.fillStyle = "#5c9476";
            ctx.arc(x, actualY, 5, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = "#ffffff";
            ctx.beginPath();
            ctx.arc(x, actualY, 2, 0, Math.PI * 2);
            ctx.fill();

            // XËª∏„É©„Éô„É´
            ctx.fillStyle = "#5a5a7a";
            ctx.font = "11px sans-serif";

            const label = item.label;

            if (rotateLabels) {
              ctx.save();
              ctx.textAlign = "right";
              ctx.translate(x, padding.top + chartHeight + 10);
              ctx.rotate(-Math.PI / 6);
              ctx.fillText(
                label.substring(0, 15) + (label.length > 15 ? "..." : ""),
                0,
                0
              );
              ctx.restore();
            } else {
              ctx.textAlign = "center";
              ctx.fillText(label, x, padding.top + chartHeight + 20);
            }
          });

          // ‰ªªÊÑè„ÅÆY„É©„Ç§„É≥ÊèèÁîªÔºàÊäò„ÇåÁ∑ö„ÇÇÂêåÊßò„Å´Ë°®Á§∫Ôºâ
          try {
            const yLineToggle = document.getElementById("yLineToggle");
            const yLineInput = document.getElementById("yLineValue");
            if (yLineToggle && yLineToggle.checked && yLineInput) {
              const yVal = parseFloat(yLineInput.value);
              if (!isNaN(yVal) && maxValue > 0) {
                const ratioVal = Math.max(0, Math.min(yVal / (maxValue || 1), 1));
                const y = padding.top + chartHeight - chartHeight * ratioVal;
                ctx.save();
                ctx.strokeStyle = "rgba(200,40,40,0.9)";
                ctx.lineWidth = 1.5;
                ctx.setLineDash([6, 4]);
                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(width - padding.right, y);
                ctx.stroke();
                ctx.setLineDash([]);
                ctx.fillStyle = "rgba(200,40,40,0.95)";
                ctx.font = "12px sans-serif";
                ctx.textAlign = "right";
                ctx.fillText(yVal + getUnitLabel(), width - padding.right - 6, y - 6);
                ctx.restore();
              }
            }
          } catch (e) {
            console.warn("yLine draw error", e);
          }
        }

        // ========================================
        // „Çπ„Éà„É¨„Éº„Ç∏ÁÆ°ÁêÜ
        // ========================================
        function saveToStorage() {
          try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
          } catch (e) {
            console.error("‰øùÂ≠ò„Ç®„É©„Éº:", e);
          }
        }

        function persistCurrentFilters() {
          try {
            appData.currentFilters = {
              projects: [...filters.projects],
              departments: [...filters.departments],
              employees: [...filters.employees],
            };
            saveToStorage();
          } catch (e) {
            console.error("persistCurrentFilters error", e);
          }
        }

        function loadFromStorage() {
          try {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
              appData = JSON.parse(saved);
              // ÂæìÊù•„ÅØ„Åì„Åì„ÅßÂÖ®È†ÖÁõÆ„Åß filters „Çí‰∏äÊõ∏„Åç„Åó„Å¶„ÅÑ„Åü„Åå„ÄÅ
              // „Åù„Çå„Å†„Å®„É™„É≠„Éº„ÉâÊôÇ„Å´ÈÅ∏ÊäûÈ†Ü„ÇÑÈÅ∏ÊäûÁä∂ÊÖã„ÅåÂ§±„Çè„Çå„Çã„ÄÇ
              // „ÇÇ„Åó‰øùÂ≠ò„Åï„Çå„ÅüÁèæÂú®„ÅÆ„Éï„Ç£„É´„ÇøÈ†ÜÔºàappData.currentFiltersÔºâ„Åå„ÅÇ„Çå„Å∞„Åù„Çå„ÇíÂæ©ÂÖÉ„Åó„ÄÅ
              // „Å™„Åë„Çå„Å∞Êó¢Â≠ò„ÅÆ filters „ÇíÁ∂≠ÊåÅ„Åô„Çã„ÄÇ
              if (appData.currentFilters && typeof appData.currentFilters === "object") {
                filters.projects = Array.isArray(appData.currentFilters.projects)
                  ? [...appData.currentFilters.projects]
                  : [];
                filters.departments = Array.isArray(appData.currentFilters.departments)
                  ? [...appData.currentFilters.departments]
                  : [];
                filters.employees = Array.isArray(appData.currentFilters.employees)
                  ? [...appData.currentFilters.employees]
                  : [];
              }
              // ‰øùÂ≠ò„Åï„Çå„Åü„ÇΩ„Éº„ÉàË®≠ÂÆö„Åå„ÅÇ„Çå„Å∞Âæ©ÂÖÉ
              if (appData.filterSorts && typeof appData.filterSorts === 'object') {
                filterSorts.projects = appData.filterSorts.projects || filterSorts.projects;
                filterSorts.departments = appData.filterSorts.departments || filterSorts.departments;
                filterSorts.employees = appData.filterSorts.employees || filterSorts.employees;
              }
              // „Éï„Ç°„Ç§„É´Êó•ÊôÇ„ÇÑ„Éï„Ç°„Ç§„É´ÊÉÖÂ†±„Åå‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ DOM „Å´ÂèçÊò†
              try {
                const tsEl = document.getElementById("fileTimestamp");
                if (tsEl) {
                  tsEl.textContent = appData.fileTimestamp
                    ? "CrowdLogÂá∫ÂäõÊó•ÊôÇ: " + appData.fileTimestamp
                    : "";
                  if (appData.fileTimestamp) tsEl.classList.remove("hidden");
                }
                const fileInfo = document.getElementById("fileInfo");
                if (fileInfo && appData.lastFileName) {
                  const enc = appData.lastFileEncoding || "";
                  fileInfo.textContent = `üìÑ ${appData.lastFileName}${enc ? ' (' + enc + ')' : ''}`;
                  fileInfo.classList.remove("hidden");
                }
              } catch (e) {
                console.warn('restore file info error', e);
              }

              showUI();
              updateChart();
              showToast("‰øùÂ≠òÊ∏à„Åø„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü");
              // UIÂæ©ÂÖÉÂæå„Å´„Éâ„É≠„ÉÉ„Éó„Çæ„Éº„É≥„ÅÆÈ´ò„Åï„ÇíÂÜçË™øÊï¥
              setTimeout(() => {
                if (window.alignDropZoneHeight) window.alignDropZoneHeight();
              }, 60);
            }
          } catch (e) {
            console.error("Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:", e);
          }
        }

        function clearData() {
          if (confirm("„Éá„Éº„Çø„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åô„ÅãÔºü")) {
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
          }
        }

        // ========================================
        // „Éà„Éº„Çπ„ÉàÈÄöÁü•
        // ========================================
        function showToast(message, isError = false) {
          const toast = document.getElementById("toast");
          toast.textContent = message;
          toast.className = "toast" + (isError ? " error" : "");
          toast.classList.add("show");
          setTimeout(() => toast.classList.remove("show"), 3000);
        }

        // ========================================
        // „Ç¶„Ç£„É≥„Éâ„Ç¶„É™„Çµ„Ç§„Ç∫ÂØæÂøú
        // ========================================
        window.addEventListener("resize", () => {
          if (appData.records.length > 0) {
            updateChart();
          }
        });
        // ========================================
        // „ÅäÊ∞ó„Å´ÂÖ•„ÇäÊù°‰ª∂
        // ========================================
        appData.savedFilters = [];

        function loadSavedFilters() {
          const saved = localStorage.getItem("crowdlog_saved_filters");
          if (saved) {
            try {
              const parsed = JSON.parse(saved);
              if (Array.isArray(parsed)) {
                appData.savedFilters = parsed;
              } else {
                appData.savedFilters = [];
              }
            } catch (e) {
              console.error("JSON parse error", e);
              appData.savedFilters = [];
            }
          } else {
            appData.savedFilters = [];
          }
          updateSavedFiltersSelect();
        }

        function saveSavedFilters() {
          localStorage.setItem(
            "crowdlog_saved_filters",
            JSON.stringify(appData.savedFilters)
          );
          updateSavedFiltersSelect();
        }

        function updateSavedFiltersSelect() {
          const select = document.getElementById("savedFiltersSelect");
          if (!select) return;
          const currentVal = select.value;
          // ÂÆâÂÖ®„Å´„Ç™„Éó„Ç∑„Éß„É≥„ÇíÊßãÁØâ
          select.innerHTML = "";
          const defaultOpt = document.createElement("option");
          defaultOpt.value = "";
          defaultOpt.textContent = "(ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ)";
          select.appendChild(defaultOpt);
          appData.savedFilters.forEach((f) => {
            const opt = document.createElement("option");
            opt.value = f.id;
            opt.textContent = f.name;
            select.appendChild(opt);
          });

          if (appData.savedFilters.some((f) => f.id === currentVal)) {
            select.value = currentVal;
            enableFilterButtons(true);
          } else {
            select.value = "";
            enableFilterButtons(false);
          }
        }

        function enableFilterButtons(enabled) {
          const ids = [
            "btnOverwriteFilter",
            "btnCopyFilter",
            "btnRenameFilter",
            "btnDeleteFilter",
          ];
          ids.forEach((id) => {
            const el = document.getElementById(id);
            if (el) el.disabled = !enabled;
          });
        }

        function saveCurrentFilter() {
          const name = prompt("‰øùÂ≠ò„Åô„ÇãÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:", "ÁèæÂú®„ÅÆÊù°‰ª∂");
          if (!name) return;

          const newFilter = {
            id: Date.now().toString(),
            name: name,
            filters: {
              projects: [...filters.projects],
              departments: [...filters.departments],
              employees: [...filters.employees],
            },
          };
          appData.savedFilters.push(newFilter);
          saveSavedFilters();

          document.getElementById("savedFiltersSelect").value = newFilter.id;
          enableFilterButtons(true);
        }

        function overwriteCurrentFilter() {
          const select = document.getElementById("savedFiltersSelect");
          const id = select.value;
          if (!id || !confirm("ÁèæÂú®ÈÅ∏Êäû‰∏≠„ÅÆ„Éï„Ç£„É´„Çø„ÉºË®≠ÂÆö„Çí‰∏äÊõ∏„Åç„Åó„Åæ„Åô„ÅãÔºü"))
            return;

          const index = appData.savedFilters.findIndex((f) => f.id === id);
          if (index > -1) {
            appData.savedFilters[index].filters = {
              projects: [...filters.projects],
              departments: [...filters.departments],
              employees: [...filters.employees],
            };
            saveSavedFilters();
            select.value = id;
            alert("‰∏äÊõ∏„Åç‰øùÂ≠ò„Åó„Åæ„Åó„Åü„ÄÇ");
          }
        }

        function copyCurrentFilter() {
          const select = document.getElementById("savedFiltersSelect");
          const id = select.value;
          if (!id) return;

          const original = appData.savedFilters.find((f) => f.id === id);
          if (!original) return;

          const name = prompt(
            "Êñ∞„Åó„ÅÑÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:",
            original.name + " „ÅÆ„Ç≥„Éî„Éº"
          );
          if (!name) return;

          const newFilter = {
            id: Date.now().toString(),
            name: name,
            filters: JSON.parse(JSON.stringify(original.filters)),
          };
          appData.savedFilters.push(newFilter);
          saveSavedFilters();

          document.getElementById("savedFiltersSelect").value = newFilter.id;
          enableFilterButtons(true);
        }

        function renameCurrentFilter() {
          const select = document.getElementById("savedFiltersSelect");
          const id = select.value;
          if (!id) return;

          const target = appData.savedFilters.find((f) => f.id === id);
          if (!target) return;

          const name = prompt("Êñ∞„Åó„ÅÑÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:", target.name);
          if (!name) return;

          target.name = name;
          saveSavedFilters();
          select.value = id;
        }

        function deleteCurrentFilter() {
          const select = document.getElementById("savedFiltersSelect");
          const id = select.value;
          if (!id || !confirm("Êú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) return;

          appData.savedFilters = appData.savedFilters.filter(
            (f) => f.id !== id
          );
          saveSavedFilters();
        }

        function applySavedFilter(id) {
          if (!id) {
            enableFilterButtons(false);
            return;
          }
          const target = appData.savedFilters.find((f) => f.id === id);
          if (target) {
            filters.projects = [...target.filters.projects];
            filters.departments = [...target.filters.departments];
            filters.employees = [...target.filters.employees];
            updateFiltersUI();
            updateChart();
            enableFilterButtons(true);
            // ÈÅ∏ÊäûÈ†Ü„ÇíÁèæÂú®Áä∂ÊÖã„Å®„Åó„Å¶Ê∞∏Á∂öÂåñ
            persistCurrentFilters();
          }
        }
        // „Ç®„ÇØ„Çπ„Éù„Éº„Éà: „Ç§„É≥„É©„Ç§„É≥„Éè„É≥„Éâ„É©„ÇÑÂ§ñÈÉ®„Åã„ÇâÂøÖË¶Å„Å™Èñ¢Êï∞„ÅÆ„Åø„Ç∞„É≠„Éº„Éê„É´„Å´ÂÖ¨Èñã
        try {
          window.CrowdLog = {
            processFile,
            clearData,
            resetPeriod,
            selectAll,
            deselectAll,
            updateFilterSort,
            saveCurrentFilter,
            overwriteCurrentFilter,
            copyCurrentFilter,
            renameCurrentFilter,
            deleteCurrentFilter,
            applySavedFilter,
            loadSavedFilters,
            saveSavedFilters,
            saveToStorage,
            loadFromStorage,
            toggleFilter,
            updatePeriodFilter,
          };
          Object.assign(window, window.CrowdLog);
        } catch (e) {
          console.warn("Export failed", e);
        }
      })();
    </script>
  </body>
</html>
